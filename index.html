<!DOCTYPE html>

<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Raport Forjă – ALL_IN_ONE (Dashboard + HELPER + NUMERALKOD + INTRARI_OTEL + DEBITATE)</title>
<style>
    :root {
      --navbg: rgba(15, 23, 42, .92);
      --navborder: rgba(148,163,184,.22);
      --navtext: #e5e7eb;
      --navmuted: #94a3b8;
      --accent: #22c55e;
    }
    body{ margin:0; background:#0b1020; }
    .topnav{
      position:fixed; top:0; left:0; right:0; z-index:99999;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      background: var(--navbg);
      border-bottom:1px solid var(--navborder);
      backdrop-filter: blur(8px);
    }
    .brand{ color:var(--navtext); font: 800 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial; letter-spacing:.2px; }
    .right{ margin-left:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .hint{ color:var(--navmuted); font: 600 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .btn{
      border:1px solid var(--navborder);
      background: rgba(255,255,255,.06);
      color:var(--navtext);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font: 800 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .btn:hover{ border-color: rgba(34,197,94,.55); }
    .btn.active{
      border-color: rgba(34,197,94,.8);
      background: rgba(34,197,94,.14);
    }
    .stage{ padding-top: 56px; }
    iframe{ width:100%; height: calc(100vh - 56px); border:0; display:none; background:#fff; }
    iframe.show{ display:block; }
  </style>

<style>
  .authGate{
    position:fixed; inset:0; z-index:999999;
    display:flex; align-items:center; justify-content:center;
    background: radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.08), transparent 60%),
                radial-gradient(1200px 600px at 80% 30%, rgba(255,255,255,.06), transparent 55%),
                #070b16;
    color:#e9eefc;
    padding:24px;
  }
  .authCard{
    width:min(720px, 92vw);
    background:rgba(12,18,40,.72);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    padding:22px 22px 18px;
  }
  .authTitle{font-size:22px;font-weight:800;margin:0 0 6px}
  .authHint{margin:0 0 14px;color:rgba(233,238,252,.78);font-size:13px;line-height:1.35}
  .authRow{display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0}
  .authLabel{font-size:12px;color:rgba(233,238,252,.78);margin-bottom:6px}
  .authInput{
    width:100%;height:44px;border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#e9eefc;
    padding:0 14px; outline:none;
  }
  .authBtn{
    height:42px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(57,205,132,.28), rgba(57,205,132,.14));
    color:#e9eefc;font-weight:800;cursor:pointer;
    padding:0 16px;
  }
  .authBtn:disabled{opacity:.55;cursor:not-allowed}
  .authErr{margin-top:10px;color:#ffb4b4;font-weight:700;font-size:13px;min-height:18px}
  .rolePill{
    display:inline-flex;align-items:center;gap:8px;
    font-weight:800;font-size:12px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    margin-left:10px;
  }
  .roleDot{width:8px;height:8px;border-radius:999px;background:#39cd84}
  .roleDot.viewer{background:#f1c40f}
</style>

</head>
<body>
<script>
(function(){
  const KEY = "RF_HELPERS_v1";
  const seeded = {"version": 2, "seeded_from": "d9118a18-b15f-47f3-aa3d-adfd5c1394eb.xlsx", "seeded_at": "2026-02-23T08:23:43", "tacturi": [{"Cheie": "9K-6628|MP", "Reper": "9K-6628", "Utilaj": "MP", "Tact (sec)": 13}, {"Cheie": "9K-6629|MP", "Reper": "9K-6629", "Utilaj": "MP", "Tact (sec)": 13}, {"Cheie": "106-1625|3 T BR", "Reper": "106-1625", "Utilaj": "3 T BR", "Tact (sec)": 16}, {"Cheie": "106-1626|3 T BR", "Reper": "106-1626", "Utilaj": "3 T BR", "Tact (sec)": 16}, {"Cheie": "229-6909|MP", "Reper": "229-6909", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "229-6910|MP", "Reper": "229-6910", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "418-2091|2,5 T", "Reper": "418-2091", "Utilaj": "2,5 T", "Tact (sec)": 17}, {"Cheie": "418-2092|2,5 T", "Reper": "418-2092", "Utilaj": "2,5 T", "Tact (sec)": 17}, {"Cheie": "418-2092|3 T BR", "Reper": "418-2091", "Utilaj": "3 T BR", "Tact (sec)": 17}, {"Cheie": "418-2092|3 T BR", "Reper": "418-2092", "Utilaj": "3 T BR", "Tact (sec)": 17}, {"Cheie": "378-8241|2,5 T", "Reper": "378-8241", "Utilaj": "2,5 T", "Tact (sec)": 17}, {"Cheie": "378-8242|2,5 T", "Reper": "378-8242", "Utilaj": "2,5 T", "Tact (sec)": 17}, {"Cheie": "378-8241|3 T BR", "Reper": "378-8241", "Utilaj": "3 T BR", "Tact (sec)": 17}, {"Cheie": "378-8242|3 T BR", "Reper": "378-8242", "Utilaj": "3 T BR", "Tact (sec)": 17}, {"Cheie": "248-2307|2,5 T", "Reper": "248-2307", "Utilaj": "2,5 T", "Tact (sec)": 17}, {"Cheie": "248-2308|2,5 T", "Reper": "248-2308", "Utilaj": "2,5 T", "Tact (sec)": 17}, {"Cheie": "248-2307|3 T BR", "Reper": "248-2307", "Utilaj": "3 T BR", "Tact (sec)": 17}, {"Cheie": "248-2308|3 T BR", "Reper": "248-2308", "Utilaj": "3 T BR", "Tact (sec)": 17}, {"Cheie": "503-0761|3 T BR", "Reper": "503-0761", "Utilaj": "3 T BR", "Tact (sec)": 23}, {"Cheie": "503-0762|3 T BR", "Reper": "503-0762", "Utilaj": "3 T BR", "Tact (sec)": 23}, {"Cheie": "6I-8077|3 T BR", "Reper": "6I-8077", "Utilaj": "3 T BR", "Tact (sec)": 55}, {"Cheie": "6I-8077|5 T CHINA", "Reper": "6I-8077", "Utilaj": "5 T CHINA", "Tact (sec)": 55}, {"Cheie": "526-9280|5 T CHINA", "Reper": "526-9280", "Utilaj": "5 T CHINA", "Tact (sec)": 55}, {"Cheie": "526-9278|5 T CHINA", "Reper": "526-9278", "Utilaj": "5 T CHINA", "Tact (sec)": 65}, {"Cheie": "349-1248|5 T CHINA", "Reper": "349-1248", "Utilaj": "5 T CHINA", "Tact (sec)": 130}, {"Cheie": "393-2648|5 T CHINA", "Reper": "393-2648", "Utilaj": "5 T CHINA", "Tact (sec)": 90}, {"Cheie": "393-2655|5 T CHINA", "Reper": "393-2655", "Utilaj": "5 T CHINA", "Tact (sec)": 90}, {"Cheie": "369-3318|5 T CHINA", "Reper": "369-3318", "Utilaj": "5 T CHINA", "Tact (sec)": 95}, {"Cheie": "AU1CZ01A|MP", "Reper": "AU1CZ01A", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "BF27K01A|MP", "Reper": "BF27K01A", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "AT-355|MP", "Reper": "AT-355", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "B87K501A|MP", "Reper": "B87K501A", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "BF5C001A|MP", "Reper": "BF5C001A", "Utilaj": "MP", "Tact (sec)": 17}, {"Cheie": "BF32C01A|MP", "Reper": "BF32C01A", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "BF58101A|MP", "Reper": "BF58101A", "Utilaj": "MP", "Tact (sec)": 17}, {"Cheie": "ASOLLO_M|MP", "Reper": "ASOLLO_M", "Utilaj": "MP", "Tact (sec)": 19}, {"Cheie": "BF3E301A|MP", "Reper": "BF3E301A", "Utilaj": "MP", "Tact (sec)": 19}, {"Cheie": "457-4062|5 T CHINA", "Reper": "457-4062", "Utilaj": "5 T CHINA", "Tact (sec)": 60}, {"Cheie": "376-2256|5 T CHINA", "Reper": "376-2256", "Utilaj": "5 T CHINA", "Tact (sec)": 60}, {"Cheie": "372-7089|5 T CHINA", "Reper": "372-7089", "Utilaj": "5 T CHINA", "Tact (sec)": 60}, {"Cheie": "511-3101|5 T CHINA", "Reper": "511-3101", "Utilaj": "5 T CHINA", "Tact (sec)": 60}, {"Cheie": "SK-304234|5 T CHINA", "Reper": "SK-304234", "Utilaj": "5 T CHINA", "Tact (sec)": 120}, {"Cheie": "SK-005-0-65-36-007-1|5 T CHINA", "Reper": "SK-005-0-65-36-007-1", "Utilaj": "5 T CHINA", "Tact (sec)": 85}, {"Cheie": "SK-203034|5 T CHINA", "Reper": "SK-203034", "Utilaj": "5 T CHINA", "Tact (sec)": 95}, {"Cheie": "453-1011|5 T CHINA", "Reper": "453-1011", "Utilaj": "5 T CHINA", "Tact (sec)": 60}, {"Cheie": "386-5286|5 T CHINA", "Reper": "386-5286", "Utilaj": "5 T CHINA", "Tact (sec)": 90}, {"Cheie": "478-7541|5 T CHINA", "Reper": "478-7541", "Utilaj": "5 T CHINA", "Tact (sec)": 60}, {"Cheie": "493-4858|5 T CHINA", "Reper": "493-4858", "Utilaj": "5 T CHINA", "Tact (sec)": 75}, {"Cheie": "101-9234|5 T CHINA", "Reper": "101-9234", "Utilaj": "5 T CHINA", "Tact (sec)": 75}, {"Cheie": "500-1804|5 T CHINA", "Reper": "500-1804", "Utilaj": "5 T CHINA", "Tact (sec)": 65}, {"Cheie": "9T-6035|5 T CHINA", "Reper": "9T-6035", "Utilaj": "5 T CHINA", "Tact (sec)": 65}, {"Cheie": "382-3760|5 T CHINA", "Reper": "382-3760", "Utilaj": "5 T CHINA", "Tact (sec)": 70}, {"Cheie": "376-3091|5 T CHINA", "Reper": "376-3091", "Utilaj": "5 T CHINA", "Tact (sec)": 72}, {"Cheie": "324-6849|5 T CHINA", "Reper": "324-6849", "Utilaj": "5 T CHINA", "Tact (sec)": 60}, {"Cheie": "AX-150-1670|5 T CHINA", "Reper": "AX-150-1670", "Utilaj": "5 T CHINA", "Tact (sec)": 175}, {"Cheie": "AX-368-5844|5 T CHINA", "Reper": "AX-368-5844", "Utilaj": "5 T CHINA", "Tact (sec)": 165}, {"Cheie": "505-8995|5 T CHINA", "Reper": "505-8995", "Utilaj": "5 T CHINA", "Tact (sec)": 100}, {"Cheie": "9P-9664/65|1,25 T", "Reper": "9P-9664/65", "Utilaj": "1,25 T", "Tact (sec)": 22}, {"Cheie": "7G-0521/22|1,25 T", "Reper": "7G-0521/22", "Utilaj": "1,25 T", "Tact (sec)": 13}, {"Cheie": "358-5253/55|1,25 T", "Reper": "358-5253/55", "Utilaj": "1,25 T", "Tact (sec)": 20}, {"Cheie": "SKU-140|MP", "Reper": "SKU-140", "Utilaj": "MP", "Tact (sec)": 30}, {"Cheie": "433-4374|5 T CHINA", "Reper": "433-4374", "Utilaj": "5 T CHINA", "Tact (sec)": 130}, {"Cheie": "612-8292|5 T CHINA", "Reper": "612-8292", "Utilaj": "5 T CHINA", "Tact (sec)": 90}, {"Cheie": "417-3595|MP", "Reper": "417-3595", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "417-3596|MP", "Reper": "417-3596", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "106-1625|MP", "Reper": "106-1625", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "106-1626|MP", "Reper": "106-1626", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "106-1625_MP|MP", "Reper": "106-1625_MP", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "106-1626_MP|MP", "Reper": "106-1626_MP", "Utilaj": "MP", "Tact (sec)": 15}, {"Cheie": "106-1625|2,5 T", "Reper": "106-1625", "Utilaj": "2,5 T", "Tact (sec)": 16}, {"Cheie": "106-1626|2,5 T", "Reper": "106-1626", "Utilaj": "2,5 T", "Tact (sec)": 16}, {"Cheie": "7G-0521/22|MP", "Reper": "7G-0521/22", "Utilaj": "MP", "Tact (sec)": 13}], "repere_forjate": [{"REPER_FORJAT": "9K-6628", "REPER_DEBITARE_ORIGINE": "9K-6628/29", "DIMENSIUNE_OTEL": 53, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 3.77}, {"REPER_FORJAT": "9K-6629", "REPER_DEBITARE_ORIGINE": "9K-6628/29", "DIMENSIUNE_OTEL": 53, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 3.77}, {"REPER_FORJAT": "106-1625", "REPER_DEBITARE_ORIGINE": "106-1625/26", "DIMENSIUNE_OTEL": 65, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 6.65}, {"REPER_FORJAT": "106-1626", "REPER_DEBITARE_ORIGINE": "106-1625/26", "DIMENSIUNE_OTEL": 65, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 6.65}, {"REPER_FORJAT": "229-6909", "REPER_DEBITARE_ORIGINE": "229-6909/10", "DIMENSIUNE_OTEL": 63, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 6.145}, {"REPER_FORJAT": "229-6910", "REPER_DEBITARE_ORIGINE": "229-6909/10", "DIMENSIUNE_OTEL": 63, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 6.145}, {"REPER_FORJAT": "378-8241", "REPER_DEBITARE_ORIGINE": "248-2307/08", "DIMENSIUNE_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 8.5}, {"REPER_FORJAT": "378-8242", "REPER_DEBITARE_ORIGINE": "248-2307/08", "DIMENSIUNE_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 8.5}, {"REPER_FORJAT": "248-2307", "REPER_DEBITARE_ORIGINE": "248-2307/08", "DIMENSIUNE_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 8.5}, {"REPER_FORJAT": "248-2308", "REPER_DEBITARE_ORIGINE": "248-2307/08", "DIMENSIUNE_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 8.5}, {"REPER_FORJAT": "503-0761", "REPER_DEBITARE_ORIGINE": "503-0761/62", "DIMENSIUNE_OTEL": 80, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 10.96}, {"REPER_FORJAT": "503-0762", "REPER_DEBITARE_ORIGINE": "503-0761/62", "DIMENSIUNE_OTEL": 80, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 10.96}, {"REPER_FORJAT": "6I-8077", "REPER_DEBITARE_ORIGINE": "6I-8077", "DIMENSIUNE_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 13.3}, {"REPER_FORJAT": "526-9280", "REPER_DEBITARE_ORIGINE": "526-9280", "DIMENSIUNE_OTEL": 110, "CALITATE_OTEL": "1E1239G", "KG_BUC_FORJAT": 22.6}, {"REPER_FORJAT": "526-9278", "REPER_DEBITARE_ORIGINE": "526-9278", "DIMENSIUNE_OTEL": 110, "CALITATE_OTEL": "1E1239G", "KG_BUC_FORJAT": 27.6}, {"REPER_FORJAT": "349-1248", "REPER_DEBITARE_ORIGINE": "349-1248", "DIMENSIUNE_OTEL": 145, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_FORJAT": null}, {"REPER_FORJAT": "393-2648", "REPER_DEBITARE_ORIGINE": "393-2648", "DIMENSIUNE_OTEL": 145, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_FORJAT": 26}, {"REPER_FORJAT": "393-2655", "REPER_DEBITARE_ORIGINE": "393-2655", "DIMENSIUNE_OTEL": 145, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_FORJAT": 26}, {"REPER_FORJAT": "369-3318", "REPER_DEBITARE_ORIGINE": "369-3318", "DIMENSIUNE_OTEL": 145, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_FORJAT": 31}, {"REPER_FORJAT": "AU1CZ01A", "REPER_DEBITARE_ORIGINE": "AU1CZ01A", "DIMENSIUNE_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_FORJAT": 3.15}, {"REPER_FORJAT": "BF27K01A", "REPER_DEBITARE_ORIGINE": "BF27K01A", "DIMENSIUNE_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_FORJAT": 3.15}, {"REPER_FORJAT": "AT-355", "REPER_DEBITARE_ORIGINE": "AT-355", "DIMENSIUNE_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_FORJAT": 3.15}, {"REPER_FORJAT": "B87K501A", "REPER_DEBITARE_ORIGINE": "B87K501A", "DIMENSIUNE_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_FORJAT": 2.775}, {"REPER_FORJAT": "BF5C001A", "REPER_DEBITARE_ORIGINE": "BF5C001A", "DIMENSIUNE_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_FORJAT": 4.15}, {"REPER_FORJAT": "BF32C01A", "REPER_DEBITARE_ORIGINE": "BF32C01A", "DIMENSIUNE_OTEL": 55, "CALITATE_OTEL": "C45", "KG_BUC_FORJAT": 3.315}, {"REPER_FORJAT": "BF58101A", "REPER_DEBITARE_ORIGINE": "BF58101A", "DIMENSIUNE_OTEL": 55, "CALITATE_OTEL": "C45", "KG_BUC_FORJAT": 4.5}, {"REPER_FORJAT": "ASOLLO_M", "REPER_DEBITARE_ORIGINE": "ASOLLO_M", "DIMENSIUNE_OTEL": 63, "CALITATE_OTEL": "30MnVS6", "KG_BUC_FORJAT": 5.5}, {"REPER_FORJAT": "BF3E301A", "REPER_DEBITARE_ORIGINE": "BF3E301A", "DIMENSIUNE_OTEL": 63, "CALITATE_OTEL": "30MnVS6", "KG_BUC_FORJAT": 5.3}, {"REPER_FORJAT": "457-4062", "REPER_DEBITARE_ORIGINE": "457-4062", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 15.3}, {"REPER_FORJAT": "376-2256", "REPER_DEBITARE_ORIGINE": "376-2256", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 19.6}, {"REPER_FORJAT": "372-7089", "REPER_DEBITARE_ORIGINE": "372-7089", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 19.6}, {"REPER_FORJAT": "511-3101", "REPER_DEBITARE_ORIGINE": "511-3101", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 16}, {"REPER_FORJAT": "416-7454", "REPER_DEBITARE_ORIGINE": "416-7454", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 25}, {"REPER_FORJAT": "457-4063", "REPER_DEBITARE_ORIGINE": "457-4063", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 18.87}, {"REPER_FORJAT": "505-4656", "REPER_DEBITARE_ORIGINE": "505-4656", "DIMENSIUNE_OTEL": 90, "CALITATE_OTEL": "C25", "KG_BUC_FORJAT": 12.4}, {"REPER_FORJAT": "416-7454", "REPER_DEBITARE_ORIGINE": "416-7454", "DIMENSIUNE_OTEL": 100, "CALITATE_OTEL": 1e-42, "KG_BUC_FORJAT": 25}, {"REPER_FORJAT": "SK-304234", "REPER_DEBITARE_ORIGINE": "SK-304234", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "16MnCr05", "KG_BUC_FORJAT": 35.5}, {"REPER_FORJAT": "SK-005-0-65-36-007-1", "REPER_DEBITARE_ORIGINE": "SK-005-0-65-36-007-1", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "16MnCr05", "KG_BUC_FORJAT": 22}, {"REPER_FORJAT": "SK-203034", "REPER_DEBITARE_ORIGINE": "SK-203034", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "C60", "KG_BUC_FORJAT": 26.5}, {"REPER_FORJAT": "453-1011", "REPER_DEBITARE_ORIGINE": "453-1011", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 15.5}, {"REPER_FORJAT": "386-5286", "REPER_DEBITARE_ORIGINE": "386-5286", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 26.7}, {"REPER_FORJAT": "478-7541", "REPER_DEBITARE_ORIGINE": "478-7541", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 12.3}, {"REPER_FORJAT": "493-4858", "REPER_DEBITARE_ORIGINE": "493-4858", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 21.5}, {"REPER_FORJAT": "101-9234", "REPER_DEBITARE_ORIGINE": "101-9234", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 24.5}, {"REPER_FORJAT": "500-1804", "REPER_DEBITARE_ORIGINE": "500-1804", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 18.3}, {"REPER_FORJAT": "9T-6035", "REPER_DEBITARE_ORIGINE": "9T-6035", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 18.3}, {"REPER_FORJAT": "382-3760", "REPER_DEBITARE_ORIGINE": "382-3760", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 18.8}, {"REPER_FORJAT": "376-3091", "REPER_DEBITARE_ORIGINE": "376-3091", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 19.2}, {"REPER_FORJAT": "324-6849", "REPER_DEBITARE_ORIGINE": "324-6849", "DIMENSIUNE_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_FORJAT": 15.94}, {"REPER_FORJAT": "AX-150-1670", "REPER_DEBITARE_ORIGINE": "AX-150-1670", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "1E0621/15B22", "KG_BUC_FORJAT": 59.5}, {"REPER_FORJAT": "AX-368-5844", "REPER_DEBITARE_ORIGINE": "AX-368-5844", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "1E0621/15B22", "KG_BUC_FORJAT": 53}, {"REPER_FORJAT": "505-8995", "REPER_DEBITARE_ORIGINE": "505-8995", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 27.1}, {"REPER_FORJAT": "99-730-84", "REPER_DEBITARE_ORIGINE": "99-730-84", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 21.5}, {"REPER_FORJAT": "99-732-99", "REPER_DEBITARE_ORIGINE": "99-732-99", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": 38}, {"REPER_FORJAT": "99-732-48", "REPER_DEBITARE_ORIGINE": "99-732-48", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "S-355", "KG_BUC_FORJAT": null}, {"REPER_FORJAT": "MENTENANTA", "REPER_DEBITARE_ORIGINE": "SKU-140", "DIMENSIUNE_OTEL": 70, "CALITATE_OTEL": "30CrNiMo8", "KG_BUC_FORJAT": 5.53}, {"REPER_FORJAT": "SKU-140", "REPER_DEBITARE_ORIGINE": "SKU-140", "DIMENSIUNE_OTEL": 70, "CALITATE_OTEL": "30CrNiMo8", "KG_BUC_FORJAT": 5.85}, {"REPER_FORJAT": "ASOLLO", "REPER_DEBITARE_ORIGINE": "ASOLLO", "DIMENSIUNE_OTEL": 63, "CALITATE_OTEL": "30MnVS6", "KG_BUC_FORJAT": 5.5}, {"REPER_FORJAT": "433-4374", "REPER_DEBITARE_ORIGINE": "433-4374", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_FORJAT": 48.9}, {"REPER_FORJAT": "7G-0521/22", "REPER_DEBITARE_ORIGINE": "7G-0521/22", "DIMENSIUNE_OTEL": 65, "CALITATE_OTEL": "1E4808", "KG_BUC_FORJAT": 1.85}, {"REPER_FORJAT": "612-8292", "REPER_DEBITARE_ORIGINE": "612-8292", "DIMENSIUNE_OTEL": 140, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_FORJAT": 26}, {"REPER_FORJAT": "358-5253/55", "REPER_DEBITARE_ORIGINE": "358-5253/55", "DIMENSIUNE_OTEL": 65, "CALITATE_OTEL": "1E4808", "KG_BUC_FORJAT": 2.91}, {"REPER_FORJAT": "417-3595", "REPER_DEBITARE_ORIGINE": "106-1625/26", "DIMENSIUNE_OTEL": 65, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 6.65}, {"REPER_FORJAT": "417-3596", "REPER_DEBITARE_ORIGINE": "106-1625/26", "DIMENSIUNE_OTEL": 65, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 6.65}, {"REPER_FORJAT": "418-2091", "REPER_DEBITARE_ORIGINE": "248-2307/08", "DIMENSIUNE_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 8.5}, {"REPER_FORJAT": "418-2092", "REPER_DEBITARE_ORIGINE": "248-2307/08", "DIMENSIUNE_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_FORJAT": 8.5}], "repere_debitare": [{"REPER_DEBITARE": "9K-6628/29", "DIAMETRU_OTEL": 53, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_DEBITAT": 3.77, "LUNGIME_DEBITARE_MM": 212, "OBSERVATII": null}, {"REPER_DEBITARE": "106-1625/26", "DIAMETRU_OTEL": 65, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_DEBITAT": 6.65, "LUNGIME_DEBITARE_MM": 245, "OBSERVATII": null}, {"REPER_DEBITARE": "229-6909/10", "DIAMETRU_OTEL": 63, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_DEBITAT": 5.8, "LUNGIME_DEBITARE_MM": 235, "OBSERVATII": null}, {"REPER_DEBITARE": "248-2307/08", "DIAMETRU_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_DEBITAT": 8.5, "LUNGIME_DEBITARE_MM": 264, "OBSERVATII": null}, {"REPER_DEBITARE": "503-0761/62", "DIAMETRU_OTEL": 80, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_DEBITAT": 10.96, "LUNGIME_DEBITARE_MM": 275, "OBSERVATII": null}, {"REPER_DEBITARE": "6I-8077", "DIAMETRU_OTEL": 71, "CALITATE_OTEL": "1E-1287/15B34", "KG_BUC_DEBITAT": 13.3, "LUNGIME_DEBITARE_MM": 436, "OBSERVATII": null}, {"REPER_DEBITARE": "526-9280", "DIAMETRU_OTEL": 110, "CALITATE_OTEL": "1E1239G", "KG_BUC_DEBITAT": 22.6, "LUNGIME_DEBITARE_MM": 297, "OBSERVATII": null}, {"REPER_DEBITARE": "526-9278", "DIAMETRU_OTEL": 110, "CALITATE_OTEL": "1E1239G", "KG_BUC_DEBITAT": 27.6, "LUNGIME_DEBITARE_MM": 360, "OBSERVATII": null}, {"REPER_DEBITARE": "349-1248", "DIAMETRU_OTEL": 145, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_DEBITAT": null, "LUNGIME_DEBITARE_MM": null, "OBSERVATII": null}, {"REPER_DEBITARE": "393-2648", "DIAMETRU_OTEL": 145, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_DEBITAT": 26, "LUNGIME_DEBITARE_MM": 200, "OBSERVATII": null}, {"REPER_DEBITARE": "393-2655", "DIAMETRU_OTEL": 145, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_DEBITAT": 26, "LUNGIME_DEBITARE_MM": 200, "OBSERVATII": null}, {"REPER_DEBITARE": "369-3318", "DIAMETRU_OTEL": 145, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_DEBITAT": 31, "LUNGIME_DEBITARE_MM": 240, "OBSERVATII": null}, {"REPER_DEBITARE": "AU1CZ01A", "DIAMETRU_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_DEBITAT": 3.15, "LUNGIME_DEBITARE_MM": 170, "OBSERVATII": null}, {"REPER_DEBITARE": "BF27K01A", "DIAMETRU_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_DEBITAT": 3.15, "LUNGIME_DEBITARE_MM": 170, "OBSERVATII": null}, {"REPER_DEBITARE": "AT-355", "DIAMETRU_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_DEBITAT": 3.15, "LUNGIME_DEBITARE_MM": 170, "OBSERVATII": null}, {"REPER_DEBITARE": "B87K501A", "DIAMETRU_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_DEBITAT": 2.775, "LUNGIME_DEBITARE_MM": 151, "OBSERVATII": null}, {"REPER_DEBITARE": "BF5C001A", "DIAMETRU_OTEL": 55, "CALITATE_OTEL": "C35", "KG_BUC_DEBITAT": 4.15, "LUNGIME_DEBITARE_MM": 224, "OBSERVATII": null}, {"REPER_DEBITARE": "BF32C01A", "DIAMETRU_OTEL": 55, "CALITATE_OTEL": "C45", "KG_BUC_DEBITAT": 3.315, "LUNGIME_DEBITARE_MM": 175, "OBSERVATII": null}, {"REPER_DEBITARE": "BF58101A", "DIAMETRU_OTEL": 55, "CALITATE_OTEL": "C45", "KG_BUC_DEBITAT": 4.5, "LUNGIME_DEBITARE_MM": 238, "OBSERVATII": null}, {"REPER_DEBITARE": "ASOLLO_M", "DIAMETRU_OTEL": 63, "CALITATE_OTEL": "30MnVS6", "KG_BUC_DEBITAT": 5.5, "LUNGIME_DEBITARE_MM": 224, "OBSERVATII": null}, {"REPER_DEBITARE": "BF3E301A", "DIAMETRU_OTEL": 63, "CALITATE_OTEL": "30MnVS6", "KG_BUC_DEBITAT": 5.3, "LUNGIME_DEBITARE_MM": 215, "OBSERVATII": null}, {"REPER_DEBITARE": "457-4062", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 15.3, "LUNGIME_DEBITARE_MM": 0, "OBSERVATII": null}, {"REPER_DEBITARE": "376-2256", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 19.6, "LUNGIME_DEBITARE_MM": 224, "OBSERVATII": null}, {"REPER_DEBITARE": "372-7089", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 19.6, "LUNGIME_DEBITARE_MM": 224, "OBSERVATII": null}, {"REPER_DEBITARE": "511-3101", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 16, "LUNGIME_DEBITARE_MM": 180, "OBSERVATII": null}, {"REPER_DEBITARE": "416-7454", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 25, "LUNGIME_DEBITARE_MM": 280, "OBSERVATII": null}, {"REPER_DEBITARE": "457-4063", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 18.87, "LUNGIME_DEBITARE_MM": 211, "OBSERVATII": null}, {"REPER_DEBITARE": "505-4656", "DIAMETRU_OTEL": 90, "CALITATE_OTEL": "C25", "KG_BUC_DEBITAT": 12.4, "LUNGIME_DEBITARE_MM": 250, "OBSERVATII": null}, {"REPER_DEBITARE": "416-7454", "DIAMETRU_OTEL": 100, "CALITATE_OTEL": 1e-42, "KG_BUC_DEBITAT": 25, "LUNGIME_DEBITARE_MM": 280, "OBSERVATII": null}, {"REPER_DEBITARE": "SK-304234", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "16MnCr05", "KG_BUC_DEBITAT": 35.5, "LUNGIME_DEBITARE_MM": 288, "OBSERVATII": null}, {"REPER_DEBITARE": "SK-005-0-65-36-007-1", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "16MnCr05", "KG_BUC_DEBITAT": 22, "LUNGIME_DEBITARE_MM": 252, "OBSERVATII": null}, {"REPER_DEBITARE": "SK-203034", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "C60", "KG_BUC_DEBITAT": 26.5, "LUNGIME_DEBITARE_MM": 305, "OBSERVATII": null}, {"REPER_DEBITARE": "453-1011", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 15.5, "LUNGIME_DEBITARE_MM": 175, "OBSERVATII": null}, {"REPER_DEBITARE": "386-5286", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 26.7, "LUNGIME_DEBITARE_MM": 300, "OBSERVATII": null}, {"REPER_DEBITARE": "478-7541", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 12.3, "LUNGIME_DEBITARE_MM": 139, "OBSERVATII": null}, {"REPER_DEBITARE": "493-4858", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 21.5, "LUNGIME_DEBITARE_MM": 242, "OBSERVATII": null}, {"REPER_DEBITARE": "101-9234", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 24.5, "LUNGIME_DEBITARE_MM": 242, "OBSERVATII": null}, {"REPER_DEBITARE": "500-1804", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 18.3, "LUNGIME_DEBITARE_MM": 205, "OBSERVATII": null}, {"REPER_DEBITARE": "9T-6035", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 18.3, "LUNGIME_DEBITARE_MM": 205, "OBSERVATII": null}, {"REPER_DEBITARE": "382-3760", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 18.8, "LUNGIME_DEBITARE_MM": 212, "OBSERVATII": null}, {"REPER_DEBITARE": "376-3091", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 19.2, "LUNGIME_DEBITARE_MM": 215, "OBSERVATII": null}, {"REPER_DEBITARE": "324-6849", "DIAMETRU_OTEL": 120, "CALITATE_OTEL": "38MnVs5", "KG_BUC_DEBITAT": 15.94, "LUNGIME_DEBITARE_MM": 179, "OBSERVATII": null}, {"REPER_DEBITARE": "AX-150-1670", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "1E0621/15B22", "KG_BUC_DEBITAT": 59.5, "LUNGIME_DEBITARE_MM": 493, "OBSERVATII": null}, {"REPER_DEBITARE": "AX-368-5844", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "1E0621/15B22", "KG_BUC_DEBITAT": 53, "LUNGIME_DEBITARE_MM": 440, "OBSERVATII": null}, {"REPER_DEBITARE": "505-8995", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 27.1, "LUNGIME_DEBITARE_MM": 221, "OBSERVATII": null}, {"REPER_DEBITARE": "99-730-84", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 21.5, "LUNGIME_DEBITARE_MM": 0, "OBSERVATII": null}, {"REPER_DEBITARE": "99-732-99", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": 38, "LUNGIME_DEBITARE_MM": 0, "OBSERVATII": null}, {"REPER_DEBITARE": "99-732-48", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "S-355", "KG_BUC_DEBITAT": null, "LUNGIME_DEBITARE_MM": null, "OBSERVATII": null}, {"REPER_DEBITARE": "SKU-140", "DIAMETRU_OTEL": 70, "CALITATE_OTEL": "30CrNiMo8", "KG_BUC_DEBITAT": 5.85, "LUNGIME_DEBITARE_MM": 190, "OBSERVATII": null}, {"REPER_DEBITARE": "ASOLLO", "DIAMETRU_OTEL": 63, "CALITATE_OTEL": "30MnVS6", "KG_BUC_DEBITAT": 5.5, "LUNGIME_DEBITARE_MM": 224, "OBSERVATII": null}, {"REPER_DEBITARE": "433-4374", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_DEBITAT": 48.9, "LUNGIME_DEBITARE_MM": 404, "OBSERVATII": null}, {"REPER_DEBITARE": "7G-0521/22", "DIAMETRU_OTEL": 65, "CALITATE_OTEL": "1E4808", "KG_BUC_DEBITAT": 1.85, "LUNGIME_DEBITARE_MM": 77, "OBSERVATII": null}, {"REPER_DEBITARE": "612-8292", "DIAMETRU_OTEL": 140, "CALITATE_OTEL": "1E0361 (C-45)", "KG_BUC_DEBITAT": 26, "LUNGIME_DEBITARE_MM": 217, "OBSERVATII": null}, {"REPER_DEBITARE": "358-5253/55", "DIAMETRU_OTEL": 65, "CALITATE_OTEL": "1E4808", "KG_BUC_DEBITAT": 2.91, "LUNGIME_DEBITARE_MM": 112, "OBSERVATII": null}], "utilaje": ["5 T CHINA", "MP", "1,25 T", "2,5 T", "3 T BR", "3 T ZR", "EVERSING", "1 SCPK 500", "2 SCPK 500"], "utilaje_debitare": ["EVERSING", "1 SCPK 500", "2 SCPK 500"], "utilaje_forja": ["5 T CHINA", "MP", "1,25 T", "2,5 T", "3 T BR", "3 T ZR"], "lista_repere_debitare": ["101-9234", "106-1625/26", "229-6909/10", "248-2307/08", "324-6849", "349-1248", "358-5253/55", "369-3318", "372-7089", "376-2256", "376-3091", "382-3760", "386-5286", "393-2648", "393-2655", "416-7454", "433-4374", "453-1011", "457-4062", "457-4063", "478-7541", "493-4858", "500-1804", "503-0761/62", "505-4656", "505-8995", "511-3101", "526-9278", "526-9280", "612-8292", "6I-8077", "7G-0521/22", "99-730-84", "99-732-48", "99-732-99", "9K-6628/29", "9T-6035", "ASOLLO", "ASOLLO_M", "AT-355", "AU1CZ01A", "AX-150-1670", "AX-368-5844", "B87K501A", "BF27K01A", "BF32C01A", "BF3E301A", "BF58101A", "BF5C001A", "SK-005-0-65-36-007-1", "SK-203034", "SK-304234", "SKU-140"], "lista_calitati": ["16MnCr05", "1E-1287/15B34", "1E0361 (C-45)", "1E0621/15B22", "1E1239G", "1E4808", "1e-42", "30CrNiMo8", "30MnVS6", "38MnVs5", "C25", "C35", "C45", "C60", "S-355"], "lista_diametre": ["53", "55", "63", "65", "70", "71", "80", "90", "100", "110", "120", "140", "145"]};
  function mergeSeed(cur, seeded){
    if (!cur || typeof cur !== "object") return { out: seeded, changed: true };
    const out = Object.assign({}, cur);

    // Umple doar ce lipsește (nu suprascrie ce a editat utilizatorul)
    const props = [
      "tacturi","repere_debitare","repere_forjate","utilaje",
      "utilaje_debitare","utilaje_forja",
      "lista_repere_debitare","lista_calitati","lista_diametre"
    ];

    let changed = false;
    for (const p of props){
      const v = out[p];
      const missing = (v == null) || (Array.isArray(v) && v.length === 0);
      if (missing && seeded[p] != null){
        out[p] = seeded[p];
        changed = true;
      }
    }

    const curV = Number(out.version || 0);
    const seedV = Number(seeded.version || 0);
    const v = Math.max(curV, seedV);
    if (out.version !== v){ out.version = v; changed = true; }

    if (!out.seeded_from && seeded.seeded_from){ out.seeded_from = seeded.seeded_from; changed = true; }
    if (!out.seeded_at && seeded.seeded_at){ out.seeded_at = seeded.seeded_at; changed = true; }

    return { out, changed };
  }

  try {
    const curRaw = localStorage.getItem(KEY);
    if (!curRaw) {
      localStorage.setItem(KEY, JSON.stringify(seeded));
    } else {
      const cur = JSON.parse(curRaw);
      const merged = mergeSeed(cur, seeded);
      if (merged.changed) {
        localStorage.setItem(KEY, JSON.stringify(merged.out));
      }
    }
  } catch(e) {
    console.warn("Nu pot inițializa helperele:", e);
  }
})();
</script>
<div class="topnav">
<div class="brand">Raport Forjă (1 fișier)</div>
<button class="btn" id="btnDashboard" onclick="showPage('dashboard')">Dashboard</button>
<button class="btn" id="btnHelper" onclick="showPage('helper')">HELPER</button>
<button class="btn" id="btnNumeralkod" onclick="showPage('numeralkod')">NUMERALKOD</button>
<button class="btn" id="btnIntrari" onclick="showPage('intrari')">INTRARI_OTEL</button>
<button class="btn" id="btnDebitate" onclick="showPage('debitate')">DEBITATE</button>
<div class="right">
<button class="btn" id="btnBackupAll" onclick="exportAllData()">Backup total</button>
<button class="btn" id="btnRestoreAll" onclick="triggerImportAll()">Restore total</button>
<button class="btn" id="btnResetAll" onclick="resetAllData()">Reset total</button>
<div class="hint">Datele rămân salvate prin Auto‑Save (localStorage) în același browser/PC.</div>
</div>
<input accept="application/json,.json" id="importAllInput" style="display:none" type="file"/>
</div>
<div class="stage">
<iframe id="pageDashboard" sandbox="allow-scripts allow-same-origin allow-downloads allow-modals" srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;ro&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot; /&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
  &lt;title&gt;Dashboard&lt;/title&gt;
  &lt;style&gt;
    .topnav{display:none!important;} .stage{padding-top:0!important;} iframe{height:100vh!important;}

    :root{
      --bg1:#0f172a; --bg2:#070b14; --card:#0b1220; --border:#243045;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); min-height:100vh;
      background: radial-gradient(1200px 600px at 15% 10%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 35%, rgba(59,130,246,.16), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      display:flex; align-items:center; justify-content:center; padding:22px;
    }
    .shell{ width:min(1040px, 100%); }
    .header{ display:flex; flex-direction:column; gap:6px; margin-bottom:14px; }
    .title{ font-size:22px; font-weight:800; letter-spacing:.2px; }
    .subtitle{ color:var(--muted); font-size:13px; line-height:1.35; }

    .grid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    a.card{
      text-decoration:none; color:inherit;
      background: rgba(11,18,32,.85);
      border:1px solid var(--border); border-radius:16px;
      padding:16px; display:flex; flex-direction:column; gap:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition: transform .06s ease, border-color .15s ease, box-shadow .15s ease;
    }
    a.card:hover{ transform: translateY(-1px); border-color: rgba(34,197,94,.65); box-shadow: 0 14px 40px rgba(0,0,0,.35); }
    .cardTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .badge{
      font-size:12px; padding:4px 8px; border-radius:999px; font-weight:800; white-space:nowrap;
      border:1px solid rgba(34,197,94,.35); background: rgba(34,197,94,.12); color:#bbf7d0;
    }
    .badge.gray{ border-color:rgba(148,163,184,.35); background:rgba(148,163,184,.12); color:#e2e8f0; }
    .cardTitle{ font-weight:900; font-size:16px; }
    .cardDesc{ color:var(--muted); font-size:13px; line-height:1.35; }
    .footer{ margin-top:14px; color:var(--muted); font-size:12px; }
    .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; margin: 8px 0 0; }
    .kpi{
      border:1px solid rgba(148,163,184,.22);
      background: rgba(255,255,255,.05);
      padding:8px 10px; border-radius:12px;
      font-size:12px; color:#cbd5e1; font-weight:700;
    }
  
    /* LOGO (salvat local) */
    .logoRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-top:10px; }
    .logoWrap{
      position:relative; width:160px; height:70px;
      border:1px dashed rgba(148,163,184,.38);
      border-radius:16px;
      background: rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    #rfLogoImg{ max-width:100%; max-height:100%; display:none; }
    #rfLogoPlaceholder{ font-weight:900; letter-spacing:.35px; color:#cbd5e1; font-size:18px; opacity:.85; }
    .logoBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .logoBtn{
      border:1px solid rgba(148,163,184,.22);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font: 800 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      white-space:nowrap;
    }
    .logoBtn:hover{ border-color: rgba(34,197,94,.55); }
    .logoBtn.danger:hover{ border-color: rgba(239,68,68,.55); }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;shell&quot;&gt;
    &lt;div class=&quot;header&quot;&gt;
      &lt;div class=&quot;title&quot;&gt;Dashboard&lt;/div&gt;
      &lt;div class=&quot;subtitle&quot;&gt;Meniu principal. Totul este în același fișier, cu Auto‑Save în browser.&lt;/div&gt;
      &lt;div class=&quot;logoRow&quot;&gt;
        &lt;div class=&quot;logoWrap&quot;&gt;
          &lt;img id=&quot;rfLogoImg&quot; alt=&quot;Siglă&quot; /&gt;
          &lt;div id=&quot;rfLogoPlaceholder&quot;&gt;RF&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;logoBtns&quot;&gt;
          &lt;button class=&quot;logoBtn&quot; id=&quot;btnUploadLogo&quot;&gt;Încarcă sigla&lt;/button&gt;
          &lt;button class=&quot;logoBtn danger&quot; id=&quot;btnRemoveLogo&quot;&gt;Șterge&lt;/button&gt;
          &lt;input id=&quot;logoFile&quot; type=&quot;file&quot; accept=&quot;image/*&quot; style=&quot;display:none&quot;/&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;kpiRow&quot;&gt;
        &lt;div class=&quot;kpi&quot; id=&quot;kpiNum&quot;&gt;NUMERALKOD: —&lt;/div&gt;
        &lt;div class=&quot;kpi&quot; id=&quot;kpiIn&quot;&gt;INTRARI_OTEL: —&lt;/div&gt;
        &lt;div class=&quot;kpi&quot; id=&quot;kpiDeb&quot;&gt;DEBITATE: —&lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;grid&quot;&gt;
      &lt;a class=&quot;card&quot; href=&quot;#&quot; onclick=&quot;parent.showPage('numeralkod'); return false;&quot;&gt;
        &lt;div class=&quot;cardTop&quot;&gt;
          &lt;div class=&quot;cardTitle&quot;&gt;NUMERALKOD&lt;/div&gt;
          &lt;div class=&quot;badge&quot;&gt;Activ&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;cardDesc&quot;&gt;Tabel coduri (N/U/M/E/R/A/L/K/O/D) + calități.&lt;/div&gt;
      &lt;/a&gt;

      &lt;a class=&quot;card&quot; href=&quot;#&quot; onclick=&quot;parent.showPage('intrari'); return false;&quot;&gt;
        &lt;div class=&quot;cardTop&quot;&gt;
          &lt;div class=&quot;cardTitle&quot;&gt;INTRARI_OTEL&lt;/div&gt;
          &lt;div class=&quot;badge&quot;&gt;Activ&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;cardDesc&quot;&gt;Intrarea oțelului în fabrică: diametru, calitate, sarjă, kg, pretest, furnizor.&lt;/div&gt;
      &lt;/a&gt;

      &lt;a class=&quot;card&quot; href=&quot;#&quot; onclick=&quot;parent.showPage('debitate'); return false;&quot;&gt;
        &lt;div class=&quot;cardTop&quot;&gt;
          &lt;div class=&quot;cardTitle&quot;&gt;DEBITATE&lt;/div&gt;
          &lt;div class=&quot;badge&quot;&gt;Activ&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;cardDesc&quot;&gt;Debitări: cantitate, kg/buc, lungime, total kg, operator, schimb, import/export Excel.&lt;/div&gt;
      &lt;/a&gt;
    &lt;/div&gt;

    &lt;div class=&quot;footer&quot;&gt;Tip: pentru Import/Export Excel offline, pune &lt;b&gt;xlsx.full.min.js&lt;/b&gt; lângă acest HTML.&lt;/div&gt;
  &lt;/div&gt;

  &lt;script&gt;
    function safeLen(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return 0;
        const obj = JSON.parse(raw);
        // common shapes:
        if(Array.isArray(obj)) return obj.length;
        if(obj &amp;&amp; Array.isArray(obj.intrari)) return obj.intrari.length;
        if(obj &amp;&amp; Array.isArray(obj.rows)) return obj.rows.length;
        if(obj &amp;&amp; Array.isArray(obj.data)) return obj.data.length;
        // or nested state
        if(obj &amp;&amp; obj.state &amp;&amp; Array.isArray(obj.state.rows)) return obj.state.rows.length;
        return 0;
      }catch(e){ return 0; }
    }
    // best-effort keys used across versions
    const kNum = safeLen('NUMERALKOD_autosave_v1');
    const kIn  = safeLen('raport_forja_intrari_otel_v1') || safeLen('INTRARI_OTEL_autosave_v3') || safeLen('INTRARI_OTEL_autosave_v2');
    const kDeb = safeLen('DEBITATE_autosave_v1') || safeLen('DEBITATE_autosave_v2') || safeLen('DEBITATE_autosave_v3');

    document.getElementById('kpiNum').textContent = 'NUMERALKOD: ' + kNum + ' rânduri';
    document.getElementById('kpiIn').textContent  = 'INTRARI_OTEL: ' + kIn + ' rânduri';
    document.getElementById('kpiDeb').textContent = 'DEBITATE: ' + kDeb + ' rânduri';
  
    // --- LOGO (salvat local în browser) ---
    const LOGO_KEY = 'RF_APP_LOGO_V1';
    function renderLogo(){
      const img = document.getElementById('rfLogoImg');
      const ph  = document.getElementById('rfLogoPlaceholder');
      if(!img || !ph) return;
      try{
        const data = localStorage.getItem(LOGO_KEY);
        if(data && typeof data === 'string' && data.startsWith('data:image')){
          img.src = data;
          img.style.display = 'block';
          ph.style.display = 'none';
        }else{
          img.removeAttribute('src');
          img.style.display = 'none';
          ph.style.display = 'block';
        }
      }catch(_e){}
    }
    const fileInp = document.getElementById('logoFile');
    const btnUp   = document.getElementById('btnUploadLogo');
    const btnDel  = document.getElementById('btnRemoveLogo');

    if(btnUp && fileInp){
      btnUp.addEventListener('click', () => fileInp.click());
      fileInp.addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = () => {
          try{ localStorage.setItem(LOGO_KEY, String(r.result || '')); }
          catch(_e){ alert('Nu pot salva sigla (storage blocat).'); }
          renderLogo();
        };
        r.readAsDataURL(f);
      });
    }
    if(btnDel){
      btnDel.addEventListener('click', () => {
        if(!confirm('Șterg sigla salvată?')) return;
        try{ localStorage.removeItem(LOGO_KEY); }catch(_e){}
        renderLogo();
      });
    }
    renderLogo();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
"></iframe>
<iframe id="pageHelper" sandbox="allow-scripts allow-same-origin allow-downloads allow-modals" srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;ro&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;/&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;/&gt;
&lt;title&gt;HELPER&lt;/title&gt;
&lt;style&gt;
  body{margin:0;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1020;color:#0b1020;}
  .wrap{padding:14px;background:#0b1020;min-height:100vh;box-sizing:border-box;}
  .top{
    background:#0f172a;color:#e5e7eb;border:1px solid rgba(148,163,184,.25);
    border-radius:12px;padding:12px 12px 10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
  }
  .top h1{margin:0;font-size:13px;letter-spacing:.2px}
  .btn{cursor:pointer;border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.06);
    color:#e5e7eb;padding:8px 10px;border-radius:10px;font-weight:700;font-size:12px;}
  .btn:active{transform:translateY(1px)}
  .muted{color:#94a3b8;font-size:12px;font-weight:600}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
  .card{
    background:#ffffff;border:1px solid rgba(15,23,42,.15);border-radius:12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.10);
    padding:12px;
  }
  .card h2{margin:0 0 8px 0;font-size:13px;color:#0f172a}
  .subgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .tblwrap{border:1px solid rgba(15,23,42,.15);border-radius:10px;overflow:auto;background:#fff;}
  table{border-collapse:collapse;width:100%;table-layout:fixed;}
  th,td{border-bottom:1px solid rgba(15,23,42,.12);padding:6px 8px;vertical-align:top;}
  th{position:sticky;top:0;background:#f8fafc;font-size:12px;color:#334155;z-index:2;white-space:normal;word-break:break-word;}
  td{font-size:12px;color:#0f172a;}
  td[contenteditable=&quot;true&quot;]{outline:none;}
  .rowbtn{width:28px;min-width:28px;max-width:28px;text-align:center}
  .danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .pill{display:inline-block;margin-left:auto;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.25);color:#16a34a;}
  .pill.off{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.25);color:#dc2626;}
  .msg{margin-top:8px;font-weight:800;font-size:12px}
  .msg.ok{color:#16a34a}
  .msg.err{color:#dc2626}
  .smallbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px;}
  .smallbar .btn{padding:6px 9px;border-radius:9px}
  .note{color:#475569;font-size:12px;font-weight:700}
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;wrap&quot;&gt;
  &lt;div class=&quot;top&quot;&gt;
    &lt;h1&gt;HELPER (editabil)&lt;/h1&gt;
    &lt;button class=&quot;btn&quot; id=&quot;btnExportXlsx&quot;&gt;Export Excel&lt;/button&gt;
    &lt;button class=&quot;btn&quot; id=&quot;btnImportXlsx&quot;&gt;Import Excel&lt;/button&gt;
    &lt;button class=&quot;btn danger&quot; id=&quot;btnReset&quot;&gt;Reset la seed&lt;/button&gt;
    &lt;span class=&quot;pill&quot; id=&quot;pillSave&quot;&gt;autosave: ON&lt;/span&gt;
    &lt;span class=&quot;muted&quot;&gt;Editezi direct tabelele; schimbările se salvează automat și sunt folosite în celelalte foi.&lt;/span&gt;
    &lt;input id=&quot;fileXlsx&quot; type=&quot;file&quot; accept=&quot;.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot; style=&quot;display:none&quot;/&gt;
  &lt;/div&gt;
  &lt;div id=&quot;msg&quot; class=&quot;msg&quot; style=&quot;display:none&quot;&gt;&lt;/div&gt;

  &lt;div class=&quot;grid&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;h2&gt;UTILAJE&lt;/h2&gt;
      &lt;div class=&quot;note&quot;&gt;Liste simple (1 coloană). Se folosesc pentru autocomplete.&lt;/div&gt;
      &lt;div class=&quot;subgrid&quot; style=&quot;margin-top:10px;&quot;&gt;
        &lt;div&gt;
          &lt;div class=&quot;smallbar&quot;&gt;
            &lt;div class=&quot;note&quot;&gt;Utilaje forjă&lt;/div&gt;
            &lt;button class=&quot;btn&quot; id=&quot;addUtilForja&quot;&gt;➕ rând&lt;/button&gt;
          &lt;/div&gt;
          &lt;div class=&quot;tblwrap&quot; id=&quot;wrapUtilForja&quot;&gt;
            &lt;table id=&quot;tblUtilForja&quot;&gt;
              &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Utilaj forjă&lt;/th&gt;&lt;th class=&quot;rowbtn&quot;&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
              &lt;tbody&gt;&lt;/tbody&gt;
            &lt;/table&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;div class=&quot;smallbar&quot;&gt;
            &lt;div class=&quot;note&quot;&gt;Utilaje debitare&lt;/div&gt;
            &lt;button class=&quot;btn&quot; id=&quot;addUtilDeb&quot;&gt;➕ rând&lt;/button&gt;
          &lt;/div&gt;
          &lt;div class=&quot;tblwrap&quot; id=&quot;wrapUtilDeb&quot;&gt;
            &lt;table id=&quot;tblUtilDeb&quot;&gt;
              &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Utilaj debitare&lt;/th&gt;&lt;th class=&quot;rowbtn&quot;&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
              &lt;tbody&gt;&lt;/tbody&gt;
            &lt;/table&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;card&quot;&gt;
      &lt;h2&gt;REPERE DEBITARE&lt;/h2&gt;
      &lt;div class=&quot;smallbar&quot;&gt;
        &lt;button class=&quot;btn&quot; id=&quot;addRepDeb&quot;&gt;➕ rând&lt;/button&gt;
        &lt;span class=&quot;note&quot;&gt;Coloane folosite în DEBITATE pentru autofill (diametru/calitate/kg/buc/lungime).&lt;/span&gt;
      &lt;/div&gt;
      &lt;div class=&quot;tblwrap&quot; id=&quot;wrapRepDeb&quot;&gt;
        &lt;table id=&quot;tblRepDeb&quot;&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;REPER_DEBITARE&lt;/th&gt;
              &lt;th&gt;DIAMETRU_OTEL&lt;/th&gt;
              &lt;th&gt;CALITATE_OTEL&lt;/th&gt;
              &lt;th&gt;KG_BUC_DEBITAT&lt;/th&gt;
              &lt;th&gt;LUNGIME_DEBITARE_MM&lt;/th&gt;
              &lt;th&gt;OBSERVATII&lt;/th&gt;
              &lt;th class=&quot;rowbtn&quot;&gt;&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;&lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;card&quot;&gt;
      &lt;h2&gt;REPERE FORJATE&lt;/h2&gt;
      &lt;div class=&quot;smallbar&quot;&gt;
        &lt;button class=&quot;btn&quot; id=&quot;addRepForj&quot;&gt;➕ rând&lt;/button&gt;
        &lt;span class=&quot;note&quot;&gt;Listă pentru viitoarea foaie FORJATE (legare reper debitat → reper forjat).&lt;/span&gt;
      &lt;/div&gt;
      &lt;div class=&quot;tblwrap&quot; id=&quot;wrapRepForj&quot;&gt;
        &lt;table id=&quot;tblRepForj&quot;&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;REPER_FORJAT&lt;/th&gt;
              &lt;th&gt;REPER_DEBITARE_ORIGINE&lt;/th&gt;
              &lt;th&gt;DIMENSIUNE_OTEL&lt;/th&gt;
              &lt;th&gt;CALITATE_OTEL&lt;/th&gt;
              &lt;th&gt;KG_BUC_FORJAT&lt;/th&gt;
              &lt;th class=&quot;rowbtn&quot;&gt;&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;&lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;card&quot;&gt;
      &lt;h2&gt;TACTURI&lt;/h2&gt;
      &lt;div class=&quot;smallbar&quot;&gt;
        &lt;button class=&quot;btn&quot; id=&quot;addTact&quot;&gt;➕ rând&lt;/button&gt;
        &lt;span class=&quot;note&quot;&gt;Cheie recomandată: Reper|Utilaj (ex: 229-6909|MP).&lt;/span&gt;
      &lt;/div&gt;
      &lt;div class=&quot;tblwrap&quot; id=&quot;wrapTact&quot;&gt;
        &lt;table id=&quot;tblTact&quot;&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;Cheie&lt;/th&gt;
              &lt;th&gt;Reper&lt;/th&gt;
              &lt;th&gt;Utilaj&lt;/th&gt;
              &lt;th&gt;Tact (sec)&lt;/th&gt;
              &lt;th class=&quot;rowbtn&quot;&gt;&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;&lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
(function(){
  const KEY = &quot;RF_HELPERS_v1&quot;;

  function el(id){ return document.getElementById(id); }
  function showMsg(text, ok=true){
    const m = el(&quot;msg&quot;);
    if(!m) return;
    m.style.display = &quot;block&quot;;
    m.className = &quot;msg &quot; + (ok ? &quot;ok&quot; : &quot;err&quot;);
    m.textContent = text;
    clearTimeout(showMsg._t);
    showMsg._t = setTimeout(()=&gt;{ m.style.display=&quot;none&quot;; }, 4000);
  }

  function storageAvailable(){
    try{
      const x=&quot;__t&quot;; localStorage.setItem(x,x); localStorage.removeItem(x);
      return true;
    }catch(e){ return false; }
  }

  function read(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){
      console.warn(&quot;HELPER corupt:&quot;, e);
      return null;
    }
  }

  function recomputeDerived(h){
    if(!h) return h;
    // utilaje (concat)
    const uf = Array.isArray(h.utilaje_forja) ? h.utilaje_forja : [];
    const ud = Array.isArray(h.utilaje_debitare) ? h.utilaje_debitare : [];
    const seen = new Set();
    const all = [];
    [...uf, ...ud].forEach(v=&gt;{
      v = (v ?? &quot;&quot;).toString().trim();
      if(!v) return;
      if(seen.has(v)) return;
      seen.add(v); all.push(v);
    });
    h.utilaje = all;

    // repere + calitati + diametre
    const repDeb = Array.isArray(h.repere_debitare) ? h.repere_debitare : [];
    const repForj = Array.isArray(h.repere_forjate) ? h.repere_forjate : [];
    const repSet = new Set();
    repDeb.forEach(r=&gt;{
      const k = (r.REPER_DEBITARE ?? &quot;&quot;).toString().trim();
      if(k) repSet.add(k);
    });
    h.lista_repere_debitare = Array.from(repSet).sort();

    const calSet = new Set();
    repDeb.forEach(r=&gt;{
      const c = (r.CALITATE_OTEL ?? &quot;&quot;).toString().trim();
      if(c) calSet.add(c);
    });
    repForj.forEach(r=&gt;{
      const c = (r.CALITATE_OTEL ?? &quot;&quot;).toString().trim();
      if(c) calSet.add(c);
    });
    h.lista_calitati = Array.from(calSet).sort();

    const diaSet = new Set();
    repDeb.forEach(r=&gt;{
      const d = (r.DIAMETRU_OTEL ?? &quot;&quot;).toString().trim();
      if(d) diaSet.add(d);
    });
    // sort numeric where possible
    h.lista_diametre = Array.from(diaSet).sort((a,b)=&gt;{
      const na = parseFloat(a), nb = parseFloat(b);
      const ia = isFinite(na), ib = isFinite(nb);
      if(ia &amp;&amp; ib) return na-nb;
      if(ia) return -1;
      if(ib) return 1;
      return (a+&quot;&quot;).localeCompare(b+&quot;&quot;);
    });

    return h;
  }

  function write(h){
    if(!storageAvailable()){
      el(&quot;pillSave&quot;)?.classList.add(&quot;off&quot;);
      el(&quot;pillSave&quot;) &amp;&amp; (el(&quot;pillSave&quot;).textContent=&quot;autosave: OFF&quot;);
      showMsg(&quot;localStorage blocat (autosave OFF).&quot;, false);
      return;
    }
    recomputeDerived(h);
    localStorage.setItem(KEY, JSON.stringify(h));
    try{ parent.postMessage({type:&quot;HELPERS_UPDATED&quot;}, &quot;*&quot;); }catch(e){}
    el(&quot;pillSave&quot;)?.classList.remove(&quot;off&quot;);
    el(&quot;pillSave&quot;) &amp;&amp; (el(&quot;pillSave&quot;).textContent=&quot;autosave: ON&quot;);
  }

  // state
  let H = read() || {version:2, tacturi:[], repere_forjate:[], repere_debitare:[], utilaje_forja:[], utilaje_debitare:[]};

  // ===== render helpers =====
  function mkDelBtn(onClick){
    const b = document.createElement(&quot;button&quot;);
    b.className=&quot;btn danger&quot;;
    b.textContent=&quot;✕&quot;;
    b.style.padding=&quot;4px 7px&quot;;
    b.style.borderRadius=&quot;8px&quot;;
    b.addEventListener(&quot;click&quot;, (e)=&gt;{ e.preventDefault(); e.stopPropagation(); onClick(); });
    return b;
  }

  function fit10(wrapper, table){
    if(!wrapper || !table) return;
    const tbody = table.querySelector(&quot;tbody&quot;);
    const tr = tbody ? tbody.querySelector(&quot;tr&quot;) : null;
    const head = table.querySelector(&quot;thead&quot;);
    const headH = head ? head.offsetHeight : 32;
    let rowH = tr ? tr.offsetHeight : 26;
    if(!rowH || rowH&lt;10) rowH = 26;
    const target = headH + rowH*10 + 2;
    wrapper.style.maxHeight = target + &quot;px&quot;;
  }

  function addEditableCell(tr, value, onCommit){
    const td = document.createElement(&quot;td&quot;);
    td.contentEditable = &quot;true&quot;;
    td.textContent = (value ?? &quot;&quot;) === null ? &quot;&quot; : String(value ?? &quot;&quot;);
    td.addEventListener(&quot;blur&quot;, ()=&gt;{
      onCommit(td.textContent);
    });
    tr.appendChild(td);
    return td;
  }

  function renderUtil(){
    // forja
    const tbF = el(&quot;tblUtilForja&quot;).querySelector(&quot;tbody&quot;);
    const tbD = el(&quot;tblUtilDeb&quot;).querySelector(&quot;tbody&quot;);
    tbF.innerHTML=&quot;&quot;; tbD.innerHTML=&quot;&quot;;
    (H.utilaje_forja || []).forEach((v, idx)=&gt;{
      const tr=document.createElement(&quot;tr&quot;);
      addEditableCell(tr, v, (nv)=&gt;{ H.utilaje_forja[idx]=nv.trim(); write(H); });
      const td=document.createElement(&quot;td&quot;); td.className=&quot;rowbtn&quot;;
      td.appendChild(mkDelBtn(()=&gt;{ H.utilaje_forja.splice(idx,1); renderAll(); write(H); }));
      tr.appendChild(td);
      tbF.appendChild(tr);
    });
    (H.utilaje_debitare || []).forEach((v, idx)=&gt;{
      const tr=document.createElement(&quot;tr&quot;);
      addEditableCell(tr, v, (nv)=&gt;{ H.utilaje_debitare[idx]=nv.trim(); write(H); });
      const td=document.createElement(&quot;td&quot;); td.className=&quot;rowbtn&quot;;
      td.appendChild(mkDelBtn(()=&gt;{ H.utilaje_debitare.splice(idx,1); renderAll(); write(H); }));
      tr.appendChild(td);
      tbD.appendChild(tr);
    });
    fit10(el(&quot;wrapUtilForja&quot;), el(&quot;tblUtilForja&quot;));
    fit10(el(&quot;wrapUtilDeb&quot;), el(&quot;tblUtilDeb&quot;));
  }

  function renderRepDeb(){
    const tb = el(&quot;tblRepDeb&quot;).querySelector(&quot;tbody&quot;);
    tb.innerHTML=&quot;&quot;;
    const cols=[&quot;REPER_DEBITARE&quot;,&quot;DIAMETRU_OTEL&quot;,&quot;CALITATE_OTEL&quot;,&quot;KG_BUC_DEBITAT&quot;,&quot;LUNGIME_DEBITARE_MM&quot;,&quot;OBSERVATII&quot;];
    (H.repere_debitare || []).forEach((row, idx)=&gt;{
      const tr=document.createElement(&quot;tr&quot;);
      cols.forEach(c=&gt;{
        addEditableCell(tr, row?.[c], (nv)=&gt;{ row[c]=nv.trim(); write(H); });
      });
      const td=document.createElement(&quot;td&quot;); td.className=&quot;rowbtn&quot;;
      td.appendChild(mkDelBtn(()=&gt;{ H.repere_debitare.splice(idx,1); renderAll(); write(H); }));
      tr.appendChild(td);
      tb.appendChild(tr);
    });
    fit10(el(&quot;wrapRepDeb&quot;), el(&quot;tblRepDeb&quot;));
  }

  function renderRepForj(){
    const tb = el(&quot;tblRepForj&quot;).querySelector(&quot;tbody&quot;);
    tb.innerHTML=&quot;&quot;;
    const cols=[&quot;REPER_FORJAT&quot;,&quot;REPER_DEBITARE_ORIGINE&quot;,&quot;DIMENSIUNE_OTEL&quot;,&quot;CALITATE_OTEL&quot;,&quot;KG_BUC_FORJAT&quot;];
    (H.repere_forjate || []).forEach((row, idx)=&gt;{
      const tr=document.createElement(&quot;tr&quot;);
      cols.forEach(c=&gt;{
        addEditableCell(tr, row?.[c], (nv)=&gt;{ row[c]=nv.trim(); write(H); });
      });
      const td=document.createElement(&quot;td&quot;); td.className=&quot;rowbtn&quot;;
      td.appendChild(mkDelBtn(()=&gt;{ H.repere_forjate.splice(idx,1); renderAll(); write(H); }));
      tr.appendChild(td);
      tb.appendChild(tr);
    });
    fit10(el(&quot;wrapRepForj&quot;), el(&quot;tblRepForj&quot;));
  }

  function renderTact(){
    const tb = el(&quot;tblTact&quot;).querySelector(&quot;tbody&quot;);
    tb.innerHTML=&quot;&quot;;
    const cols=[&quot;Cheie&quot;,&quot;Reper&quot;,&quot;Utilaj&quot;,&quot;Tact (sec)&quot;];
    (H.tacturi || []).forEach((row, idx)=&gt;{
      const tr=document.createElement(&quot;tr&quot;);
      cols.forEach(c=&gt;{
        addEditableCell(tr, row?.[c], (nv)=&gt;{ row[c]= (c===&quot;Tact (sec)&quot;) ? (nv.trim()===&quot;&quot;? &quot;&quot; : Number(nv)) : nv.trim(); write(H); });
      });
      const td=document.createElement(&quot;td&quot;); td.className=&quot;rowbtn&quot;;
      td.appendChild(mkDelBtn(()=&gt;{ H.tacturi.splice(idx,1); renderAll(); write(H); }));
      tr.appendChild(td);
      tb.appendChild(tr);
    });
    fit10(el(&quot;wrapTact&quot;), el(&quot;tblTact&quot;));
  }

  function renderAll(){
    renderUtil();
    renderRepDeb();
    renderRepForj();
    renderTact();
  }

  // buttons
  el(&quot;addUtilForja&quot;).addEventListener(&quot;click&quot;, ()=&gt;{ H.utilaje_forja = H.utilaje_forja||[]; H.utilaje_forja.push(&quot;&quot;); renderAll(); write(H); });
  el(&quot;addUtilDeb&quot;).addEventListener(&quot;click&quot;, ()=&gt;{ H.utilaje_debitare = H.utilaje_debitare||[]; H.utilaje_debitare.push(&quot;&quot;); renderAll(); write(H); });
  el(&quot;addRepDeb&quot;).addEventListener(&quot;click&quot;, ()=&gt;{ H.repere_debitare = H.repere_debitare||[]; H.repere_debitare.push({}); renderAll(); write(H); });
  el(&quot;addRepForj&quot;).addEventListener(&quot;click&quot;, ()=&gt;{ H.repere_forjate = H.repere_forjate||[]; H.repere_forjate.push({}); renderAll(); write(H); });
  el(&quot;addTact&quot;).addEventListener(&quot;click&quot;, ()=&gt;{ H.tacturi = H.tacturi||[]; H.tacturi.push({}); renderAll(); write(H); });

  el(&quot;btnReset&quot;).addEventListener(&quot;click&quot;, ()=&gt;{
    if(!confirm(&quot;Sigur vrei reset la seed pentru HELPER?&quot;)) return;
    // dacă există seed în localStorage, îl înlocuim cu obiectul seeded din parent (dacă există)
    try{
      const parentRaw = parent?.localStorage?.getItem(KEY);
      // păstrăm doar dacă e valid; altfel reset gol
    }catch(e){}
    H = {version:2, tacturi:[], repere_forjate:[], repere_debitare:[], utilaje_forja:[], utilaje_debitare:[]};
    write(H); renderAll();
    showMsg(&quot;Reset complet HELPER efectuat.&quot;);
  });

  // ===== SheetJS loader =====
  function stripHash(url){ return (url||&quot;&quot;).split(&quot;#&quot;)[0].split(&quot;?&quot;)[0]; }
  function loadScript(src){
    return new Promise((res,rej)=&gt;{
      const s=document.createElement(&quot;script&quot;);
      s.src=src; s.onload=()=&gt;res(); s.onerror=()=&gt;rej(new Error(&quot;load fail &quot;+src));
      document.head.appendChild(s);
    });
  }
  async function ensureXLSX(){
    if (window.XLSX) return true;
    const base = stripHash(location.href);
    const local = base.replace(/[^\/]*$/, &quot;&quot;) + &quot;xlsx.full.min.js&quot;;
    try { await loadScript(local); return !!window.XLSX; } catch(e){}
    try { await loadScript(&quot;https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js&quot;); return !!window.XLSX; } catch(e){}
    return false;
  }

  function exportXlsx(){
    if(!window.XLSX){ showMsg(&quot;SheetJS (xlsx) nu este încărcat.&quot;, false); return; }
    const wb = XLSX.utils.book_new();
    // UTILAJE sheet: two columns
    const max = Math.max((H.utilaje_forja||[]).length, (H.utilaje_debitare||[]).length);
    const utilRows=[[&quot;Utilaje forja&quot;,&quot;Utilaje debitare&quot;]];
    for(let i=0;i&lt;max;i++){
      utilRows.push([H.utilaje_forja?.[i]||&quot;&quot;, H.utilaje_debitare?.[i]||&quot;&quot;]);
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(utilRows), &quot;UTILAJE&quot;);

    // REPERE_DEBITARE
    const rd = (H.repere_debitare||[]);
    const rdHead=[&quot;REPER_DEBITARE&quot;,&quot;DIAMETRU_OTEL&quot;,&quot;CALITATE_OTEL&quot;,&quot;KG_BUC_DEBITAT&quot;,&quot;LUNGIME_DEBITARE_MM&quot;,&quot;OBSERVATII&quot;];
    const rdA=[rdHead, ...rd.map(r=&gt;rdHead.map(k=&gt;r?.[k]??&quot;&quot;))];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rdA), &quot;REPERE_DEBITARE&quot;);

    // REPERE_FORJATE
    const rf=(H.repere_forjate||[]);
    const rfHead=[&quot;REPER_FORJAT&quot;,&quot;REPER_DEBITARE_ORIGINE&quot;,&quot;DIMENSIUNE_OTEL&quot;,&quot;CALITATE_OTEL&quot;,&quot;KG_BUC_FORJAT&quot;];
    const rfA=[rfHead, ...rf.map(r=&gt;rfHead.map(k=&gt;r?.[k]??&quot;&quot;))];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rfA), &quot;REPERE_FORJATE&quot;);

    // TACTURI
    const tt=(H.tacturi||[]);
    const ttHead=[&quot;Cheie&quot;,&quot;Reper&quot;,&quot;Utilaj&quot;,&quot;Tact (sec)&quot;];
    const ttA=[ttHead, ...tt.map(r=&gt;ttHead.map(k=&gt;r?.[k]??&quot;&quot;))];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ttA), &quot;TACTURI&quot;);

    XLSX.writeFile(wb, &quot;HELPER_RaportForja.xlsx&quot;);
  }

  function normHeader(s){
    return (s??&quot;&quot;).toString().trim().toUpperCase().replace(/\s+/g,&quot;_&quot;).replace(/[^\w_()]/g,&quot;&quot;);
  }

  function sheetToObjects(ws){
    const aoa = XLSX.utils.sheet_to_json(ws, {header:1, raw:false});
    const rows = aoa.filter(r=&gt;r &amp;&amp; r.some(x=&gt;String(x??&quot;&quot;).trim()!==&quot;&quot;));
    if(rows.length&lt;1) return {headers:[], data:[]};
    const headers = (rows[0]||[]).map(normHeader);
    const data=[];
    for(let i=1;i&lt;rows.length;i++){
      const r = rows[i]||[];
      const obj={};
      let empty=true;
      for(let c=0;c&lt;headers.length;c++){
        const h=headers[c];
        if(!h) continue;
        const v = r[c];
        if(String(v??&quot;&quot;).trim()!==&quot;&quot;) empty=false;
        obj[h]=v;
      }
      if(!empty) data.push(obj);
    }
    return {headers, data};
  }

  async function importXlsx(file){
    const ok = await ensureXLSX();
    if(!ok){ showMsg(&quot;Nu pot încărca SheetJS (xlsx). Pune xlsx.full.min.js lângă HTML sau folosește internet.&quot;, false); return; }
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:&quot;array&quot;});
    const getSheet = (names)=&gt; {
      for(const n of names){
        const key = Object.keys(wb.Sheets).find(k=&gt;k.toUpperCase()===n.toUpperCase() || k.toUpperCase().includes(n.toUpperCase()));
        if(key) return wb.Sheets[key];
      }
      return null;
    };

    const wsU = getSheet([&quot;UTILAJE&quot;]);
    if(wsU){
      const aoa = XLSX.utils.sheet_to_json(wsU, {header:1, raw:false});
      const rows = aoa.slice(1).filter(r=&gt;r &amp;&amp; r.some(x=&gt;String(x??&quot;&quot;).trim()!==&quot;&quot;));
      const uf=[], ud=[];
      rows.forEach(r=&gt;{
        const a=(r[0]??&quot;&quot;).toString().trim();
        const b=(r[1]??&quot;&quot;).toString().trim();
        if(a) uf.push(a);
        if(b) ud.push(b);
      });
      H.utilaje_forja = uf;
      H.utilaje_debitare = ud;
    }

    const wsRD = getSheet([&quot;REPERE_DEBITARE&quot;]);
    if(wsRD){
      const {headers, data} = sheetToObjects(wsRD);
      // map headers to expected keys
      const map = {
        &quot;REPER_DEBITARE&quot;:&quot;REPER_DEBITARE&quot;,
        &quot;DIAMETRU_OTEL&quot;:&quot;DIAMETRU_OTEL&quot;,
        &quot;CALITATE_OTEL&quot;:&quot;CALITATE_OTEL&quot;,
        &quot;KG_BUC_DEBITAT&quot;:&quot;KG_BUC_DEBITAT&quot;,
        &quot;LUNGIME_DEBITARE_MM&quot;:&quot;LUNGIME_DEBITARE_MM&quot;,
        &quot;OBSERVATII&quot;:&quot;OBSERVATII&quot;
      };
      const out = data.map(o=&gt;{
        const r={};
        Object.keys(map).forEach(h=&gt;{
          // accept headers with suffix digits
          const cand = headers.find(x=&gt;x===h || x.replace(/\d+$/,&quot;&quot;)===h);
          r[map[h]] = cand ? o[cand] : &quot;&quot;;
        });
        return r;
      });
      H.repere_debitare = out;
    }

    const wsRF = getSheet([&quot;REPERE_FORJATE&quot;]);
    if(wsRF){
      const {headers, data} = sheetToObjects(wsRF);
      const map = {
        &quot;REPER_FORJAT&quot;:&quot;REPER_FORJAT&quot;,
        &quot;REPER_DEBITARE_ORIGINE&quot;:&quot;REPER_DEBITARE_ORIGINE&quot;,
        &quot;DIMENSIUNE_OTEL&quot;:&quot;DIMENSIUNE_OTEL&quot;,
        &quot;CALITATE_OTEL&quot;:&quot;CALITATE_OTEL&quot;,
        &quot;KG_BUC_FORJAT&quot;:&quot;KG_BUC_FORJAT&quot;
      };
      const out = data.map(o=&gt;{
        const r={};
        Object.keys(map).forEach(h=&gt;{
          const cand = headers.find(x=&gt;x===h || x.replace(/\d+$/,&quot;&quot;)===h);
          r[map[h]] = cand ? o[cand] : &quot;&quot;;
        });
        return r;
      });
      H.repere_forjate = out;
    }

    const wsT = getSheet([&quot;TACTURI&quot;]);
    if(wsT){
      const {headers, data} = sheetToObjects(wsT);
      const map = {&quot;CHEIE&quot;:&quot;Cheie&quot;,&quot;REPER&quot;:&quot;Reper&quot;,&quot;UTILAJ&quot;:&quot;Utilaj&quot;,&quot;TACT_(SEC)&quot;:&quot;Tact (sec)&quot;,&quot;TACT_SEC&quot;:&quot;Tact (sec)&quot;,&quot;TACT&quot;:&quot;Tact (sec)&quot;};
      const out = data.map(o=&gt;{
        const r={};
        // find candidates
        const get = (want)=&gt; {
          const cand = headers.find(x=&gt;x===want || x.replace(/\d+$/,&quot;&quot;)===want);
          return cand ? o[cand] : &quot;&quot;;
        }
        r[&quot;Cheie&quot;] = get(&quot;CHEIE&quot;) || get(&quot;Cheie&quot;.toUpperCase());
        r[&quot;Reper&quot;] = get(&quot;REPER&quot;);
        r[&quot;Utilaj&quot;] = get(&quot;UTILAJ&quot;);
        r[&quot;Tact (sec)&quot;] = get(&quot;TACT_(SEC)&quot;) || get(&quot;TACT_SEC&quot;) || get(&quot;TACT&quot;);
        return r;
      });
      H.tacturi = out;
    }

    write(H);
    renderAll();
    showMsg(&quot;Import Excel reușit.&quot;);
  }

  el(&quot;btnExportXlsx&quot;).addEventListener(&quot;click&quot;, async()=&gt;{
    const ok = await ensureXLSX();
    if(!ok){ showMsg(&quot;Nu pot încărca SheetJS (xlsx). Pune xlsx.full.min.js lângă HTML sau folosește internet.&quot;, false); return; }
    exportXlsx();
  });

  el(&quot;btnImportXlsx&quot;).addEventListener(&quot;click&quot;, async()=&gt;{
    const ok = await ensureXLSX();
    if(!ok){ showMsg(&quot;Nu pot încărca SheetJS (xlsx). Pune xlsx.full.min.js lângă HTML sau folosește internet.&quot;, false); return; }
    el(&quot;fileXlsx&quot;).click();
  });

  el(&quot;fileXlsx&quot;).addEventListener(&quot;change&quot;, async(e)=&gt;{
    const f = e.target.files?.[0];
    e.target.value=&quot;&quot;;
    if(!f) return;
    try{ await importXlsx(f); }catch(err){ console.error(err); showMsg(&quot;Import eșuat: &quot;+err.message, false); }
  });

  // init
  renderAll();
  write(H); // ensure derived lists exist
  window.addEventListener(&quot;resize&quot;, ()=&gt;{ setTimeout(()=&gt;{ try{ renderAll(); }catch(e){} }, 100); });

  // When shown
  window.addEventListener(&quot;message&quot;,(ev)=&gt;{
    if(ev?.data?.type===&quot;PAGE_SHOWN&quot;){
      setTimeout(()=&gt;{ try{ renderAll(); }catch(e){} }, 50);
    }
  });
})();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;"></iframe>
<iframe id="pageNumeralkod" sandbox="allow-scripts allow-same-origin allow-downloads allow-modals" srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;ro&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot; /&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
  &lt;title&gt;NUMERALKOD – Zale + Alte repere&lt;/title&gt;
  &lt;style&gt;
    :root{
      --grid:#000000;
      --hdr:#b7d7f0;
      --yellow:#fff176;
      --orange:#f4b400;
      --white:#ffffff;
      --muted:#475569;
      --border:#cfd8e3;
      --focus:#2563eb;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Calibri, Arial, sans-serif; background:#f3f6fb; color:#111; }

    .toolbar{
      position: sticky; top: 0; z-index: 50;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px 12px; background: rgba(255,255,255,.95);
      border-bottom:1px solid var(--border);
    }
    .title{ font-weight:800; margin-right:6px; }
    button{
      border:1px solid #94a3b8; background:#ffffff;
      padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700;
    }
    button:hover{ background:#f8fafc; }
    .hint{ margin-left:auto; color:var(--muted); font-size:12px; font-weight:600; }

    .wrap{ padding:12px 10px 26px; overflow-x:auto; }
.dual{
  width: min(100%, 2000px);
  margin: 0 auto;
  display:grid;
  grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); /* mereu 2 tabele una lângă alta; se micșorează ca să încapă */
  gap:12px;
}
@media (max-width: 1100px){
      .hint{ width:100%; margin-left:0; }
    }


    .bucket{
      background:#fff;
      border:1px solid #d6deea;
      border-radius:12px;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
      overflow:hidden;
      min-width: 0;
    }
    .bucketHead{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 10px 8px;
      border-bottom:1px solid #e2e8f0;
      background: linear-gradient(180deg, rgba(183,215,240,.55), rgba(255,255,255,.95));
    }
    .bucketTitle{ font-weight:900; color:#0f172a; }
    .bucketSub{ color:var(--muted); font-size:12px; font-weight:600; }
    .bucketHead .spacer{ flex:1 1 auto; }
    .btnAdd{
      border:1px solid #2563eb;
      background:#2563eb;
      color:#fff;
    }
    .btnAdd:hover{ background:#1d4ed8; }

    .btnMini{ padding:7px 10px; border-radius:10px; font-weight:800; font-size:12px; }
    .btnDark{
      border:1px solid #0f172a;
      background:#0f172a;
      color:#fff;
    }
    .btnDark:hover{ background:#111827; }

    .tableWrap{
      overflow:auto;
      padding-right: 12px; /* spațiu pt scrollbar */
      min-height: 320px; /* fallback când iframe e ascuns la init */
    }

    

    .reserveSection{
      width: min(100%, 2000px);
      margin: 12px auto 0;
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap:12px;
      align-items:flex-start;
    }
    .bucketRez{ min-width:0; }
    .reserveSpacer{ min-width:0; }
/* celule blocate de NUMERALKOD rezervat (doar de la MARCAJ SARJA spre dreapta) */
    tr.lockedRow td.lock{ background:#ffe4e6 !important; }
    tr.lockedRow td.lock.orange{ background:#fda4af !important; }
    tr.lockedRow td.lock.editable{ color:#111; }
    tr.lockedRow td.lock.editable[contenteditable=&quot;false&quot;]{ cursor:not-allowed; }
    tr.lockedRow td.lock.dropdown input:disabled{ cursor:not-allowed; opacity:0.75; background:#ffe4e6; }
.iconbtn{
      border:1px solid #94a3b8;
      background:#fff;
      border-radius:10px;
      padding:6px 9px;
      font-weight:900;
      cursor:pointer;
    }
    .iconbtn:hover{ background:#f8fafc; }
    .iconbtn.danger{ border-color:#ef4444; color:#b91c1c; }
    .iconbtn.danger:hover{ background:#fef2f2; }

table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: var(--white);
      border: 2px solid var(--grid);
    }
    th, td{
  border: 1px solid var(--grid);
  padding: 3px 4px;
  min-height: 22px;
  height: auto;
  font-size: 11px;
  vertical-align: middle;
  text-align:center;
  overflow-wrap: anywhere;
  word-break: break-word;
}
td{ white-space: normal; }
thead th{
  background: var(--hdr);
  font-weight:900;
  position: sticky; top: 0; z-index: 5;
  white-space: normal; /* titluri pe 2+ rânduri, nu se mai taie */
  line-height: 1.05;
  padding: 6px 4px;
}
col.c-numar{ width:7%; }
col.c-1, col.c-2, col.c-3{ width:5%; }
col.c-numar2{ width:7%; }
col.c-seria{ width:7%; }
col.c-marcaj{ width:11%; }
col.c-dim{ width:13%; }
col.c-cal{ width:14%; }
col.c-sarja{ width:13%; }
col.c-scurt{ width:13%; }
td.yellow{ background:var(--yellow); font-weight:800; }
    td.orange{ background:var(--orange); font-weight:800; }
    td.editable{ background:var(--white); text-align:left; padding-left:10px; }
    td.editable[contenteditable=&quot;true&quot;]:focus{ outline: 2px solid var(--focus); outline-offset: -2px; }

    td.dropdown{ padding:0; background:var(--white); }
    td.dropdown input{
      width:100%;
      height:28px;
      border:0;
      padding:0 10px;
      font-family: inherit;
      font-size:12px;
      background:transparent;
      outline:none;
      text-align:left;
    }
    td.dropdown input:focus{ outline: 2px solid var(--focus); outline-offset:-2px; }

    #storageBanner{
      display:none;
      max-width:1820px;
      margin: 10px auto 0;
      padding:10px 12px;
      background:#fff7ed;
      border:1px solid #fb923c;
      border-radius:12px;
      color:#7c2d12;
      font-size:12px;
      font-weight:700;
    }

    #errorBox{
      max-width:1820px;
      margin: 10px auto 0;
      padding:10px 12px;
      background:#fff1f2;
      border:1px solid #fb7185;
      border-radius:12px;
      color:#7f1d1d;
      display:none;
      white-space:pre-wrap;
      font-weight:800;
    }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;toolbar&quot;&gt;
    &lt;div class=&quot;title&quot;&gt;NUMERALKOD&lt;/div&gt;
    &lt;button onclick=&quot;goMenu()&quot;&gt;🏠 Meniu&lt;/button&gt;
    &lt;button onclick=&quot;resetAll()&quot;&gt;Reset (păstrează doar N1 în ZALE)&lt;/button&gt;
    &lt;button onclick=&quot;clearAutosave()&quot;&gt;🗑️ Șterge Auto‑Save&lt;/button&gt;
    &lt;button class=&quot;btnMini btnDark&quot; onclick=&quot;exportXLSX(\&#x27;all\&#x27;)&quot;&gt;⤓ Export Excel&lt;/button&gt;
    &lt;button class=&quot;btnMini btnDark&quot; onclick=&quot;importXLSX(\&#x27;all\&#x27;)&quot;&gt;⤒ Import Excel&lt;/button&gt;
    &lt;input id=&quot;fileImportXLSX&quot; type=&quot;file&quot; accept=&quot;.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot; style=&quot;display:none&quot; /&gt;
    &lt;div class=&quot;hint&quot;&gt;2 tabele fixe (10 rânduri vizibile) + scroll. Adaugi SERIA (ex: N5, D10, M5). Duplicatele sunt blocate între ZALE și ALTE REPERE.&lt;/div&gt;
  &lt;/div&gt;

  &lt;div id=&quot;storageBanner&quot;&gt;
    Atenție: Browserul a blocat salvarea automată (localStorage) pentru fișiere locale. Datele NU vor rămâne după închidere.
    Folosește pagina INTRARI_OTEL (unde ai confirmat că se salvează) ca reper.
  &lt;/div&gt;

  &lt;div id=&quot;errorBox&quot;&gt;&lt;/div&gt;

  &lt;div class=&quot;wrap&quot;&gt;
    &lt;div class=&quot;dual&quot;&gt;
      &lt;div class=&quot;bucket&quot;&gt;
        &lt;div class=&quot;bucketHead&quot;&gt;
          &lt;div&gt;
            &lt;div class=&quot;bucketTitle&quot;&gt;NUMERALKOD zale&lt;/div&gt;
            &lt;div class=&quot;bucketSub&quot;&gt;Setări pentru ZALE (prefix + completări: dimensiune / calitate / sarjă / cod scurt).&lt;/div&gt;
          &lt;/div&gt;
          &lt;div class=&quot;spacer&quot;&gt;&lt;/div&gt;
          &lt;button class=&quot;btnMini btnDark&quot; onclick=&quot;exportXLSX(&#x27;zale&#x27;)&quot;&gt;⤓ Export&lt;/button&gt;
          &lt;button class=&quot;btnMini btnDark&quot; onclick=&quot;importXLSX(&#x27;zale&#x27;)&quot;&gt;⤒ Import&lt;/button&gt;
          &lt;button class=&quot;btnAdd&quot; onclick=&quot;addSeriesPrompt(&#x27;zale&#x27;)&quot;&gt;➕ Adaugă SERIA în ZALE&lt;/button&gt;
        &lt;/div&gt;
        &lt;div class=&quot;tableWrap&quot; id=&quot;wrapZale&quot;&gt;
          &lt;table id=&quot;tblZale&quot;&gt;
            &lt;colgroup&gt;
              &lt;col class=&quot;c-numar&quot;&gt;
              &lt;col class=&quot;c-1&quot;&gt;&lt;col class=&quot;c-2&quot;&gt;&lt;col class=&quot;c-3&quot;&gt;
              &lt;col class=&quot;c-numar2&quot;&gt;
              &lt;col class=&quot;c-seria&quot;&gt;
              &lt;col class=&quot;c-marcaj&quot;&gt;
              &lt;col class=&quot;c-dim&quot;&gt;
              &lt;col class=&quot;c-cal&quot;&gt;
              &lt;col class=&quot;c-sarja&quot;&gt;
              &lt;col class=&quot;c-scurt&quot;&gt;
            &lt;/colgroup&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;NUMAR&lt;/th&gt;
                &lt;th&gt;1&lt;/th&gt;&lt;th&gt;2&lt;/th&gt;&lt;th&gt;3&lt;/th&gt;
                &lt;th&gt;NUMAR2&lt;/th&gt;
                &lt;th&gt;SERIA&lt;/th&gt;
                &lt;th&gt;MARCAJ SARJA&lt;/th&gt;
                &lt;th&gt;DIMENSIUNE MATERIAL&lt;/th&gt;
                &lt;th&gt;CALITATE (Grade)&lt;/th&gt;
                &lt;th&gt;SARJA OTEL&lt;/th&gt;
                &lt;th&gt;COD SCURT&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;&lt;/tbody&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;bucket&quot;&gt;
        &lt;div class=&quot;bucketHead&quot;&gt;
          &lt;div&gt;
            &lt;div class=&quot;bucketTitle&quot;&gt;NUMERALKOD alte repere&lt;/div&gt;
            &lt;div class=&quot;bucketSub&quot;&gt;Setări pentru ALTE REPERE (aceleași reguli, listă separată).&lt;/div&gt;
          &lt;/div&gt;
          &lt;div class=&quot;spacer&quot;&gt;&lt;/div&gt;
          &lt;button class=&quot;btnMini btnDark&quot; onclick=&quot;exportXLSX(&#x27;alte&#x27;)&quot;&gt;⤓ Export&lt;/button&gt;
          &lt;button class=&quot;btnMini btnDark&quot; onclick=&quot;importXLSX(&#x27;alte&#x27;)&quot;&gt;⤒ Import&lt;/button&gt;
          &lt;button class=&quot;btnAdd&quot; onclick=&quot;addSeriesPrompt(&#x27;alte&#x27;)&quot;&gt;➕ Adaugă SERIA în ALTE REPERE&lt;/button&gt;
        &lt;/div&gt;
        &lt;div class=&quot;tableWrap&quot; id=&quot;wrapAlte&quot;&gt;
          &lt;table id=&quot;tblAlte&quot;&gt;
            &lt;colgroup&gt;
              &lt;col class=&quot;c-numar&quot;&gt;
              &lt;col class=&quot;c-1&quot;&gt;&lt;col class=&quot;c-2&quot;&gt;&lt;col class=&quot;c-3&quot;&gt;
              &lt;col class=&quot;c-numar2&quot;&gt;
              &lt;col class=&quot;c-seria&quot;&gt;
              &lt;col class=&quot;c-marcaj&quot;&gt;
              &lt;col class=&quot;c-dim&quot;&gt;
              &lt;col class=&quot;c-cal&quot;&gt;
              &lt;col class=&quot;c-sarja&quot;&gt;
              &lt;col class=&quot;c-scurt&quot;&gt;
            &lt;/colgroup&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;NUMAR&lt;/th&gt;
                &lt;th&gt;1&lt;/th&gt;&lt;th&gt;2&lt;/th&gt;&lt;th&gt;3&lt;/th&gt;
                &lt;th&gt;NUMAR2&lt;/th&gt;
                &lt;th&gt;SERIA&lt;/th&gt;
                &lt;th&gt;MARCAJ SARJA&lt;/th&gt;
                &lt;th&gt;DIMENSIUNE MATERIAL&lt;/th&gt;
                &lt;th&gt;CALITATE (Grade)&lt;/th&gt;
                &lt;th&gt;SARJA OTEL&lt;/th&gt;
                &lt;th&gt;COD SCURT&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;&lt;/tbody&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;

    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div class=&quot;reserveSection&quot;&gt;
    &lt;div class=&quot;bucket bucketRez&quot;&gt;
      &lt;div class=&quot;bucketHead&quot;&gt;
        &lt;div&gt;
          &lt;div class=&quot;bucketTitle&quot;&gt;NUMERALKOD rezervat&lt;/div&gt;
          &lt;div class=&quot;bucketSub&quot;&gt;Orice cod introdus în &lt;b&gt;MARCAJ SARJA&lt;/b&gt; aici blochează automat rândul corespunzător în ZALE și ALTE REPERE (nu mai poți completa DIM/Calitate/Sarjă/Cod scurt pe acel rând).&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;spacer&quot;&gt;&lt;/div&gt;
        &lt;button class=&quot;btnMini btnDark&quot; onclick=&quot;exportXLSX(&#x27;rez&#x27;)&quot;&gt;⤓ Export&lt;/button&gt;
        &lt;button class=&quot;btnMini btnDark&quot; onclick=&quot;importXLSX(&#x27;rez&#x27;)&quot;&gt;⤒ Import&lt;/button&gt;
        &lt;button class=&quot;btnAdd&quot; onclick=&quot;addReservedRow()&quot;&gt;➕ Adaugă COD rezervat&lt;/button&gt;
      &lt;/div&gt;
      &lt;div class=&quot;tableWrap&quot; id=&quot;wrapRez&quot;&gt;
        &lt;table id=&quot;tblRez&quot;&gt;
          &lt;colgroup&gt;
            &lt;col style=&quot;width:16%&quot;&gt;
            &lt;col style=&quot;width:20%&quot;&gt;
            &lt;col style=&quot;width:20%&quot;&gt;
            &lt;col style=&quot;width:16%&quot;&gt;
            &lt;col style=&quot;width:20%&quot;&gt;
            &lt;col style=&quot;width:8%&quot;&gt;
          &lt;/colgroup&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;MARCAJ SARJA&lt;/th&gt;
              &lt;th&gt;DIMENSIUNE MATERIAL&lt;/th&gt;
              &lt;th&gt;CALITATE (Grade)&lt;/th&gt;
              &lt;th&gt;SARJA OTEL&lt;/th&gt;
              &lt;th&gt;REPER rezervat&lt;/th&gt;
              &lt;th&gt;ACT&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;&lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;reserveSpacer&quot;&gt;&lt;/div&gt;
&lt;/div&gt;


  &lt;!-- Lista pentru CALITATE --&gt;
  &lt;datalist id=&quot;gradeList&quot;&gt;
    &lt;option value=&quot;1E-1287/15B34&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;1E1239G&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;1E0361 (C-45)&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;C35&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;C45&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;30MnVS6&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;S-355&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;C25&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;1E-0042&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;16MnCr05&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;C60&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;1E-1497&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;1E0621/15B22&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;1E0509&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;30CrNiMo8&quot;&gt;&lt;/option&gt;
    &lt;option value=&quot;1E4808&quot;&gt;&lt;/option&gt;
  &lt;/datalist&gt;

  &lt;datalist id=&quot;forjateList&quot;&gt;&lt;/datalist&gt;


&lt;script&gt;
/* === Diagnostic: afișează erori JS direct pe pagină === */
(function(){
  const box = document.getElementById(&#x27;errorBox&#x27;);
  window.addEventListener(&#x27;error&#x27;, (e) =&gt; {
    box.style.display = &#x27;block&#x27;;
    box.textContent = &quot;Eroare JavaScript detectată:\n&quot; + (e.message || e.error || &quot;necunoscut&quot;) +
      (e.filename ? &quot;\nFișier: &quot; + e.filename : &quot;&quot;) +
      (e.lineno ? &quot;\nLinie: &quot; + e.lineno : &quot;&quot;);
  });
})();

const LETTERS = [&quot;N&quot;,&quot;U&quot;,&quot;M&quot;,&quot;E&quot;,&quot;R&quot;,&quot;A&quot;,&quot;L&quot;,&quot;K&quot;,&quot;O&quot;,&quot;D&quot;];
const AUTO_KEY = &quot;NUMERALKOD_autosave_v1&quot;;

function goMenu(){
  parent.showPage(&quot;dashboard&quot;);
}

function storageAvailable(){
  try{
    const k=&quot;__test__&quot;;
    window.localStorage.setItem(k,&quot;1&quot;);
    window.localStorage.removeItem(k);
    return true;
  }catch(e){ return false; }
}
const CAN_AUTOSAVE = storageAvailable();
(function(){
  const b = document.getElementById(&#x27;storageBanner&#x27;);
  if (b) b.style.display = CAN_AUTOSAVE ? &quot;none&quot; : &quot;block&quot;;
})();

function showMsg(msg){
  const box = document.getElementById(&#x27;errorBox&#x27;);
  box.style.display = &#x27;block&#x27;;
  box.textContent = msg;
  clearTimeout(showMsg._t);
  showMsg._t = setTimeout(() =&gt; { box.style.display=&#x27;none&#x27;; }, 4500);
}

/* ====== STATE ====== */
let state = {
  zale: [],
  alte: [],
  rez: []
};

function normalizeSeries(input){
  return (input || &quot;&quot;).toString().toUpperCase().replace(/\s+/g,&#x27;&#x27;);
}
function validateSeries(series){
  const m = series.match(/^([A-Z])(\d{1,2})$/);
  if (!m) return {ok:false, err:&quot;Format invalid. Exemplu corect: N5, D10, M5.&quot;};
  const first = m[1];
  const idx = Number(m[2]);
  if (!LETTERS.includes(first)) return {ok:false, err:&quot;Litera seriei trebuie să fie din setul: &quot; + LETTERS.join(&quot; &quot;)};
  if (!(idx &gt;= 1 &amp;&amp; idx &lt;= 10)) return {ok:false, err:&quot;Numărul trebuie să fie între 1 și 10.&quot;};
  return {ok:true, first, idx};
}
function prefixFor(series){
  const v = validateSeries(series);
  if (!v.ok) return &quot;&quot;;
  const second = LETTERS[v.idx-1];
  return v.first + second;
}
function hasSeries(group, series){
  return state[group].some(x =&gt; x.series === series);
}
function findGroupOfSeries(series){
  if (hasSeries(&#x27;zale&#x27;, series)) return &#x27;zale&#x27;;
  if (hasSeries(&#x27;alte&#x27;, series)) return &#x27;alte&#x27;;
  return null;
}
function makeSeriesObj(series){
  return {
    series,
    rows: LETTERS.map(() =&gt; ({dim:&quot;&quot;, grade:&quot;&quot;, sarja:&quot;&quot;, scurt:&quot;&quot;}))
  };
}



/* ====== NUMERALKOD REZERVAT ====== */
function normalizeMarcaj(input){
  return (input || &quot;&quot;).toString().toUpperCase().replace(/\s+/g,&#x27;&#x27;);
}

function inferSeriesFromMarcaj(code){
  const c = normalizeMarcaj(code);
  if (!c || c.length &lt; 2) return &quot;&quot;;
  const first = c.charAt(0);
  const second = c.charAt(1);
  const idx = LETTERS.indexOf(second) + 1;
  if (idx &lt;= 0) return &quot;&quot;;
  return first + String(idx);
}

function validateMarcaj(code){
  const c = normalizeMarcaj(code);
  if (!c) return {ok:false, err:&quot;MARCAJ SARJA este obligatoriu.&quot;};
  if (!/^[A-Z]{3}$/.test(c)) return {ok:false, err:&quot;MARCAJ SARJA trebuie să aibă 3 litere (ex: NNN).&quot;};
  for (const ch of c){
    if (!LETTERS.includes(ch)) return {ok:false, err:&quot;MARCAJ SARJA trebuie format doar din literele: &quot; + LETTERS.join(&quot; &quot;)};
  }
  return {ok:true, code:c};
}
function reservedSet(){
  const set = new Set();
  (state.rez || []).forEach(r =&gt; {
    const c = normalizeMarcaj(r.marcaj);
    if (c) set.add(c);
  });
  return set;
}
function isReserved(marcaj){
  return reservedSet().has(normalizeMarcaj(marcaj));
}
function reservedForSeries(series){
  const pref = prefixFor(series);
  if (!pref) return [];
  const set = reservedSet();
  const hit = [];
  for (const third of LETTERS){
    const code = pref + third;
    if (set.has(code)) hit.push(code);
  }
  return hit;
}
/* ====== RENDER ====== */
function render(){
  // păstrează scroll-ul (ca să nu te arunce sus când se aplică blocările)
  const wz = document.getElementById(&#x27;wrapZale&#x27;);
  const wa = document.getElementById(&#x27;wrapAlte&#x27;);
  const wr = document.getElementById(&#x27;wrapRez&#x27;);
  const sz = wz ? wz.scrollTop : 0;
  const sa = wa ? wa.scrollTop : 0;
  const sr = wr ? wr.scrollTop : 0;

  renderGroup(&#x27;zale&#x27;);
  renderGroup(&#x27;alte&#x27;);
  renderReserved();
  applyReservedLocksDom();

  adjustVisibleRows(); // keep wrappers equal and ~10 rows visible

  if (wz) wz.scrollTop = sz;
  if (wa) wa.scrollTop = sa;
  if (wr) wr.scrollTop = sr;
}

function cellEditable(field, group, sIndex, rIndex, value, locked){
  const safe = (value || &quot;&quot;).toString();
  const ce = locked ? &quot;false&quot; : &quot;true&quot;;
  return `&lt;td class=&quot;editable${locked ? &quot; lock&quot; : &quot;&quot;}&quot; contenteditable=&quot;${ce}&quot; spellcheck=&quot;false&quot;
              data-field=&quot;${field}&quot; data-group=&quot;${group}&quot; data-s=&quot;${sIndex}&quot; data-r=&quot;${rIndex}&quot;&gt;${escapeHtml(safe)}&lt;/td&gt;`;
}

function cellGrade(group, sIndex, rIndex, value, locked){
  const safe = (value || &quot;&quot;).toString();
  const dis = locked ? &quot;disabled&quot; : &quot;&quot;;
  return `&lt;td class=&quot;dropdown${locked ? &quot; lock&quot; : &quot;&quot;}&quot; data-group=&quot;${group}&quot; data-s=&quot;${sIndex}&quot; data-r=&quot;${rIndex}&quot;&gt;
            &lt;input list=&quot;gradeList&quot; value=&quot;${escapeAttr(safe)}&quot; ${dis} /&gt;
          &lt;/td&gt;`;
}

function escapeHtml(s){
  return s.replace(/&amp;/g,&quot;&amp;&quot;).replace(/&lt;/g,&quot;&lt;&quot;).replace(/&gt;/g,&quot;&gt;&quot;);
}
function escapeAttr(s){
  return escapeHtml(s).replace(/&quot;/g,&quot;&amp;amp;quot;&quot;);
}

function renderGroup(group){
  const rezSet = reservedSet();
  const tbl = document.getElementById(group === &#x27;zale&#x27; ? &#x27;tblZale&#x27; : &#x27;tblAlte&#x27;);
  const tbody = tbl.querySelector(&#x27;tbody&#x27;);
  const parts = [];

  state[group].forEach((serieObj, sIndex) =&gt; {
    const series = serieObj.series;
    const pref = prefixFor(series);
    serieObj.rows.forEach((row, rIndex) =&gt; {
      const third = LETTERS[rIndex];
      const marcaj = pref + third;
      const locked = rezSet.has(marcaj);

      parts.push(locked ? &#x27;&lt;tr class=&quot;lockedRow&quot; data-locked=&quot;1&quot;&gt;&#x27;:&#x27;&lt;tr&gt;&#x27;);
      parts.push(`&lt;td&gt;${rIndex+1}&lt;/td&gt;`);
      parts.push(`&lt;td class=&quot;yellow&quot;&gt;${third}&lt;/td&gt;`);
      parts.push(`&lt;td class=&quot;yellow&quot;&gt;${third}&lt;/td&gt;`);
      parts.push(`&lt;td class=&quot;yellow&quot;&gt;${third}&lt;/td&gt;`);
      parts.push(`&lt;td&gt;${rIndex+1}&lt;/td&gt;`);

      if (rIndex === 0){
        parts.push(`&lt;td class=&quot;orange&quot; rowspan=&quot;10&quot;&gt;${series}&lt;/td&gt;`);
      }
      parts.push(`&lt;td class=&quot;orange${locked ? &quot; lock&quot; : &quot;&quot;}&quot;&gt;${marcaj}&lt;/td&gt;`);

      parts.push(cellEditable(&#x27;dim&#x27;, group, sIndex, rIndex, row.dim, locked));
      parts.push(cellGrade(group, sIndex, rIndex, row.grade, locked));
      parts.push(cellEditable(&#x27;sarja&#x27;, group, sIndex, rIndex, row.sarja, locked));
      parts.push(cellEditable(&#x27;scurt&#x27;, group, sIndex, rIndex, row.scurt, locked));

      parts.push(&#x27;&lt;/tr&gt;&#x27;);
    });
  });

  tbody.innerHTML = parts.join(&#x27;&#x27;);
}

function rezCellEditable(field, idx, value){
  const safe = (value || &quot;&quot;).toString();
  return `&lt;td class=&quot;editable&quot; contenteditable=&quot;true&quot; spellcheck=&quot;false&quot; data-rez=&quot;1&quot; data-field=&quot;${field}&quot; data-i=&quot;${idx}&quot;&gt;${escapeHtml(safe)}&lt;/td&gt;`;
}
function rezCellGrade(idx, value){
  const safe = (value || &quot;&quot;).toString();
  return `&lt;td class=&quot;dropdown&quot; data-rez=&quot;1&quot; data-field=&quot;grade&quot; data-i=&quot;${idx}&quot;&gt;
            &lt;input list=&quot;gradeList&quot; value=&quot;${escapeAttr(safe)}&quot; /&gt;
          &lt;/td&gt;`;
}

function rezCellReper(idx, value){
  const safe = (value || &quot;&quot;).toString();
  return `&lt;td class=&quot;dropdown&quot; data-rez=&quot;1&quot; data-field=&quot;reper&quot; data-i=&quot;${idx}&quot;&gt;
            &lt;input list=&quot;forjateList&quot; value=&quot;${escapeAttr(safe)}&quot; placeholder=&quot;alege reper...&quot; /&gt;
          &lt;/td&gt;`;
}
function renderReserved(){
  const tbl = document.getElementById(&#x27;tblRez&#x27;);
  if (!tbl) return;
  const tbody = tbl.querySelector(&#x27;tbody&#x27;);
  const parts = [];
  (state.rez || []).forEach((r, idx) =&gt; {
    parts.push(&#x27;&lt;tr&gt;&#x27;);
    parts.push(rezCellEditable(&#x27;marcaj&#x27;, idx, r.marcaj));
    parts.push(rezCellEditable(&#x27;dim&#x27;, idx, r.dim));
    parts.push(rezCellGrade(idx, r.grade));
    parts.push(rezCellEditable(&#x27;sarja&#x27;, idx, r.sarja));
    parts.push(rezCellReper(idx, r.reper));
    parts.push(`&lt;td class=&quot;center&quot;&gt;&lt;button class=&quot;iconbtn danger&quot; onclick=&quot;deleteReservedRow(${idx})&quot;&gt;🗑&lt;/button&gt;&lt;/td&gt;`);
    parts.push(&#x27;&lt;/tr&gt;&#x27;);
  });
  tbody.innerHTML = parts.join(&#x27;&#x27;);
}

function applyReservedLocksDom(){
  const set = reservedSet();
  [&#x27;tblZale&#x27;,&#x27;tblAlte&#x27;].forEach(tid =&gt; {
    const tbl = document.getElementById(tid);
    if (!tbl) return;
    tbl.querySelectorAll(&#x27;tbody tr&#x27;).forEach(tr =&gt; {
      const orangeCells = Array.from(tr.querySelectorAll(&#x27;td.orange&#x27;));
      const marcajTd = orangeCells.find(td =&gt; /^[A-Z]{3}$/.test((td.textContent||&#x27;&#x27;).trim()));
      if (!marcajTd) return;

      const code = normalizeMarcaj((marcajTd.textContent||&#x27;&#x27;).trim());
      const locked = set.has(code);

      const toLock = [];
      let cur = marcajTd;
      while (cur){
        if (cur.tagName === &#x27;TD&#x27;) toLock.push(cur);
        cur = cur.nextElementSibling;
      }

      if (locked){
        tr.classList.add(&#x27;lockedRow&#x27;);
        tr.dataset.locked = &quot;1&quot;;
        toLock.forEach(td =&gt; {
          td.classList.add(&#x27;lock&#x27;);
          if (td.classList.contains(&#x27;editable&#x27;)) td.setAttribute(&#x27;contenteditable&#x27;,&#x27;false&#x27;);
          const inp = td.querySelector(&#x27;input&#x27;);
          if (inp) inp.disabled = true;
        });
      }else{
        tr.classList.remove(&#x27;lockedRow&#x27;);
        if (tr.dataset) delete tr.dataset.locked;
        toLock.forEach(td =&gt; {
          td.classList.remove(&#x27;lock&#x27;);
          if (td.classList.contains(&#x27;editable&#x27;)) td.setAttribute(&#x27;contenteditable&#x27;,&#x27;true&#x27;);
          const inp = td.querySelector(&#x27;input&#x27;);
          if (inp) inp.disabled = false;
        });
      }
    });
  });
}

function addReservedRow(){
  state.rez = state.rez || [];
  state.rez.push({marcaj:&quot;&quot;, dim:&quot;&quot;, grade:&quot;&quot;, sarja:&quot;&quot;, reper:&quot;&quot;});
  scheduleRender();
  scheduleAutosave();
  const wr = document.getElementById(&#x27;wrapRez&#x27;);
  if (wr) wr.scrollTop = wr.scrollHeight;
}

function deleteReservedRow(idx){
  if (!confirm(&quot;Ștergi codul rezervat selectat?&quot;)) return;
  if (!Array.isArray(state.rez)) state.rez = [];
  state.rez.splice(idx, 1);
  scheduleRender();
  scheduleAutosave();
}


/* ====== EVENTS (delegate) ====== */
const rootWrap = document;

rootWrap.addEventListener(&#x27;keydown&#x27;, (e) =&gt; {
  const t = e.target;
  if (!t) return;
  if ((t.matches(&#x27;td.editable[contenteditable=&quot;true&quot;]&#x27;) || t.matches(&#x27;td.dropdown input&#x27;)) &amp;&amp; e.key === &#x27;Enter&#x27;){
    e.preventDefault();
    t.blur();
  }
}, true);

let _renderQueued = false;
function scheduleRender(){
  if (_renderQueued) return;
  _renderQueued = true;
  setTimeout(() =&gt; {
    _renderQueued = false;
    try{ render(); }catch(e){}
  }, 0);
}

let _applyLocksQueued = false;
function scheduleApplyLocks(){
  if (_applyLocksQueued) return;
  _applyLocksQueued = true;
  setTimeout(() =&gt; {
    _applyLocksQueued = false;
    try{ applyReservedLocksDom(); }catch(e){}
  }, 0);
}

function commitFromTarget(t, evType){
  if (!t) return;

  // dacă rândul este blocat (cod rezervat), ignoră complet editarea
  const tr = t.closest &amp;&amp; t.closest(&#x27;tr&#x27;);
  if (tr &amp;&amp; tr.dataset &amp;&amp; tr.dataset.locked === &quot;1&quot;) return;

  // ===== NUMERALKOD REZERVAT =====
  if (t.matches(&#x27;td.editable[contenteditable=&quot;true&quot;][data-rez=&quot;1&quot;]&#x27;)){
    // evită re-render pe input; commit doar la ieșirea din celulă
    if (evType !== &#x27;focusout&#x27;) return;

    const idx = Number(t.dataset.i);
    const field = t.dataset.field;
    if (!Array.isArray(state.rez) || !state.rez[idx]) return;

    const prev = (state.rez[idx][field] || &quot;&quot;);
    let val = (t.textContent || &quot;&quot;).trim();

    if (field === &quot;marcaj&quot;){
      val = normalizeMarcaj(val);
      const v = validateMarcaj(val);
      if (!v.ok){
        showMsg(v.err);
        t.textContent = normalizeMarcaj(prev);
        return;
      }
      const dup = (state.rez || []).some((x,j) =&gt; j !== idx &amp;&amp; normalizeMarcaj(x.marcaj) === v.code);
      if (dup){
        showMsg(`Codul ${v.code} există deja în tabelul NUMERALKOD rezervat.`);
        t.textContent = normalizeMarcaj(prev);
        return;
      }
      state.rez[idx].marcaj = v.code;
      t.textContent = v.code;

      scheduleAutosave();
      scheduleApplyLocks(); // fără render (nu mai rupe DOM în blur)
      return;
    }

    state.rez[idx][field] = val;
    scheduleAutosave();
    return;
  }

  if (t.matches(&#x27;td.dropdown input&#x27;)){
    const td = t.closest(&#x27;td.dropdown&#x27;);
    if (!td) return;

    // rezervat?
    if (td.dataset &amp;&amp; td.dataset.rez === &quot;1&quot;){
      if (evType !== &#x27;focusout&#x27;) return; // commit doar la blur
      const idx = Number(td.dataset.i);
      const field = (td.dataset.field || &quot;grade&quot;);
      if (!Array.isArray(state.rez) || !state.rez[idx]) return;
      state.rez[idx][field] = (t.value || &quot;&quot;).trim();
      scheduleAutosave();
      return;
    }

    // grade input (zale/alte) – ignoră dacă e disabled
    if (t.disabled) return;

    const group = td.dataset.group;
    const s = Number(td.dataset.s);
    const r = Number(td.dataset.r);
    if (!state[group] || !state[group][s] || !state[group][s].rows[r]) return;
    state[group][s].rows[r].grade = (t.value || &quot;&quot;).trim();
    scheduleAutosave();
    return;
  }

  // ===== ZALE / ALTE (text editable) =====
  if (t.matches(&#x27;td.editable[contenteditable=&quot;true&quot;]&#x27;)){
    const group = t.dataset.group;
    const s = Number(t.dataset.s);
    const r = Number(t.dataset.r);
    const field = t.dataset.field;
    if (!state[group] || !state[group][s] || !state[group][s].rows[r]) return;
    state[group][s].rows[r][field] = (t.textContent || &quot;&quot;).trim();
    scheduleAutosave();
    return;
  }
}

rootWrap.addEventListener(&#x27;input&#x27;, (e) =&gt; commitFromTarget(e.target, &#x27;input&#x27;), true);
rootWrap.addEventListener(&#x27;focusout&#x27;, (e) =&gt; commitFromTarget(e.target, &#x27;focusout&#x27;), true);

/* ====== ADD / RESET ====== */
function addSeriesPrompt(group){
  const input = prompt(&quot;Introdu SERIA (ex: N5, D10, M5). Litera trebuie să fie din N U M E R A L K O D, iar numărul 1…10.&quot;);
  if (!input) return;
  const series = normalizeSeries(input);
  const v = validateSeries(series);
  if (!v.ok){
    showMsg(v.err);
    return;
  }
  const other = (group === &#x27;zale&#x27;) ? &#x27;alte&#x27; : &#x27;zale&#x27;;
  if (hasSeries(group, series)){
    showMsg(`Seria ${series} există deja în tabelul NUMERALKOD ${group === &#x27;zale&#x27; ? &#x27;zale&#x27; : &#x27;alte repere&#x27;}.`);
    return;
  }
  if (hasSeries(other, series)){
    showMsg(`Seria ${series} există deja în tabelul NUMERALKOD ${other === &#x27;zale&#x27; ? &#x27;zale&#x27; : &#x27;alte repere&#x27;}.`);
    return;
  }
  // avertizare: dacă seria generează coduri rezervate, acele rânduri vor fi blocate automat
  const hits = reservedForSeries(series);
  if (hits.length){
    const ok = confirm(&quot;Atenție: seria &quot; + series + &quot; generează coduri rezervate: &quot; + hits.join(&quot;, &quot;) +
      &quot;\nRândurile respective vor fi colorate și blocate în tabel.\n\nContinui?&quot;);
    if (!ok) return;
  }

  state[group].push(makeSeriesObj(series));
  renderGroup(group);
  adjustVisibleRows();
  scheduleAutosave();
  // scroll down to bottom in that table
  const w = document.getElementById(group === &#x27;zale&#x27; ? &#x27;wrapZale&#x27; : &#x27;wrapAlte&#x27;);
  w.scrollTop = w.scrollHeight;
}

function resetAll(){
  state = { zale: [makeSeriesObj(&quot;N1&quot;)], alte: [], rez: [] };
  render();
  scheduleAutosave();
}

/* ====== AUTO-SAVE ====== */
function collectData(){
  const tables = [];
  for (const g of [&#x27;zale&#x27;,&#x27;alte&#x27;]){
    state[g].forEach(s =&gt; {
      tables.push({ group:g, series:s.series, rows: s.rows.map(r =&gt; ({...r})) });
    });
  }
  return tables;
}

function autoSaveNow(){
  if (!CAN_AUTOSAVE) return;
  try{
    const payload = {
      app:&quot;NUMERALKOD&quot;,
      version:2,
      savedAt: new Date().toISOString(),
      tables: collectData(),
      reserved: (state.rez || []).map(r =&gt; ({
        marcaj: normalizeMarcaj(r.marcaj),
        dim: (r.dim||&quot;&quot;).toString(),
        grade: (r.grade||&quot;&quot;).toString(),
        sarja: (r.sarja||&quot;&quot;).toString(),
        reper: (r.reper||&quot;&quot;).toString()
      }))
    };
    localStorage.setItem(AUTO_KEY, JSON.stringify(payload));
  }catch(e){}
}

let _saveTimer = null;
function scheduleAutosave(){
  if (!CAN_AUTOSAVE) return;
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(autoSaveNow, 200);
}

function applyDataTables(tables){
  state = {zale:[], alte:[], rez: (state.rez || [])};
  const arr = Array.isArray(tables) ? tables : [];
  arr.forEach(t =&gt; {
    const g = (t &amp;&amp; t.group === &#x27;alte&#x27;) ? &#x27;alte&#x27; : &#x27;zale&#x27;; // default zale for old data
    const series = normalizeSeries(t.series);
    if (!series) return;
    const obj = makeSeriesObj(series);
    const rows = Array.isArray(t.rows) ? t.rows : [];
    for (let i=0;i&lt;Math.min(10, rows.length);i++){
      const r = rows[i] || {};
      obj.rows[i].dim = (r.dim || &quot;&quot;).toString();
      obj.rows[i].grade = (r.grade || &quot;&quot;).toString();
      obj.rows[i].sarja = (r.sarja || &quot;&quot;).toString();
      obj.rows[i].scurt = (r.scurt || &quot;&quot;).toString();
    }
    // prevent duplicates on load: first one wins
    if (!findGroupOfSeries(obj.series)) state[g].push(obj);
  });
  if (!state.zale.length) state.zale.push(makeSeriesObj(&quot;N1&quot;));
  render();
}

function autoLoad(){
  if (!CAN_AUTOSAVE) return false;
  try{
    const raw = localStorage.getItem(AUTO_KEY);
    if (!raw) return false;
    const obj = JSON.parse(raw);
    if (!obj || !Array.isArray(obj.tables)) return false;
    applyDataTables(obj.tables);
    // rezervat (compatibilitate: poate lipsi)
    if (Array.isArray(obj.reserved)){
      state.rez = obj.reserved.map(x =&gt; ({
        marcaj: normalizeMarcaj(x.marcaj),
        dim: (x.dim||&quot;&quot;).toString(),
        grade: (x.grade||&quot;&quot;).toString(),
        sarja: (x.sarja||&quot;&quot;).toString(),
        reper: (x.reper||&quot;&quot;).toString()
      })).filter(x =&gt; !!x.marcaj);
    }else{
      state.rez = state.rez || [];
    }
    render();
    return true;
  }catch(e){ return false; }
}

function clearAutosave(){
  if (!CAN_AUTOSAVE) return;
  if (!confirm(&quot;Ștergi datele salvate automat pentru NUMERALKOD?&quot;)) return;
  localStorage.removeItem(AUTO_KEY);
  resetAll();
}

/* ====== FIX: 10 rânduri vizibile în fiecare tabel ====== */
function adjustVisibleRows(){
  const tz = document.getElementById(&#x27;tblZale&#x27;);
  if (!tz) return;

  const th = tz.querySelector(&#x27;thead tr&#x27;);
  const tr = tz.querySelector(&#x27;tbody tr&#x27;);

  // IMPORTANT: când iframe-ul e ascuns (display:none), getBoundingClientRect() poate da 0.
  let headH = th ? th.getBoundingClientRect().height : 26;
  let rowH  = tr ? tr.getBoundingClientRect().height : 26;
  if (!headH || headH &lt; 10) headH = 32;
  if (!rowH  || rowH  &lt; 10) rowH  = 26;

  const target = Math.ceil(headH + rowH * 10 + 6);
  const wz = document.getElementById(&#x27;wrapZale&#x27;);
  const wa = document.getElementById(&#x27;wrapAlte&#x27;);
  if (wz) wz.style.height = target + &quot;px&quot;;
  if (wa) wa.style.height = target + &quot;px&quot;;

  // rezervat: aceeași înălțime ca tabelele de sus
  const wr = document.getElementById(&#x27;wrapRez&#x27;);
  if (wr) wr.style.height = target + &quot;px&quot;;
}
window.addEventListener(&#x27;resize&#x27;, () =&gt; setTimeout(adjustVisibleRows, 50));

// Recalculează când pagina devine vizibilă (switch tab-uri din bara de sus)
window.addEventListener(&#x27;message&#x27;, (ev) =&gt; {
  if (!ev || !ev.data) return;
  if (ev.data.type === &quot;PAGE_SHOWN&quot;){
    // 2 încercări: imediat + după layout
    setTimeout(() =&gt; { try{ render(); }catch(e){} try{ adjustVisibleRows(); }catch(e){} }, 40);
    setTimeout(() =&gt; { try{ adjustVisibleRows(); }catch(e){} }, 220);
  }
});
/* ====== IMPORT / EXPORT EXCEL (.xlsx) ====== */
function loadScriptOnce(src){
  return new Promise((resolve, reject) =&gt; {
    const exists = Array.from(document.querySelectorAll(&quot;script&quot;)).some(s =&gt; s.src &amp;&amp; s.src.includes(src));
    if (exists) return resolve();
    const s = document.createElement(&quot;script&quot;);
    s.src = src;
    s.async = true;
    s.onload = () =&gt; resolve();
    s.onerror = () =&gt; reject(new Error(&quot;Nu pot încărca script: &quot; + src));
    document.head.appendChild(s);
  });
}

async function ensureXLSX(){
  if (window.XLSX) return true;

  // 1) local (pune xlsx.full.min.js lângă HTML-ul principal)
  try{
    const base = (parent.location.href.split(&quot;#&quot;)[0].split(&quot;?&quot;)[0]);
    await loadScriptOnce(new URL(&quot;xlsx.full.min.js&quot;, base).href);
    if (window.XLSX) return true;
  }catch(e){ /* ignore */ }

  // 2) CDN (dacă ai internet)
  try{
    await loadScriptOnce(&quot;https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js&quot;);
    if (window.XLSX) return true;
  }catch(e){ /* ignore */ }

  alert(&quot;Nu pot încărca librăria XLSX. Soluție offline: descarcă &#x27;xlsx.full.min.js&#x27; (SheetJS) și pune-l în același folder cu HTML-ul, apoi reîncarcă.&quot;);
  return false;
}

function normalizeHeader(h){
  let s = (h ?? &quot;&quot;)
    .toString()
    .trim()
    .toLowerCase()
    .normalize(&quot;NFD&quot;).replace(/[\u0300-\u036f]/g, &quot;&quot;)
    .replace(/\s+/g, &quot; &quot;)
    .replace(/[()]/g, &quot;&quot;)
    .replace(/[^a-z0-9 +]/g, &quot;&quot;);

  // Excel poate adăuga sufixe numerice la antete duplicate (ex: &quot;SERIA8&quot;, &quot;NUMAR3&quot;, &quot;MARCAJ SARJA9&quot;).
  // Pentru antete strict numerice (ex: &quot;14&quot;, &quot;25&quot;, &quot;36&quot;), păstrăm prima cifră (1/2/3).
  if (/^\d+$/.test(s)) return (s.charAt(0) || &quot;&quot;).trim();

  // Elimină sufixele numerice (ex: &quot;seria8&quot; -&gt; &quot;seria&quot;)
  s = s.replace(/\d+$/g, &quot;&quot;).trim();
  return s;
}
function asText(v){
  if (v === null || v === undefined) return &quot;&quot;;
  return v.toString().trim();
}

function buildTableAoA(group){
  // 1 sheet / 1 tabel (ușor de importat)
  const headers = [&quot;NUMAR&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;NUMAR2&quot;,&quot;SERIA&quot;,&quot;MARCAJ SARJA&quot;,&quot;DIMENSIUNE MATERIAL&quot;,&quot;CALITATE (Grade)&quot;,&quot;SARJA OTEL&quot;,&quot;COD SCURT&quot;];
  const aoa = [headers];
  const list = state[group] || [];
  list.forEach(serieObj =&gt; {
    const series = serieObj.series;
    const pref = prefixFor(series);
    serieObj.rows.forEach((row, idx) =&gt; {
      const third = LETTERS[idx];
      const marcaj = pref + third;
      aoa.push([
        idx+1,
        third, third, third,
        idx+1,
        series,
        marcaj,
        row.dim || &quot;&quot;,
        row.grade || &quot;&quot;,
        row.sarja || &quot;&quot;,
        row.scurt || &quot;&quot;
      ]);
    });
  });
  return aoa;
}

function buildCombinedAoA(){
  // 1 sheet cu 2 tabele (ca în Excel-ul tău, doar că include COD SCURT și la ZALE)
  const leftHdr = [&quot;NUMAR&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;NUMAR2&quot;,&quot;SERIA&quot;,&quot;MARCAJ SARJA&quot;,&quot;DIMENSIUNE MATERIAL&quot;,&quot;CALITATE (Grade)&quot;,&quot;SARJA OTEL&quot;,&quot;COD SCURT&quot;];
  const rightHdr = [&quot;NUMAR&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;NUMAR2&quot;,&quot;SERIA&quot;,&quot;MARCAJ SARJA&quot;,&quot;DIMENSIUNE MATERIAL&quot;,&quot;CALITATE (Grade)&quot;,&quot;SARJA OTEL&quot;,&quot;COD SCURT&quot;];

  const left = buildTableAoA(&quot;zale&quot;).slice(1);  // fără header
  const right = buildTableAoA(&quot;alte&quot;).slice(1);

  const pad2 = [&quot;&quot;,&quot;&quot;];
  const spacer = [&quot;&quot;];
  const aoa = [];

  // titluri
  const row1 = pad2.concat([&quot;NUMERALKOD ZALE&quot;]).concat(Array(leftHdr.length-1).fill(&quot;&quot;)).concat(spacer).concat([&quot;NUMERALKOD ALTE REPERE&quot;]).concat(Array(rightHdr.length-1).fill(&quot;&quot;));
  aoa.push(row1);

  // headere
  aoa.push(pad2.concat(leftHdr).concat(spacer).concat(rightHdr));

  // rânduri
  const maxRows = Math.max(left.length, right.length);
  for (let i=0;i&lt;maxRows;i++){
    const l = left[i] || Array(leftHdr.length).fill(&quot;&quot;);
    const r = right[i] || Array(rightHdr.length).fill(&quot;&quot;);
    aoa.push(pad2.concat(l).concat(spacer).concat(r));
  }
  return aoa;
}


function buildReservedAoA(){
  const hdr = [&quot;MARCAJ SARJA&quot;,&quot;DIMENSIUNE MATERIAL&quot;,&quot;CALITATE (Grade)&quot;,&quot;SARJA OTEL&quot;,&quot;REPER rezervat&quot;];
  const out = [hdr];
  (state.rez || []).forEach(r =&gt; {
    const code = normalizeMarcaj(r.marcaj);
    if (!code) return;
    out.push([
      code,
      asText(r.dim),
      asText(r.grade),
      asText(r.sarja),
      asText(r.reper)
    ]);
  });
  return out;
}


function exportXLSX(mode){
  ensureXLSX().then(ok =&gt; {
    if (!ok) return;

    const wb = XLSX.utils.book_new();
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,&quot;-&quot;);

    if (mode === &quot;rez&quot;){
      const ws = XLSX.utils.aoa_to_sheet(buildReservedAoA());
      XLSX.utils.book_append_sheet(wb, ws, &quot;NUMERALKOD_REZERVAT&quot;);
      XLSX.writeFile(wb, `NUMERALKOD_REZERVAT_${stamp}.xlsx`);
      return;
    }

    if (mode === &quot;zale&quot; || mode === &quot;alte&quot;){
      const aoa = buildTableAoA(mode);
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      XLSX.utils.book_append_sheet(wb, ws, mode === &quot;zale&quot; ? &quot;NUMERALKOD_ZALE&quot; : &quot;NUMERALKOD_ALTE&quot;);
      XLSX.writeFile(wb, `NUMERALKOD_${mode.toUpperCase()}_${stamp}.xlsx`);
      return;
    }

    // all
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(buildTableAoA(&quot;zale&quot;)), &quot;NUMERALKOD_ZALE&quot;);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(buildTableAoA(&quot;alte&quot;)), &quot;NUMERALKOD_ALTE&quot;);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(buildReservedAoA()), &quot;NUMERALKOD_REZERVAT&quot;);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(buildCombinedAoA()), &quot;Sheet1&quot;);
    XLSX.writeFile(wb, `NUMERALKOD_ALL_${stamp}.xlsx`);
  });
}

let _importMode = &quot;all&quot;;
function importXLSX(mode){
  _importMode = mode || &quot;all&quot;;
  const input = document.getElementById(&quot;fileImportXLSX&quot;);
  if (!input) return;
  input.click();
}

function parseSingleTableAoA(aoa){
  const hdrRow = aoa.findIndex(r =&gt; Array.isArray(r)
    &amp;&amp; r.some(c =&gt; normalizeHeader(c) === &quot;numar&quot;)
    &amp;&amp; (r.some(c =&gt; normalizeHeader(c) === &quot;seria&quot;) || r.some(c =&gt; normalizeHeader(c).includes(&quot;marcaj sarja&quot;)))
  );
  if (hdrRow &lt; 0) return {ok:false, err:&quot;Nu găsesc antetul tabelului (NUMAR / SERIA) în fișier.&quot;};

  const hdr = aoa[hdrRow] || [];
  const norm = hdr.map(normalizeHeader);

  const colNumar = norm.findIndex(x =&gt; x === &quot;numar&quot;);
  const colSeria = norm.findIndex(x =&gt; x === &quot;seria&quot;);
  const colMarcaj = norm.findIndex(x =&gt; x.includes(&quot;marcaj sarja&quot;));
  const colDim = norm.findIndex(x =&gt; x.includes(&quot;dimensiune material&quot;));
  const colCal = norm.findIndex(x =&gt; x.startsWith(&quot;calitate&quot;));
  const colSarja = norm.findIndex(x =&gt; x.includes(&quot;sarja otel&quot;));
  const colScurt = norm.findIndex(x =&gt; x.includes(&quot;cod scurt&quot;));

  if (colNumar &lt; 0) return {ok:false, err:&quot;Antet incomplet: lipsește NUMAR.&quot;};
  if (colSeria &lt; 0 &amp;&amp; colMarcaj &lt; 0) return {ok:false, err:&quot;Antet incomplet: lipsește SERIA și MARCAJ SARJA (nu pot deduce seria).&quot;};

  const order = [];
  const map = {};

  for (let i=hdrRow+1; i&lt;aoa.length; i++){
    const row = aoa[i] || [];
    let series = (colSeria &gt;= 0) ? normalizeSeries(row[colSeria]) : &quot;&quot;;
    if (!series){
      const code = (colMarcaj &gt;= 0) ? normalizeMarcaj(row[colMarcaj]) : &quot;&quot;;
      series = inferSeriesFromMarcaj(code);
    }
    if (!series) continue;

    const v = validateSeries(series);
    if (!v.ok) continue;

    const n = Number(asText(row[colNumar]));
    if (!(n&gt;=1 &amp;&amp; n&lt;=10)) continue;

    if (!map[series]){
      map[series] = makeSeriesObj(series);
      order.push(series);
    }
    const obj = map[series];
    obj.rows[n-1].dim   = colDim   &gt;= 0 ? asText(row[colDim])   : &quot;&quot;;
    obj.rows[n-1].grade = colCal   &gt;= 0 ? asText(row[colCal])   : &quot;&quot;;
    obj.rows[n-1].sarja = colSarja &gt;= 0 ? asText(row[colSarja]) : &quot;&quot;;
    obj.rows[n-1].scurt = colScurt &gt;= 0 ? asText(row[colScurt]) : &quot;&quot;;
  }

  return {ok:true, list: order.map(s =&gt; map[s])};
}

function parseSideBySideAoA(aoa){
  // caută un rând cu două antete NUMAR (stânga + dreapta)
  const hdrRow = aoa.findIndex(r =&gt; {
    if (!Array.isArray(r)) return false;
    const norm = r.map(normalizeHeader);
    const idx = [];
    norm.forEach((x,j)=&gt;{ if (x===&quot;numar&quot;) idx.push(j); });
    return idx.length &gt;= 2 &amp;&amp; norm.includes(&quot;seria&quot;);
  });

  if (hdrRow &lt; 0){
    // fallback: tratează ca single-table
    const single = parseSingleTableAoA(aoa);
    if (!single.ok) return {ok:false, err: single.err};
    return {ok:true, zale: single.list, alte: []};
  }

  const hdr = aoa[hdrRow] || [];
  const norm = hdr.map(normalizeHeader);
  const numIdxs = [];
  norm.forEach((x,j)=&gt;{ if (x===&quot;numar&quot;) numIdxs.push(j); });

  const leftStart = numIdxs[0];
  const rightStart = numIdxs[numIdxs.length-1];

  const leftSeg = hdr.slice(leftStart, rightStart);
  const rightSeg = hdr.slice(rightStart);

  function buildMap(seg, offset){
    const n = seg.map(normalizeHeader);
    const colNumar  = n.findIndex(x=&gt;x===&quot;numar&quot;); if (colNumar&gt;=0) n[colNumar] = &quot;numar&quot;;
    const colSeria  = n.findIndex(x=&gt;x===&quot;seria&quot;);
    const colMarcaj = n.findIndex(x=&gt;x.includes(&quot;marcaj sarja&quot;));
    const colDim    = n.findIndex(x=&gt;x.includes(&quot;dimensiune material&quot;));
    const colCal    = n.findIndex(x=&gt;x.startsWith(&quot;calitate&quot;));
    const colSarja  = n.findIndex(x=&gt;x.includes(&quot;sarja otel&quot;));
    const colScurt  = n.findIndex(x=&gt;x.includes(&quot;cod scurt&quot;));
    return {
      colNumar:  colNumar&gt;=0  ? offset+colNumar  : -1,
      colSeria:  colSeria&gt;=0  ? offset+colSeria  : -1,
      colMarcaj: colMarcaj&gt;=0 ? offset+colMarcaj : -1,
      colDim:    colDim&gt;=0    ? offset+colDim    : -1,
      colCal:    colCal&gt;=0    ? offset+colCal    : -1,
      colSarja:  colSarja&gt;=0  ? offset+colSarja  : -1,
      colScurt:  colScurt&gt;=0  ? offset+colScurt  : -1
    };
  }

  const mapL = buildMap(leftSeg, leftStart);
  const mapR = buildMap(rightSeg, rightStart);

  function parseWithMap(map){
    if (map.colNumar &lt; 0) return [];
    const order = [];
    const dict = {};
    for (let i=hdrRow+1; i&lt;aoa.length; i++){
      const row = aoa[i] || [];
      let series = (map.colSeria &gt;= 0) ? normalizeSeries(row[map.colSeria]) : &quot;&quot;;
      if (!series){
        const code = (map.colMarcaj &gt;= 0) ? normalizeMarcaj(row[map.colMarcaj]) : &quot;&quot;;
        series = inferSeriesFromMarcaj(code);
      }
      if (!series) continue;
      const v = validateSeries(series);
      if (!v.ok) continue;

      const n = Number(asText(row[map.colNumar]));
      if (!(n&gt;=1 &amp;&amp; n&lt;=10)) continue;

      if (!dict[series]){
        dict[series] = makeSeriesObj(series);
        order.push(series);
      }
      const obj = dict[series];
      obj.rows[n-1].dim   = map.colDim   &gt;=0 ? asText(row[map.colDim]) : &quot;&quot;;
      obj.rows[n-1].grade = map.colCal   &gt;=0 ? asText(row[map.colCal]) : &quot;&quot;;
      obj.rows[n-1].sarja = map.colSarja &gt;=0 ? asText(row[map.colSarja]) : &quot;&quot;;
      obj.rows[n-1].scurt = map.colScurt &gt;=0 ? asText(row[map.colScurt]) : &quot;&quot;;
    }
    return order.map(s=&gt;dict[s]);
  }

  return {ok:true, zale: parseWithMap(mapL), alte: parseWithMap(mapR)};
}


function parseReservedAoA(aoa){
  const hdrRow = aoa.findIndex(r =&gt; Array.isArray(r) &amp;&amp; r.some(c =&gt; normalizeHeader(c).includes(&quot;marcaj sarja&quot;)));
  if (hdrRow &lt; 0) return {ok:false, err:&quot;Nu găsesc antetul pentru NUMERALKOD REZERVAT (MARCAJ SARJA) în fișier.&quot;};
  const hdr = aoa[hdrRow] || [];
  const norm = hdr.map(normalizeHeader);

  const colMarcaj = norm.findIndex(x =&gt; x.includes(&quot;marcaj sarja&quot;));
  const colDim    = norm.findIndex(x =&gt; x.includes(&quot;dimensiune material&quot;));
  const colCal    = norm.findIndex(x =&gt; x.startsWith(&quot;calitate&quot;));
  const colSarja  = norm.findIndex(x =&gt; x.includes(&quot;sarja otel&quot;));
  const colReper  = norm.findIndex(x =&gt; x.includes(&quot;reper&quot;));

  if (colMarcaj &lt; 0) return {ok:false, err:&quot;Antet incomplet: lipsește MARCAJ SARJA.&quot;};

  const list = [];
  const seen = new Set();
  for (let i=hdrRow+1; i&lt;aoa.length; i++){
    const row = aoa[i] || [];
    const codeRaw = asText(row[colMarcaj]);
    if (!codeRaw) continue;
    const v = validateMarcaj(codeRaw);
    if (!v.ok) continue;
    if (seen.has(v.code)) continue;
    seen.add(v.code);
    list.push({
      marcaj: v.code,
      dim: colDim &gt;=0 ? asText(row[colDim]) : &quot;&quot;,
      grade: colCal &gt;=0 ? asText(row[colCal]) : &quot;&quot;,
      sarja: colSarja &gt;=0 ? asText(row[colSarja]) : &quot;&quot;,
      reper: colReper &gt;=0 ? asText(row[colReper]) : &quot;&quot;
    });
  }
  return {ok:true, list};
}


function applyImport(mode, payload){
  const report = {skipped:[], importedZale:0, importedAlte:0, importedRez:0};

  // rezervat (poate veni la orice import)
  if (Array.isArray(payload.rez) || Array.isArray(payload.reserved)){
    const arr = payload.rez || payload.reserved || [];
    const seen = new Set();
    state.rez = arr.map(x =&gt; ({
      marcaj: normalizeMarcaj(x.marcaj),
      dim: (x.dim||&quot;&quot;).toString(),
      grade: (x.grade||&quot;&quot;).toString(),
      sarja: (x.sarja||&quot;&quot;).toString(),
      reper: (x.reper||&quot;&quot;).toString()
    })).filter(x =&gt; {
      if (!x.marcaj) return false;
      if (seen.has(x.marcaj)) return false;
      seen.add(x.marcaj);
      return true;
    });
    report.importedRez = state.rez.length;
  }else if (mode === &quot;rez&quot; &amp;&amp; Array.isArray(payload.list)){
    // compat: import rezervat ca {list:[...]}
    const seen = new Set();
    state.rez = payload.list.map(x =&gt; ({
      marcaj: normalizeMarcaj(x.marcaj),
      dim: (x.dim||&quot;&quot;).toString(),
      grade: (x.grade||&quot;&quot;).toString(),
      sarja: (x.sarja||&quot;&quot;).toString(),
      reper: (x.reper||&quot;&quot;).toString()
    })).filter(x =&gt; {
      if (!x.marcaj) return false;
      if (seen.has(x.marcaj)) return false;
      seen.add(x.marcaj);
      return true;
    });
    report.importedRez = state.rez.length;
  }

  if (mode === &quot;rez&quot;){
    render();
    scheduleAutosave();
    showMsg(`Import OK. REZERVAT: ${report.importedRez} coduri`);
    return;
  }

  if (mode === &quot;all&quot;){
    const next = {zale:[], alte:[], rez: state.rez || []};

    (payload.zale || []).forEach(obj=&gt;{
      if (next.zale.some(x=&gt;x.series===obj.series)) return;
      next.zale.push(obj);
    });
    // ALTE: import fidel (permite serii duplicate între ZALE și ALTE)
    (payload.alte || []).forEach(obj=&gt;{
      if (next.alte.some(x=&gt;x.series===obj.series)) return;
      next.alte.push(obj);
    });

    if (!next.zale.length) next.zale.push(makeSeriesObj(&quot;N1&quot;));
    state = next;
    report.importedZale = next.zale.length;
    report.importedAlte = next.alte.length;

  }else if (mode === &quot;zale&quot; || mode === &quot;alte&quot;){
    const other = mode === &quot;zale&quot; ? &quot;alte&quot; : &quot;zale&quot;;
    const incoming = payload[mode] || payload.list || [];
    // Import fidel: nu blochează duplicatele față de celălalt tabel.
    const incomingClean = [];
    (incoming || []).forEach(obj=&gt;{
      if (!obj || !obj.series) return;
      if (incomingClean.some(x=&gt;x.series===obj.series)) return; // păstrăm unicitatea internă
      incomingClean.push(obj);
    });
    state[mode] = incomingClean.length ? incomingClean : (mode===&quot;zale&quot; ? [makeSeriesObj(&quot;N1&quot;)] : []);
    report.importedZale = state.zale.length;
    report.importedAlte = state.alte.length;
  }

  render();
  scheduleAutosave();

  const msgParts = [];
  msgParts.push(`Import OK. ZALE: ${report.importedZale} serii | ALTE: ${report.importedAlte} serii | REZERVAT: ${report.importedRez} coduri`);
  if (report.skipped.length){
    msgParts.push(&quot;Ignorate (duplicate în celălalt tabel): &quot; + report.skipped.join(&quot;, &quot;));
  }
  showMsg(msgParts.join(&quot;\n&quot;));
}

(function wireImportXLSX(){
  const input = document.getElementById(&quot;fileImportXLSX&quot;);
  if (!input) return;

  input.addEventListener(&quot;change&quot;, async (e) =&gt; {
    const f = e.target.files &amp;&amp; e.target.files[0];
    if (!f) return;

    try{
      const ok = await ensureXLSX();
      if (!ok) return;

      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, {type:&quot;array&quot;});

      const nameZ = wb.SheetNames.find(n =&gt; normalizeHeader(n).includes(&quot;zale&quot;));
      const nameA = wb.SheetNames.find(n =&gt; normalizeHeader(n).includes(&quot;alte&quot;));
      const nameR = wb.SheetNames.find(n =&gt; normalizeHeader(n).includes(&quot;rezerv&quot;));

      let payload = {zale:[], alte:[], rez:[]};

      if ((_importMode === &quot;zale&quot; || _importMode === &quot;all&quot;) &amp;&amp; nameZ){
        const aoa = XLSX.utils.sheet_to_json(wb.Sheets[nameZ], {header:1, raw:false, defval:&quot;&quot;});
        const parsed = parseSingleTableAoA(aoa);
        if (parsed.ok) payload.zale = parsed.list;
      }
      if ((_importMode === &quot;alte&quot; || _importMode === &quot;all&quot;) &amp;&amp; nameA){
        const aoa = XLSX.utils.sheet_to_json(wb.Sheets[nameA], {header:1, raw:false, defval:&quot;&quot;});
        const parsed = parseSingleTableAoA(aoa);
        if (parsed.ok) payload.alte = parsed.list;
      }
      if ((_importMode === &quot;rez&quot; || _importMode === &quot;all&quot;) &amp;&amp; nameR){
        const aoa = XLSX.utils.sheet_to_json(wb.Sheets[nameR], {header:1, raw:false, defval:&quot;&quot;});
        const parsed = parseReservedAoA(aoa);
        if (parsed.ok) payload.rez = parsed.list;
      }

      // fallback: sheet1 side-by-side (zale/alte)
      if ((_importMode === &quot;zale&quot; || _importMode === &quot;alte&quot; || _importMode === &quot;all&quot;) &amp;&amp; !payload.zale.length &amp;&amp; !payload.alte.length){
        const firstName = wb.SheetNames[0];
        const aoa = XLSX.utils.sheet_to_json(wb.Sheets[firstName], {header:1, raw:false, defval:&quot;&quot;});
        const parsed = parseSideBySideAoA(aoa);
        if (parsed.ok){
          payload.zale = parsed.zale || [];
          payload.alte = parsed.alte || [];

          // Dacă utilizatorul importă doar ALTE/Zale dintr-un Excel care conține un singur tabel
          // (fără două tabele side-by-side și fără sheet dedicat), parseSideBySideAoA îl tratează ca &quot;single-table&quot;
          // și îl pune în `zale`. În modul &quot;alte&quot; trebuie să îl mapăm în `alte`.
          if (_importMode === &quot;alte&quot; &amp;&amp; !payload.alte.length &amp;&amp; payload.zale.length){
            payload.alte = payload.zale;
            payload.zale = [];
          }
          if (_importMode === &quot;zale&quot; &amp;&amp; !payload.zale.length &amp;&amp; payload.alte.length){
            payload.zale = payload.alte;
            payload.alte = [];
          }
        }
      }

      // fallback rezervat: prima foaie
      if (_importMode === &quot;rez&quot; &amp;&amp; !payload.rez.length){
        const firstName = wb.SheetNames[0];
        const aoa = XLSX.utils.sheet_to_json(wb.Sheets[firstName], {header:1, raw:false, defval:&quot;&quot;});
        const parsed = parseReservedAoA(aoa);
        if (!parsed.ok) throw new Error(parsed.err || &quot;Import REZERVAT eșuat.&quot;);
        payload.rez = parsed.list || [];
      }

      if (_importMode === &quot;zale&quot;){
        applyImport(&quot;zale&quot;, {zale: payload.zale});
      }else if (_importMode === &quot;alte&quot;){
        applyImport(&quot;alte&quot;, {alte: payload.alte});
      }else if (_importMode === &quot;rez&quot;){
        applyImport(&quot;rez&quot;, {rez: payload.rez});
      }else{
        applyImport(&quot;all&quot;, payload);
      }

    }catch(err){
      alert(&quot;Nu am putut importa Excel: &quot; + (err?.message || err));
    }finally{
      e.target.value = &quot;&quot;;
    }
  });
})();


/* ====== HELPER (source of truth) ====== */
const HELPERS_KEY = &quot;RF_HELPERS_v1&quot;;
function getHelpersSafe(){
  try{ return JSON.parse(localStorage.getItem(HELPERS_KEY) || &quot;{}&quot;) || {}; }catch(e){ return {}; }
}
function setDatalistOptions(id, values){
  const dl = document.getElementById(id);
  if (!dl) return;
  const seen = new Set();
  const opts = [];
  (values || []).forEach(v =&gt; {
    const s = (v ?? &quot;&quot;).toString().trim();
    if (!s || seen.has(s)) return;
    seen.add(s);
    opts.push(`&lt;option value=&quot;${escapeAttr(s)}&quot;&gt;&lt;/option&gt;`);
  });
  dl.innerHTML = opts.join(&quot;&quot;);
}
function refreshHelperDatalists(){
  const h = getHelpersSafe();

  const repereForjate = Array.isArray(h.repere_forjate) ? h.repere_forjate
    .map(o =&gt; o?.REPER_FORJAT ?? o?.Reper ?? o?.REPER)
    .filter(Boolean) : [];
  setDatalistOptions(&quot;forjateList&quot;, repereForjate);

  if (Array.isArray(h.lista_calitati) &amp;&amp; h.lista_calitati.length){
    setDatalistOptions(&quot;gradeList&quot;, h.lista_calitati);
  }
}
window.addEventListener(&quot;message&quot;, (e) =&gt; {
  if (e &amp;&amp; e.data &amp;&amp; e.data.type === &quot;HELPERS_UPDATED&quot;){
    refreshHelperDatalists();
  }
});


/* ====== INIT ====== */
(function init(){
  state.zale = [makeSeriesObj(&quot;N1&quot;)];
  state.alte = [];
  state.rez = [];
  render();
  autoLoad();
  try{ refreshHelperDatalists(); }catch(e){}
})();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
"></iframe>
<iframe id="pageIntrari" sandbox="allow-scripts allow-same-origin allow-downloads allow-modals" srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;ro&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot; /&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
  &lt;title&gt;INTRARI OTEL&lt;/title&gt;
  &lt;style&gt;
    :root{
      --bg:#b7d7f0;
      --hdr:#cfe3f6;
      --grid:#000;
      --white:#fff;
      --btn:#2b6cb0;
      --btn2:#1e5a96;
      --focus:#2563eb;
      --muted:#334155;
      --filterBg:#e6f0fb;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Calibri, Arial, sans-serif; background: var(--bg); color:#111; min-height:100vh; }

    .topbar{ display:flex; align-items:center; justify-content:flex-end; gap:10px; padding:6px 10px; flex-wrap:wrap; }
    .btnAdd{
      display:inline-flex; align-items:center; gap:8px; border:0;
      background: var(--btn); color:#fff; font-weight:700;
      padding:6px 10px; border-radius:3px; cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.15);
    }
    .btnAdd:hover{ background: var(--btn2); }
    .btnMenu{
      margin-right:auto; border:0; background: rgba(255,255,255,.85);
      color:#0f172a; font-weight:700; padding:6px 10px; border-radius:3px;
      cursor:pointer; box-shadow: 0 1px 0 rgba(0,0,0,.12);
    }
    .btnMenu:hover{ background:#fff; }
    .plusCircle{
      width:18px; height:18px; border-radius:999px; background:#fff; color:var(--btn);
      display:inline-flex; align-items:center; justify-content:center; font-weight:900; line-height:1;
    }

    #storageBanner{
      display:none;
      width: 980px;
      margin: 6px 10px 0;
      padding: 8px 10px;
      background: #fff7ed;
      border: 1px solid #fb923c;
      color: #7c2d12;
      font-size: 12px;
      font-weight: 700;
    }

    .sheet{ padding: 4px 10px 18px; }
    .sheetGrid{ display:flex; align-items:flex-start; gap:14px; }

    /* fixed-size table area (nu se mai mărește) */
    .tableWrap{
      width: 1010px;              /* 980px tabel + spațiu pentru scrollbar */
      height: 520px;              /* zona fixă ca în poză */
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 14px;        /* spațiu ca scrollbar-ul să nu taie din tabel */
    }

    table#tbl{ width: 980px; }
    table{ border-collapse: collapse; table-layout: fixed; background: var(--white); border: 2px solid var(--grid); }
    th, td{ border: 1px solid var(--grid); padding: 4px 6px; height: 22px; font-size: 12px; vertical-align: middle; text-align:center; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    thead th{ background: var(--hdr); font-weight:700; position:relative; }

    /* antet fix la scroll */
    thead th{ position: sticky; top: 0; z-index: 5; }

    thead th .filter{
      position:absolute; right:2px; bottom:2px; width:18px; height:16px;
      border:1px solid #9aa7b2; background:#e7edf3; display:flex; align-items:center; justify-content:center;
    }
    thead th .filter:before{
      content:&quot;&quot;; width:0; height:0;
      border-left:4px solid transparent; border-right:4px solid transparent; border-top:6px solid #4b5563;
      transform: translateY(1px);
    }

    /* filter row */
    #filterRow th{ background: var(--filterBg); padding: 2px 3px; height: 24px; position: sticky; top: 22px; z-index: 6; }
    #filterRow input, #filterRow select{
      width: 100%; height: 20px; border: 1px solid #9aa7b2; background:#ffffff;
      font-family: inherit; font-size: 11px; padding: 0 4px; outline: none;
    }
    #filterRow input:focus, #filterRow select:focus{ border-color: var(--focus); box-shadow: 0 0 0 2px rgba(37,99,235,.12); }

    /* editable cells */
    td.editableCell{ background:#fff; text-align:left; padding-left:8px; }
    td.editableCell[contenteditable=&quot;true&quot;]:focus{ outline: 2px solid var(--focus); outline-offset: -2px; }

    /* column widths */
    col.cAn{ width:50px; }
    col.cLuna{ width:70px; }
    col.cData{ width:90px; }
    col.cDim{ width:115px; }
    col.cCal{ width:115px; }
    col.cPrem{ width:125px; }
    col.cCat{ width:105px; }
    col.cKg{ width:95px; }
    col.cPre{ width:95px; }
    col.cFurn{ width:120px; }

    /* side panel */
    .sidePanel{ width: 360px; flex: 0 0 360px; }
    .sideCard{
      background: rgba(255,255,255,.9);
      border: 1px solid #8aa6c2;
      box-shadow: 0 1px 0 rgba(0,0,0,.12);
      padding: 10px;
    }
    .sideTitle{ font-weight: 800; font-size: 13px; margin-bottom: 8px; color:#0f172a; }
    .sideControls{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom: 8px; }
    .sideField label{ display:block; font-size:11px; font-weight:700; margin-bottom:3px; color:#0f172a; }
    .sideField select{ width:100%; height: 26px; border:1px solid #9aa7b2; font-family: inherit; font-size: 12px; padding: 0 6px; background:#fff; outline:none; }
    .sideHint{ font-size: 11px; color: var(--muted); line-height: 1.35; margin-bottom: 8px; }
    .sideTableWrap{ max-height: 420px; overflow:auto; border: 1px solid #000; background:#fff; }
    table.sideTable{ width:100%; border-collapse: collapse; table-layout: fixed; font-size: 12px; border:0; }
    table.sideTable th, table.sideTable td{ border:1px solid #000; padding: 4px 6px; height: 22px; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    table.sideTable th{ position: sticky; top: 0; background: var(--hdr); z-index: 2; font-weight: 800; text-align:center; }
    table.sideTable td:nth-child(3){ text-align:right; font-weight: 800; }

    /* Modal */
    .hidden{ display:none !important; }
    .backdrop{ position:fixed; inset:0; background: rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; padding:16px; z-index:999; }
    .modal{ width:min(760px, 100%); background:#fff; border:1px solid #cbd5e1; border-radius:10px; overflow:hidden; box-shadow: 0 20px 70px rgba(0,0,0,.35); }
    .modalHead{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#f1f5f9; border-bottom:1px solid #e2e8f0; font-weight:800; }
    .modalBody{ padding:12px; display:grid; gap:10px; }
    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px 12px; }
    .field label{ display:block; font-size:12px; font-weight:700; color:#0f172a; margin-bottom:4px; }
    .field input, .field select{ width:100%; padding:8px 9px; border:1px solid #94a3b8; border-radius:8px; font-family:inherit; font-size:13px; outline:none; }
    .field input:focus, .field select:focus{ border-color: var(--focus); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
    .modalFoot{ display:flex; justify-content:flex-end; gap:10px; padding:10px 12px; border-top:1px solid #e2e8f0; background:#f8fafc; }
    .btn{ border:1px solid #94a3b8; background:#fff; padding:8px 10px; border-radius:8px; font-weight:700; cursor:pointer; }
    .btnPrimary{ border-color: rgba(43,108,176,.9); background: var(--btn); color:#fff; }
    .btnPrimary:hover{ background: var(--btn2); }
    .note{ font-size:12px; color: var(--muted); line-height:1.35; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;topbar&quot;&gt;
    &lt;button class=&quot;btnMenu&quot; onclick=&quot;goMenu()&quot;&gt;🏠 Meniu&lt;/button&gt;

    &lt;button class=&quot;btnAdd&quot; style=&quot;background:#0f766e&quot; onclick=&quot;toggleFilters()&quot;&gt;&lt;span class=&quot;plusCircle&quot; style=&quot;color:#0f766e&quot;&gt;🔎&lt;/span&gt; Filtre&lt;/button&gt;
    &lt;button class=&quot;btnAdd&quot; style=&quot;background:#64748b&quot; onclick=&quot;clearFilters()&quot;&gt;&lt;span class=&quot;plusCircle&quot; style=&quot;color:#64748b&quot;&gt;×&lt;/span&gt; Reset filtre&lt;/button&gt;

    &lt;button class=&quot;btnAdd&quot; style=&quot;background:#334155&quot; onclick=&quot;exportJSON()&quot;&gt;&lt;span class=&quot;plusCircle&quot; style=&quot;color:#334155&quot;&gt;⤓&lt;/span&gt; Export JSON&lt;/button&gt;
    &lt;button class=&quot;btnAdd&quot; style=&quot;background:#334155&quot; onclick=&quot;importJSON()&quot;&gt;&lt;span class=&quot;plusCircle&quot; style=&quot;color:#334155&quot;&gt;⤒&lt;/span&gt; Import JSON&lt;/button&gt;
    &lt;input id=&quot;fileImport&quot; type=&quot;file&quot; accept=&quot;application/json&quot; style=&quot;display:none&quot; /&gt;

    &lt;button class=&quot;btnAdd&quot; style=&quot;background:#1f2937&quot; onclick=&quot;exportXLSX()&quot;&gt;&lt;span class=&quot;plusCircle&quot; style=&quot;color:#1f2937&quot;&gt;⤓&lt;/span&gt; Export Excel&lt;/button&gt;
    &lt;button class=&quot;btnAdd&quot; style=&quot;background:#1f2937&quot; onclick=&quot;importXLSX()&quot;&gt;&lt;span class=&quot;plusCircle&quot; style=&quot;color:#1f2937&quot;&gt;⤒&lt;/span&gt; Import Excel&lt;/button&gt;
    &lt;input id=&quot;fileImportXLSX&quot; type=&quot;file&quot; accept=&quot;.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot; style=&quot;display:none&quot; /&gt;

    &lt;button class=&quot;btnAdd&quot; onclick=&quot;openForm()&quot;&gt;&lt;span class=&quot;plusCircle&quot;&gt;+&lt;/span&gt; Adaugă&lt;/button&gt;
  &lt;/div&gt;

  &lt;div id=&quot;storageBanner&quot;&gt;
    Atenție: Browserul a blocat salvarea automată (localStorage) pentru fișiere locale. Datele NU vor rămâne după închidere.
    Folosește &lt;b&gt;Export JSON&lt;/b&gt; pentru a salva.
  &lt;/div&gt;

  &lt;div class=&quot;sheet&quot;&gt;
    &lt;div class=&quot;sheetGrid&quot;&gt;
      &lt;div class=&quot;tableWrap&quot; id=&quot;tableWrap&quot;&gt;
        &lt;table id=&quot;tbl&quot;&gt;
          &lt;colgroup&gt;
            &lt;col class=&quot;cAn&quot;&gt;&lt;col class=&quot;cLuna&quot;&gt;&lt;col class=&quot;cData&quot;&gt;&lt;col class=&quot;cDim&quot;&gt;&lt;col class=&quot;cCal&quot;&gt;
            &lt;col class=&quot;cPrem&quot;&gt;&lt;col class=&quot;cCat&quot;&gt;&lt;col class=&quot;cKg&quot;&gt;&lt;col class=&quot;cPre&quot;&gt;&lt;col class=&quot;cFurn&quot;&gt;
          &lt;/colgroup&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;Anul&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;LUNA&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;Data Intrare&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;Dimensiune Otel&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;Calitate otel&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;Cod intern otel (3 litere)&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;Sarja material (furnizor)&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;Cantitate (kg)&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;PRETEST&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
              &lt;th&gt;Furnizor&lt;div class=&quot;filter&quot; title=&quot;Filtru&quot;&gt;&lt;/div&gt;&lt;/th&gt;
            &lt;/tr&gt;
            &lt;tr id=&quot;filterRow&quot;&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;0&quot; placeholder=&quot;An&quot; /&gt;&lt;/th&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;1&quot; placeholder=&quot;Luna&quot; /&gt;&lt;/th&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;2&quot; placeholder=&quot;Data&quot; /&gt;&lt;/th&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;3&quot; placeholder=&quot;Dim&quot; /&gt;&lt;/th&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;4&quot; placeholder=&quot;Calitate&quot; /&gt;&lt;/th&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;5&quot; placeholder=&quot;Cod intern&quot; /&gt;&lt;/th&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;6&quot; placeholder=&quot;Sarja&quot; /&gt;&lt;/th&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;7&quot; placeholder=&quot;kg&quot; /&gt;&lt;/th&gt;
              &lt;th&gt;
                &lt;select class=&quot;filtSelect&quot; data-col=&quot;8&quot;&gt;
                  &lt;option value=&quot;&quot;&gt;(toate)&lt;/option&gt;
                  &lt;option value=&quot;Are pretest&quot;&gt;Are pretest&lt;/option&gt;
                  &lt;option value=&quot;Nu are pretest&quot;&gt;Nu are pretest&lt;/option&gt;
                &lt;/select&gt;
              &lt;/th&gt;
              &lt;th&gt;&lt;input class=&quot;filt&quot; data-col=&quot;9&quot; placeholder=&quot;Furnizor&quot; /&gt;&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody id=&quot;tbody&quot;&gt;
            &lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;td class=&quot;editableCell&quot; contenteditable=&quot;true&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
          &lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/div&gt;

      &lt;div class=&quot;sidePanel&quot;&gt;
        &lt;div class=&quot;sideCard&quot;&gt;
          &lt;div class=&quot;sideTitle&quot;&gt;Total intrări pe Diametru + Calitate&lt;/div&gt;
          &lt;div class=&quot;sideControls&quot;&gt;
            &lt;div class=&quot;sideField&quot;&gt;
              &lt;label&gt;An&lt;/label&gt;
              &lt;select id=&quot;sumYear&quot;&gt;&lt;/select&gt;
            &lt;/div&gt;
            &lt;div class=&quot;sideField&quot;&gt;
              &lt;label&gt;Lună&lt;/label&gt;
              &lt;select id=&quot;sumMonth&quot;&gt;&lt;/select&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;div class=&quot;sideHint&quot;&gt;Suma &lt;b&gt;Cantitate (kg)&lt;/b&gt; pe combinația &lt;b&gt;Diametru&lt;/b&gt; + &lt;b&gt;Calitate&lt;/b&gt;, filtrat pe anul și luna selectate.&lt;/div&gt;
          &lt;div class=&quot;sideTableWrap&quot;&gt;
            &lt;table class=&quot;sideTable&quot; id=&quot;sumTable&quot;&gt;
              &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Diametru&lt;/th&gt;&lt;th&gt;Calitate&lt;/th&gt;&lt;th&gt;Total kg&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
              &lt;tbody id=&quot;sumTbody&quot;&gt;&lt;/tbody&gt;
            &lt;/table&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;datalist id=&quot;gradeList&quot;&gt;
    &lt;option value=&quot;1E-1287/15B34&quot;&gt;&lt;/option&gt;&lt;option value=&quot;1E1239G&quot;&gt;&lt;/option&gt;&lt;option value=&quot;1E0361 (C-45)&quot;&gt;&lt;/option&gt;&lt;option value=&quot;C35&quot;&gt;&lt;/option&gt;&lt;option value=&quot;C45&quot;&gt;&lt;/option&gt;&lt;option value=&quot;30MnVS6&quot;&gt;&lt;/option&gt;&lt;option value=&quot;S-355&quot;&gt;&lt;/option&gt;&lt;option value=&quot;C25&quot;&gt;&lt;/option&gt;&lt;option value=&quot;1E-0042&quot;&gt;&lt;/option&gt;&lt;option value=&quot;16MnCr05&quot;&gt;&lt;/option&gt;&lt;option value=&quot;C60&quot;&gt;&lt;/option&gt;&lt;option value=&quot;1E-1497&quot;&gt;&lt;/option&gt;&lt;option value=&quot;1E0621/15B22&quot;&gt;&lt;/option&gt;&lt;option value=&quot;1E0509&quot;&gt;&lt;/option&gt;&lt;option value=&quot;30CrNiMo8&quot;&gt;&lt;/option&gt;&lt;option value=&quot;1E4808&quot;&gt;&lt;/option&gt;
  &lt;/datalist&gt;
  &lt;datalist id=&quot;diamList&quot;&gt;&lt;/datalist&gt;


  &lt;datalist id=&quot;codeList&quot;&gt;&lt;/datalist&gt;

  &lt;div id=&quot;backdrop&quot; class=&quot;backdrop hidden&quot; role=&quot;dialog&quot; aria-modal=&quot;true&quot;&gt;
    &lt;div class=&quot;modal&quot;&gt;
      &lt;div class=&quot;modalHead&quot;&gt;
        &lt;div&gt;Adaugă intrare oțel&lt;/div&gt;
        &lt;button class=&quot;btn&quot; onclick=&quot;closeForm()&quot; type=&quot;button&quot;&gt;✕&lt;/button&gt;
      &lt;/div&gt;

      &lt;div class=&quot;modalBody&quot;&gt;
        &lt;div class=&quot;grid&quot;&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Anul&lt;/label&gt;
            &lt;input id=&quot;fAn&quot; type=&quot;number&quot; min=&quot;2000&quot; max=&quot;2100&quot; /&gt;
          &lt;/div&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Luna&lt;/label&gt;
            &lt;select id=&quot;fLuna&quot;&gt;
              &lt;option value=&quot;&quot;&gt;—&lt;/option&gt;
              &lt;option value=&quot;Ianuarie&quot;&gt;Ianuarie&lt;/option&gt;&lt;option value=&quot;Februarie&quot;&gt;Februarie&lt;/option&gt;&lt;option value=&quot;Martie&quot;&gt;Martie&lt;/option&gt;&lt;option value=&quot;Aprilie&quot;&gt;Aprilie&lt;/option&gt;&lt;option value=&quot;Mai&quot;&gt;Mai&lt;/option&gt;&lt;option value=&quot;Iunie&quot;&gt;Iunie&lt;/option&gt;&lt;option value=&quot;Iulie&quot;&gt;Iulie&lt;/option&gt;&lt;option value=&quot;August&quot;&gt;August&lt;/option&gt;&lt;option value=&quot;Septembrie&quot;&gt;Septembrie&lt;/option&gt;&lt;option value=&quot;Octombrie&quot;&gt;Octombrie&lt;/option&gt;&lt;option value=&quot;Noiembrie&quot;&gt;Noiembrie&lt;/option&gt;&lt;option value=&quot;Decembrie&quot;&gt;Decembrie&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;

          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Data intrare&lt;/label&gt;
            &lt;input id=&quot;fData&quot; type=&quot;date&quot; /&gt;
          &lt;/div&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Dimensiune oțel&lt;/label&gt;
            &lt;input id=&quot;fDim&quot; list=&quot;diamList&quot; placeholder=&quot;ex: Ø30 / 30mm&quot; /&gt;
          &lt;/div&gt;

          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Calitate oțel&lt;/label&gt;
            &lt;input id=&quot;fCal&quot; list=&quot;gradeList&quot; placeholder=&quot;alege din listă sau scrie&quot; /&gt;
          &lt;/div&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Cod intern otel (3 litere)&lt;/label&gt;
            &lt;input id=&quot;fPrem&quot; list=&quot;codeList&quot; placeholder=&quot;ex: NNN&quot; /&gt;
          &lt;/div&gt;

          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Sarja material (furnizor)&lt;/label&gt;
            &lt;input id=&quot;fCat&quot; placeholder=&quot;ex: 123456&quot; /&gt;
          &lt;/div&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Cantitate (kg)&lt;/label&gt;
            &lt;input id=&quot;fKg&quot; type=&quot;number&quot; min=&quot;0&quot; step=&quot;0.01&quot; /&gt;
          &lt;/div&gt;

          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Pretest&lt;/label&gt;
            &lt;select id=&quot;fPre&quot;&gt;
              &lt;option value=&quot;&quot;&gt;—&lt;/option&gt;
              &lt;option value=&quot;Are pretest&quot;&gt;Are pretest&lt;/option&gt;
              &lt;option value=&quot;Nu are pretest&quot;&gt;Nu are pretest&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;

          &lt;div class=&quot;field&quot;&gt;
            &lt;label&gt;Furnizor&lt;/label&gt;
            &lt;select id=&quot;fFurn&quot;&gt;
              &lt;option value=&quot;&quot;&gt;—&lt;/option&gt;
              &lt;option value=&quot;Cognor&quot;&gt;Cognor&lt;/option&gt;
              &lt;option value=&quot;ArcelorMittal&quot;&gt;ArcelorMittal&lt;/option&gt;
              &lt;option value=&quot;Altul&quot;&gt;Altul&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;

          &lt;div class=&quot;field&quot; id=&quot;furnOtherWrap&quot; style=&quot;display:none&quot;&gt;
            &lt;label&gt;Furnizor (Altul)&lt;/label&gt;
            &lt;input id=&quot;fFurnOther&quot; placeholder=&quot;scrie furnizorul&quot; /&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;note&quot;&gt;Formularul &lt;b&gt;nu se închide&lt;/b&gt; după salvare. Îl închizi manual.&lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;modalFoot&quot;&gt;
        &lt;button class=&quot;btn&quot; type=&quot;button&quot; onclick=&quot;closeForm()&quot;&gt;Anulează&lt;/button&gt;
        &lt;button class=&quot;btn btnPrimary&quot; type=&quot;button&quot; onclick=&quot;saveRow()&quot;&gt;Salvează&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

&lt;script&gt;
  const MONTHS = [&#x27;ianuarie&#x27;, &#x27;februarie&#x27;, &#x27;martie&#x27;, &#x27;aprilie&#x27;, &#x27;mai&#x27;, &#x27;iunie&#x27;, &#x27;iulie&#x27;, &#x27;august&#x27;, &#x27;septembrie&#x27;, &#x27;octombrie&#x27;, &#x27;noiembrie&#x27;, &#x27;decembrie&#x27;];

  function capMonth(m){
    if(!m) return m;
    return m.charAt(0).toUpperCase() + m.slice(1);
  }

  
  // --- HELPER lists (editabile în pagina HELPER) ---
  const HELPERS_KEY = &quot;RF_HELPERS_v1&quot;;
  function getHelpersSafe(){
    try{ return JSON.parse(localStorage.getItem(HELPERS_KEY) || &quot;{}&quot;) || {}; }catch(e){ return {}; }
  }
  function setDatalistOptions(id, values){
    const dl = document.getElementById(id);
    if (!dl) return;
    const seen = new Set();
    const opts = [];
    (values || []).forEach(v =&gt; {
      const s = (v ?? &quot;&quot;).toString().trim();
      if (!s || seen.has(s)) return;
      seen.add(s);
      opts.push(`&lt;option value=&quot;${s.replace(/&quot;/g,&#x27;&amp;quot;&#x27;)}&quot;&gt;&lt;/option&gt;`);
    });
    dl.innerHTML = opts.join(&quot;&quot;);
  }
  function refreshHelperDatalists(){
    const h = getHelpersSafe();
    if (Array.isArray(h.lista_calitati) &amp;&amp; h.lista_calitati.length){
      setDatalistOptions(&quot;gradeList&quot;, h.lista_calitati);
    }
    if (Array.isArray(h.lista_diametre) &amp;&amp; h.lista_diametre.length){
      setDatalistOptions(&quot;diamList&quot;, h.lista_diametre.map(x =&gt; x.toString()));
    }
  }
  window.addEventListener(&quot;message&quot;, (e) =&gt; {
    if (e &amp;&amp; e.data &amp;&amp; e.data.type === &quot;HELPERS_UPDATED&quot;){
      refreshHelperDatalists();
    }
  });

function goMenu(){
    parent.showPage(&quot;dashboard&quot;);
  }

  const backdrop = document.getElementById(&#x27;backdrop&#x27;);

  function openForm(){
    const d = new Date();
    document.getElementById(&#x27;fAn&#x27;).value = d.getFullYear();
    document.getElementById(&#x27;fData&#x27;).valueAsDate = d;
    refreshHelperDatalists();
    refreshCodeList();
    backdrop.classList.remove(&#x27;hidden&#x27;);
    setTimeout(() =&gt; document.getElementById(&#x27;fLuna&#x27;).focus(), 0);
  }

  function closeForm(){
    backdrop.classList.add(&#x27;hidden&#x27;);
  }

  // --- COD INTERN: preluare listă din NUMERALKOD (localStorage comun) ---
  const NUMERALKOD_KEY = &quot;NUMERALKOD_autosave_v1&quot;;
  const CODE_ALLOWED = &quot;NUMERALKOD&quot;; // litere permise

  function refreshCodeList(){
    const dl = document.getElementById(&#x27;codeList&#x27;);
    if (!dl) return;

    const codes = new Set();
    try{
      const map = buildMarcajIndex();
      for (const k of map.keys()) codes.add(k);
    }catch(e){}

    dl.innerHTML = Array.from(codes).sort().map(c =&gt; `&lt;option value=&quot;${c}&quot;&gt;&lt;/option&gt;`).join(&#x27;&#x27;);
  }

  function normalizeCodIntern(s){
    return (s || &quot;&quot;).toString().trim().toUpperCase().replace(/\s+/g, &quot;&quot;);
  }

  function isValidCodIntern(cod){
    if (!cod || cod.length !== 3) return false;
    for (const ch of cod){
      if (!CODE_ALLOWED.includes(ch)) return false;
    }
    return true;
  }


  // --- AUTO-FILL din NUMERALKOD pentru Cod intern (MARCAJ SARJA) ---
  const NK_LETTERS = [&#x27;N&#x27;,&#x27;U&#x27;,&#x27;M&#x27;,&#x27;E&#x27;,&#x27;R&#x27;,&#x27;A&#x27;,&#x27;L&#x27;,&#x27;K&#x27;,&#x27;O&#x27;,&#x27;D&#x27;];

  function nkPrefixForSeries(series){
    const m = (series || &#x27;&#x27;).toString().trim().toUpperCase().match(/^([A-Z])(\d{1,2})$/);
    if (!m) return &#x27;&#x27;;
    const first = m[1];
    const idx = Number(m[2]);
    if (!(idx &gt;= 1 &amp;&amp; idx &lt;= 10)) return &#x27;&#x27;;
    if (!NK_LETTERS.includes(first)) return &#x27;&#x27;;
    return first + NK_LETTERS[idx-1];
  }

  function loadNumeralkodState(){
  try{
    const raw = localStorage.getItem(NUMERALKOD_KEY);
    if (!raw) return {zale:[], alte:[], rez:[]};
    const obj = JSON.parse(raw);

    // format nou (unele versiuni): {zale:[], alte:[], rez:[]}
    if (obj &amp;&amp; (Array.isArray(obj.zale) || Array.isArray(obj.alte) || Array.isArray(obj.rez))){
      return {
        zale: Array.isArray(obj.zale) ? obj.zale : [],
        alte: Array.isArray(obj.alte) ? obj.alte : [],
        rez:  Array.isArray(obj.rez)  ? obj.rez  : []
      };
    }

    // format curent NUMERALKOD v2: {tables:[{group,series,rows}], reserved:[...]}
    if (obj &amp;&amp; Array.isArray(obj.tables)){
      const tables = obj.tables;

      // detect: tabele &quot;flat&quot; cu group/series (v2)
      const hasGroup = tables.some(t =&gt; t &amp;&amp; typeof t === &#x27;object&#x27; &amp;&amp; (&#x27;group&#x27; in t) &amp;&amp; (&#x27;series&#x27; in t));
      if (hasGroup){
        const zale = tables
          .filter(t =&gt; (t &amp;&amp; (t.group||&#x27;&#x27;).toString().toLowerCase() === &#x27;zale&#x27;))
          .map(t =&gt; ({ series: (t.series||&#x27;&#x27;).toString(), rows: Array.isArray(t.rows) ? t.rows : [] }));
        const alte = tables
          .filter(t =&gt; (t &amp;&amp; (t.group||&#x27;&#x27;).toString().toLowerCase() === &#x27;alte&#x27;))
          .map(t =&gt; ({ series: (t.series||&#x27;&#x27;).toString(), rows: Array.isArray(t.rows) ? t.rows : [] }));

        const rezSrc = Array.isArray(obj.reserved) ? obj.reserved : (Array.isArray(obj.rez) ? obj.rez : []);
        const rez = rezSrc.map(r =&gt; ({
          marcaj: (r &amp;&amp; (r.marcaj || r.code)) ? (r.marcaj || r.code) : &#x27;&#x27;,
          dim:    (r &amp;&amp; r.dim)   ? r.dim   : &#x27;&#x27;,
          grade:  (r &amp;&amp; (r.grade || r.cal)) ? (r.grade || r.cal) : &#x27;&#x27;,
          sarja:  (r &amp;&amp; r.sarja) ? r.sarja : &#x27;&#x27;,
          reper:  (r &amp;&amp; r.reper) ? r.reper : &#x27;&#x27;
        }));
        return {zale, alte, rez};
      }

      // format vechi (fallback): {tables:[{name/title, rows:[seriesObj]}]}
      const zaleT = tables.find(t =&gt; /zale/i.test(t.name || t.title || &#x27;&#x27;)) || tables[0];
      const alteT = tables.find(t =&gt; /alte/i.test(t.name || t.title || &#x27;&#x27;)) || tables[1];
      const rezT  = tables.find(t =&gt; /rez/i.test(t.name || t.title || &#x27;&#x27;))  || tables[2];
      return {
        zale: Array.isArray(zaleT &amp;&amp; zaleT.rows) ? zaleT.rows : [],
        alte: Array.isArray(alteT &amp;&amp; alteT.rows) ? alteT.rows : [],
        rez:  Array.isArray(rezT  &amp;&amp; rezT.rows)  ? rezT.rows  : []
      };
    }

    // alternative: reserved separat fără tables
    if (obj &amp;&amp; Array.isArray(obj.reserved)){
      return {zale:[], alte:[], rez: obj.reserved};
    }
  }catch(e){}
  return {zale:[], alte:[], rez:[]};
}function buildMarcajIndex(){
    const st = loadNumeralkodState();
    const idx = new Map();

    function put(code, payload){
      const c = normalizeCodIntern(code);
      if (!c) return;
      if (!idx.has(c)) idx.set(c, payload);
    }

    function ingestGroup(groupArr, source){
      (groupArr || []).forEach(function(serieObj){
        const series = (serieObj &amp;&amp; (serieObj.series || serieObj.SERIA || serieObj.seria)) ? (serieObj.series || serieObj.SERIA || serieObj.seria) : &#x27;&#x27;;
        const pref = nkPrefixForSeries(series);
        if (!pref) return;

        const rows = Array.isArray(serieObj.rows) ? serieObj.rows : [];
        for (let r=0; r &lt; NK_LETTERS.length; r++){
          const code = pref + NK_LETTERS[r];
          const row = rows[r] || {};
          put(code, {dim: (row.dim || &#x27;&#x27;), grade: (row.grade || &#x27;&#x27;), sarja: (row.sarja || &#x27;&#x27;), source: source});
        }
      });
    }

    ingestGroup(st.zale, &#x27;NUMERALKOD zale&#x27;);
    ingestGroup(st.alte, &#x27;NUMERALKOD alte repere&#x27;);

    // REZERVAT: poate completa/suprascrie câmpurile (dacă sunt completate)
    (st.rez || []).forEach(function(r){
      const code = normalizeCodIntern((r &amp;&amp; (r.marcaj || r.code)) ? (r.marcaj || r.code) : &#x27;&#x27;);
      if (!code) return;
      const existing = idx.get(code) || {dim:&#x27;&#x27;, grade:&#x27;&#x27;, sarja:&#x27;&#x27;, source:&#x27;&#x27;};
      idx.set(code, {
        dim: (r.dim || existing.dim || &#x27;&#x27;),
        grade: (r.grade || existing.grade || &#x27;&#x27;),
        sarja: (r.sarja || existing.sarja || &#x27;&#x27;),
        source: &#x27;NUMERALKOD rezervat&#x27;
      });
    });

    return idx;
  }

  function applyAutoFillFromCodIntern(){
    const inp = document.getElementById(&#x27;fPrem&#x27;);
    if (!inp) return;

    const code = normalizeCodIntern(inp.value);
    inp.value = code;
    if (!isValidCodIntern(code)) return;

    const map = buildMarcajIndex();
    const hit = map.get(code);
    if (!hit) return;

    const fDim = document.getElementById(&#x27;fDim&#x27;);
    const fCal = document.getElementById(&#x27;fCal&#x27;);
    const fCat = document.getElementById(&#x27;fCat&#x27;); // Sarja material (furnizor)

    if (fDim) fDim.value = (hit.dim || &#x27;&#x27;).toString();
    if (fCal) fCal.value = (hit.grade || &#x27;&#x27;).toString();
    if (fCat) fCat.value = (hit.sarja || &#x27;&#x27;).toString();
  }

  (function wireCodInternAutoFill(){
    const inp = document.getElementById(&#x27;fPrem&#x27;);
    if (!inp) return;

    inp.addEventListener(&#x27;input&#x27;, function(){
      const code = normalizeCodIntern(inp.value);
      inp.value = code;
      if (code.length === 3) applyAutoFillFromCodIntern();
    });

    inp.addEventListener(&#x27;change&#x27;, applyAutoFillFromCodIntern);
    inp.addEventListener(&#x27;blur&#x27;, applyAutoFillFromCodIntern);
  })();

  backdrop.addEventListener(&#x27;click&#x27;, (e) =&gt; {
    if (e.target === backdrop) closeForm();
  });

  document.addEventListener(&#x27;keydown&#x27;, (e) =&gt; {
    if (!backdrop.classList.contains(&#x27;hidden&#x27;) &amp;&amp; e.key === &#x27;Escape&#x27;) closeForm();
  });

  function onFurnChange(){
    const sel = document.getElementById(&#x27;fFurn&#x27;);
    const wrap = document.getElementById(&#x27;furnOtherWrap&#x27;);
    if (!sel || !wrap) return;
    const v = (sel.value || &#x27;&#x27;).toLowerCase();
    wrap.style.display = (v === &#x27;altul&#x27;) ? &#x27;&#x27; : &#x27;none&#x27;;
  }
  (function(){
    const sel = document.getElementById(&#x27;fFurn&#x27;);
    if (sel){
      sel.addEventListener(&#x27;change&#x27;, onFurnChange);
      onFurnChange();
    }
  })();

  // normalizare live pentru Cod intern
  (function(){
    const inp = document.getElementById(&#x27;fPrem&#x27;);
    if (!inp) return;
    inp.addEventListener(&#x27;blur&#x27;, () =&gt; { inp.value = normalizeCodIntern(inp.value); });
  })();

  // ----- FILTRARE -----
  const filterRow = document.getElementById(&#x27;filterRow&#x27;);
  let filtersVisible = true;

  function getCellText(td){ return (td?.textContent || &quot;&quot;).trim().toLowerCase(); }

  function applyFilters(){
    const tbody = document.getElementById(&#x27;tbody&#x27;);
    const rows = Array.from(tbody.querySelectorAll(&#x27;tr&#x27;));
    const textFilters = Array.from(document.querySelectorAll(&#x27;#filterRow input.filt&#x27;))
      .map(inp =&gt; ({col: Number(inp.dataset.col), val: inp.value.trim().toLowerCase()}));
    const pretestSel = document.querySelector(&#x27;#filterRow select.filtSelect&#x27;);
    const pretestVal = (pretestSel?.value || &quot;&quot;).trim().toLowerCase();

    rows.forEach(tr =&gt; {
      const tds = tr.querySelectorAll(&#x27;td&#x27;);
      const anyFilter = textFilters.some(f=&gt;f.val.length) || pretestVal.length;
      const rowAllEmpty = Array.from(tds).every(td =&gt; getCellText(td) === &quot;&quot;);
      if (anyFilter &amp;&amp; rowAllEmpty){ tr.style.display = &quot;none&quot;; return; }

      let ok = true;
      for (const f of textFilters){
        if (!f.val) continue;
        const cell = getCellText(tds[f.col]);
        if (!cell.includes(f.val)){ ok = false; break; }
      }
      if (ok &amp;&amp; pretestVal){
        const cell = getCellText(tds[8]);
        if (cell !== pretestVal) ok = false;
      }
      tr.style.display = ok ? &quot;&quot; : &quot;none&quot;;
    });
  }

  function toggleFilters(){
    filtersVisible = !filtersVisible;
    filterRow.style.display = filtersVisible ? &quot;&quot; : &quot;none&quot;;
  }

  function clearFilters(){
    document.querySelectorAll(&#x27;#filterRow input.filt&#x27;).forEach(inp =&gt; inp.value = &quot;&quot;);
    const sel = document.querySelector(&#x27;#filterRow select.filtSelect&#x27;);
    if (sel) sel.value = &quot;&quot;;
    applyFilters();
  }

  document.querySelectorAll(&#x27;#filterRow input.filt&#x27;).forEach(inp =&gt; inp.addEventListener(&#x27;input&#x27;, applyFilters));
  const selF = document.querySelector(&#x27;#filterRow select.filtSelect&#x27;);
  if (selF) selF.addEventListener(&#x27;change&#x27;, applyFilters);

  (function wireHeaderFilters(){
    const headerThs = document.querySelectorAll(&#x27;thead tr:first-child th&#x27;);
    headerThs.forEach((th, idx) =&gt; {
      const f = th.querySelector(&#x27;.filter&#x27;);
      if (!f) return;
      f.style.cursor = &quot;pointer&quot;;
      f.addEventListener(&#x27;click&#x27;, () =&gt; {
        filtersVisible = true;
        filterRow.style.display = &quot;&quot;;
        const target = filterRow.querySelector(`[data-col=&quot;${idx}&quot;]`);
        if (target) target.focus();
      });
    });
  })();

  // ----- EXPORT / IMPORT JSON -----
  function getTableData(){
    const tbody = document.getElementById(&#x27;tbody&#x27;);
    const rows = Array.from(tbody.querySelectorAll(&#x27;tr&#x27;));
    const data = [];
    rows.forEach(tr =&gt; {
      const tds = Array.from(tr.querySelectorAll(&#x27;td&#x27;));
      if (tds.length &lt; 10) return;
      const vals = tds.slice(0,10).map(td =&gt; (td.textContent || &quot;&quot;).trim());
      const any = vals.some(v =&gt; v !== &quot;&quot;);
      if (any) data.push(vals);
    });
    return data;
  }

  function rebuildTbody(withBlankRows = 30){
    const tbody = document.getElementById(&#x27;tbody&#x27;);
    tbody.innerHTML = &quot;&quot;;
    for (let r=0; r&lt;withBlankRows; r++){ 
      const tr = document.createElement(&#x27;tr&#x27;);
      for (let c=0; c&lt;10; c++){ 
        const td = document.createElement(&#x27;td&#x27;);
        td.className = &#x27;editableCell&#x27;;
        td.contentEditable = &#x27;true&#x27;;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  function fillTopDown(dataRows){
    const tbody = document.getElementById(&#x27;tbody&#x27;);
    const rows = Array.from(tbody.querySelectorAll(&#x27;tr&#x27;));
    dataRows.forEach((vals, i) =&gt; {
      if (i &gt;= rows.length){
        const tr = document.createElement(&#x27;tr&#x27;);
        for (let c=0; c&lt;10; c++){ 
          const td = document.createElement(&#x27;td&#x27;);
          td.className = &#x27;editableCell&#x27;;
          td.contentEditable = &#x27;true&#x27;;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
        rows.push(tr);
      }
      const tds = rows[i].querySelectorAll(&#x27;td&#x27;);
      for (let c=0; c&lt;10; c++) tds[c].textContent = (c === 2) ? toDisplayDate(vals[c]) : (vals[c] ?? &quot;&quot;).toString();
    });
  }

  function exportJSON(){
    const payload = {
      app: &quot;INTRARI_OTEL&quot;,
      version: 1,
      exportedAt: new Date().toISOString(),
      rows: getTableData()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:&quot;application/json&quot;});
    const url = URL.createObjectURL(blob);
    const a = document.createElement(&quot;a&quot;);
    a.href = url;
    a.download = &quot;INTRARI_OTEL_data.json&quot;;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(){
    const input = document.getElementById(&#x27;fileImport&#x27;);
    if (!input) return;
    input.click();
  }

  (function wireImport(){
    const input = document.getElementById(&#x27;fileImport&#x27;);
    if (!input) return;
    input.addEventListener(&#x27;change&#x27;, async (e) =&gt; {
      const f = e.target.files &amp;&amp; e.target.files[0];
      if (!f) return;
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if (!obj || !Array.isArray(obj.rows)) throw new Error(&quot;Fișier JSON invalid (lipsește &#x27;rows&#x27;).&quot;);

        const needed = Math.max(30, obj.rows.length + 5);
        rebuildTbody(needed);
        fillTopDown(obj.rows);

        applyFilters();
        notifyDataChanged();
        autoSaveNow();

      }catch(err){
        alert(&quot;Nu am putut importa: &quot; + (err?.message || err));
      }finally{
        e.target.value = &quot;&quot;;
      }
    });
  })();

  
  // ----- EXPORT / IMPORT EXCEL (.xlsx) -----
  function loadScriptOnce(src){
    return new Promise((resolve, reject) =&gt; {
      const existing = Array.from(document.querySelectorAll(&quot;script&quot;)).some(s =&gt; s.src &amp;&amp; s.src.includes(src));
      if (existing) return resolve();
      const s = document.createElement(&quot;script&quot;);
      s.src = src;
      s.async = true;
      s.onload = () =&gt; resolve();
      s.onerror = () =&gt; reject(new Error(&quot;Nu pot încărca script: &quot; + src));
      document.head.appendChild(s);
    });
  }

  async function ensureXLSX(){
    if (window.XLSX) return true;

    // 1) încearcă local (pune xlsx.full.min.js în același folder cu acest HTML)
    try{
      await loadScriptOnce(new URL(&quot;xlsx.full.min.js&quot;, (parent.location.href.split(&quot;#&quot;)[0].split(&quot;?&quot;)[0])).href);
      if (window.XLSX) return true;
    }catch(e){ /* ignore */ }

    // 2) fallback CDN (dacă ai internet)
    try{
      await loadScriptOnce(&quot;https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js&quot;);
      if (window.XLSX) return true;
    }catch(e){ /* ignore */ }

    alert(&quot;Lipsă suport Excel. Soluție offline: descarcă &#x27;xlsx.full.min.js&#x27; (SheetJS) și pune-l în același folder cu HTML-ul, apoi reîncarcă pagina.&quot;);
    return false;
  }

  function normalizeHeader(h){
    return (h ?? &quot;&quot;)
      .toString()
      .trim()
      .toLowerCase()
      .normalize(&quot;NFD&quot;).replace(/[\u0300-\u036f]/g, &quot;&quot;)
      .replace(/\s+/g, &quot; &quot;)
      .replace(/[()]/g, &quot;&quot;)
      .replace(/[^a-z0-9 +]/g, &quot;&quot;);
  }

  function toDisplayDate(v){
    const s = (v ?? &#x27;&#x27;).toString().trim();
    if (!s) return &#x27;&#x27;;
    if (/^\d{2}\.\d{2}\.\d{4}$/.test(s)) return s;
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const parts = s.split(&#x27;-&#x27;);
      return parts[2] + &#x27;.&#x27; + parts[1] + &#x27;.&#x27; + parts[0];
    }

    // dd.mm.yyyy / dd/mm/yyyy / dd-mm-yyyy
    let m = s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{4})$/);
    if (m){
      const dd = m[1].padStart(2, &#x27;0&#x27;);
      const mm = m[2].padStart(2, &#x27;0&#x27;);
      const yy = m[3];
      return dd + &#x27;.&#x27; + mm + &#x27;.&#x27; + yy;
    }

    // try Date parse
    const d = new Date(s);
    if (!isNaN(d.getTime())){
      const dd = String(d.getDate()).padStart(2, &#x27;0&#x27;);
      const mm = String(d.getMonth()+1).padStart(2, &#x27;0&#x27;);
      const yy = String(d.getFullYear());
      return dd + &#x27;.&#x27; + mm + &#x27;.&#x27; + yy;
    }
    return s; // last resort
  }

  function normalizeDate(v){
    return toDisplayDate(v);
  }

  function normalizeCodIntern(v){
    return (v ?? &quot;&quot;).toString().toUpperCase().replace(/[^A-Z]/g,&quot;&quot;).slice(0,3);
  }

  function normalizeDiametru(v){
    const s = (v ?? &quot;&quot;).toString().trim();
    if (!s) return &quot;&quot;;
    const m = s.match(/(\d+(?:[.,]\d+)?)/);
    return m ? m[1].replace(&quot;,&quot;, &quot;.&quot;) : s;
  }

  function normalizeKg(v){
    const s = (v ?? &quot;&quot;).toString().trim();
    if (!s) return &quot;&quot;;
    return s.replace(&quot;,&quot;, &quot;.&quot;);
  }

  function normalizePretest(v){
    const s = (v ?? &quot;&quot;).toString().trim().toLowerCase();
    if (!s) return &quot;Nu are pretest&quot;;
    if (s === &quot;are pretest&quot;) return &quot;Are pretest&quot;;
    if (s === &quot;nu are pretest&quot;) return &quot;Nu are pretest&quot;;
    if (s.includes(&quot;are&quot;)) return &quot;Are pretest&quot;;
    if (s === &quot;1&quot; || s === &quot;da&quot; || s === &quot;yes&quot; || s === &quot;true&quot;) return &quot;Are pretest&quot;;
    return &quot;Nu are pretest&quot;;
  }

  function exportXLSX(){
    ensureXLSX().then(ok =&gt; {
      if (!ok) return;
      const headers = [&quot;Anul&quot;,&quot;LUNA&quot;,&quot;Data Intrare&quot;,&quot;Dimensiune Otel&quot;,&quot;Calitate otel&quot;,&quot;Cod intern otel (3 litere)&quot;,&quot;Sarja material (furnizor)&quot;,&quot;Cantitate in KG&quot;,&quot;PRETEST&quot;,&quot;Furnizor&quot;];
      const data = getTableData();
      const aoa = [headers, ...data];

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      // nice column widths
      ws[&quot;!cols&quot;] = [{wch:8},{wch:12},{wch:14},{wch:16},{wch:16},{wch:22},{wch:26},{wch:16},{wch:14},{wch:18}];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, &quot;INTRARI_OTEL&quot;);
      const name = `INTRARI_OTEL_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, name);
    });
  }

  function importXLSX(){
    const input = document.getElementById(&quot;fileImportXLSX&quot;);
    if (!input) return;
    input.click();
  }

  (function wireImportXLSX(){
    const input = document.getElementById(&quot;fileImportXLSX&quot;);
    if (!input) return;

    input.addEventListener(&quot;change&quot;, async (e) =&gt; {
      const f = e.target.files &amp;&amp; e.target.files[0];
      if (!f) return;

      try{
        const ok = await ensureXLSX();
        if (!ok) return;

        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {type:&quot;array&quot;});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:&quot;&quot;});

        if (!aoa || aoa.length === 0) throw new Error(&quot;Fișier Excel gol.&quot;);

        // detect header row (first non-empty row)
        let headerRowIndex = -1;
        for (let i=0;i&lt;Math.min(10, aoa.length);i++){
          const row = aoa[i].map(x =&gt; (x ?? &quot;&quot;).toString().trim());
          if (row.some(x =&gt; x !== &quot;&quot;)){
            headerRowIndex = i;
            break;
          }
        }
        if (headerRowIndex === -1) throw new Error(&quot;Nu găsesc date în Excel.&quot;);

        const header = (aoa[headerRowIndex] || []).map(normalizeHeader);

        // mapping (acceptă și variantele din Excel / ERP)
        const want = {
          an: [&quot;an intrare&quot;,&quot;anul&quot;,&quot;an&quot;],
          luna: [&quot;luna intrare&quot;,&quot;luna&quot;],
          data: [&quot;data intrare&quot;,&quot;data&quot;],
          diam: [&quot;diametrul otelului&quot;,&quot;diametru otelului&quot;,&quot;diametru&quot;,&quot;dimensiune otel&quot;,&quot;dimensiune otelului&quot;],
          cal: [&quot;calitatea otelului&quot;,&quot;calitate otelului&quot;,&quot;calitate otel&quot;,&quot;calitate&quot;],
          cod: [&quot;cod intern otel 3 litere&quot;,&quot;cod intern otel 3&quot;,&quot;cod intern otel&quot;,&quot;cod intern&quot;,&quot;cod sarja premagro&quot;],
          sarja: [&quot;sarja material furnizor&quot;,&quot;sarja materialului&quot;,&quot;sarja material&quot;,&quot;sarja&quot;,&quot;cod sarja cat&quot;],
          kg: [&quot;cantitate in kg&quot;,&quot;cantitate kg&quot;,&quot;cantitate&quot;,&quot;cantitatea in kg&quot;,&quot;kg&quot;],
          pre: [&quot;pretest&quot;],
          furn: [&quot;furnizor&quot;,&quot;supplier&quot;]
        };

        function findIndexBySyn(syns){
          for (const s of syns){
            const n = normalizeHeader(s);
            const idx = header.indexOf(n);
            if (idx &gt;= 0) return idx;
          }
          return -1;
        }

        const idxMap = {
          an: findIndexBySyn(want.an),
          luna: findIndexBySyn(want.luna),
          data: findIndexBySyn(want.data),
          diam: findIndexBySyn(want.diam),
          cal: findIndexBySyn(want.cal),
          cod: findIndexBySyn(want.cod),
          sarja: findIndexBySyn(want.sarja),
          kg: findIndexBySyn(want.kg),
          pre: findIndexBySyn(want.pre),
          furn: findIndexBySyn(want.furn)
        };

        const hasHeaders = Object.values(idxMap).some(v =&gt; v &gt;= 0);

        const rows = [];
        const start = hasHeaders ? headerRowIndex + 1 : headerRowIndex; // if no headers, treat first row as data

        for (let r = start; r &lt; aoa.length; r++){
          const row = aoa[r] || [];
          const get = (i) =&gt; i &gt;= 0 ? (row[i] ?? &quot;&quot;) : &quot;&quot;;

          let vals;
          if (hasHeaders){
            vals = [
              (get(idxMap.an) ?? &quot;&quot;).toString().trim(),
              (get(idxMap.luna) ?? &quot;&quot;).toString().trim(),
              normalizeDate(get(idxMap.data)),
              normalizeDiametru(get(idxMap.diam)),
              (get(idxMap.cal) ?? &quot;&quot;).toString().trim(),
              normalizeCodIntern(get(idxMap.cod)),
              (get(idxMap.sarja) ?? &quot;&quot;).toString().trim(),
              normalizeKg(get(idxMap.kg)),
              normalizePretest(get(idxMap.pre)),
              (get(idxMap.furn) ?? &quot;&quot;).toString().trim() || &quot;Necunoscut&quot;
            ];
          }else{
            // already in order: 10 cols
            const padded = Array.from({length:10}, (_,i)=&gt; (row[i] ?? &quot;&quot;).toString().trim());
            vals = [
              padded[0],
              padded[1],
              normalizeDate(padded[2]),
              normalizeDiametru(padded[3]),
              padded[4],
              normalizeCodIntern(padded[5]),
              padded[6],
              normalizeKg(padded[7]),
              normalizePretest(padded[8]),
              padded[9] || &quot;Necunoscut&quot;
            ];
          }

          const any = vals.some(v =&gt; (v ?? &quot;&quot;).toString().trim() !== &quot;&quot;);
          if (!any) continue;
          rows.push(vals);
        }

        const needed = Math.max(30, rows.length + 5);
        rebuildTbody(needed);
        fillTopDown(rows);

        applyFilters();
        notifyDataChanged();
        autoSaveNow();

      }catch(err){
        alert(&quot;Nu am putut importa Excel: &quot; + (err?.message || err));
      }finally{
        e.target.value = &quot;&quot;;
      }
    });
  })();

// ----- AUTO-SALVARE (localStorage) -----
  const AUTO_KEY = &quot;INTRARI_OTEL_autosave_v3&quot;;
  function storageAvailable(){
    try{
      const k=&quot;__test__&quot;;
      window.localStorage.setItem(k,&quot;1&quot;);
      window.localStorage.removeItem(k);
      return true;
    }catch(e){ return false; }
  }
  const CAN_AUTOSAVE = storageAvailable();
  document.getElementById(&#x27;storageBanner&#x27;).style.display = CAN_AUTOSAVE ? &quot;none&quot; : &quot;block&quot;;

  function autoSaveNow(){
    if (!CAN_AUTOSAVE) return;
    try{
      const payload = {
        app:&quot;INTRARI_OTEL&quot;,
        version:3,
        savedAt: new Date().toISOString(),
        rows: getTableData()
      };
      localStorage.setItem(AUTO_KEY, JSON.stringify(payload));
    }catch(e){}
  }

  let _autosaveTimer = null;
  function scheduleAutosave(){
    if (!CAN_AUTOSAVE) return;
    clearTimeout(_autosaveTimer);
    _autosaveTimer = setTimeout(autoSaveNow, 200);
  }

  function autoLoad(){
    if (!CAN_AUTOSAVE) return false;
    try{
      const raw = localStorage.getItem(AUTO_KEY);
      if (!raw) return false;
      const obj = JSON.parse(raw);
      if (!obj || !Array.isArray(obj.rows)) return false;

      const needed = Math.max(30, obj.rows.length + 5);
      rebuildTbody(needed);
      fillTopDown(obj.rows);
      return true;
    }catch(e){ return false; }
  }

  // ----- SUMAR DREAPTA -----
  function parseKg(s){
    const raw = (s || &quot;&quot;).toString().trim();
    if (!raw) return 0;
    let t = raw.replace(/\s+/g,&#x27;&#x27;);

    // daca exista virgula, virgula este zecimala (RO), punctele sunt separatori de mii
    if (t.includes(&#x27;,&#x27;)){
      t = t.replace(/\./g,&#x27;&#x27;);
      const first = t.indexOf(&#x27;,&#x27;);
      t = t.slice(0, first + 1) + t.slice(first + 1).replace(/,/g,&#x27;&#x27;);
      t = t.replace(&#x27;,&#x27;, &#x27;.&#x27;);
      const v = Number(t);
      return isFinite(v) ? v : 0;
    }

    // fara virgula: pattern de mii gen 19.200 / 1.234.567
    if (/^\d{1,3}(\.\d{3})+$/.test(t)){
      const v = Number(t.replace(/\./g,&#x27;&#x27;));
      return isFinite(v) ? v : 0;
    }

    // fara virgula: doar cifre
    if (/^\d+$/.test(t)){
      const v = Number(t);
      return isFinite(v) ? v : 0;
    }

    // fallback: trateaza punctul ca zecimala (si elimina punctele multiple)
    const dotCount = (t.match(/\./g) || []).length;
    if (dotCount &gt; 1) t = t.replace(/\./g,&#x27;&#x27;);
    const v = Number(t);
    return isFinite(v) ? v : 0;
  }

  function getAllDataRows(){
    const tbody = document.getElementById(&#x27;tbody&#x27;);
    return Array.from(tbody.querySelectorAll(&#x27;tr&#x27;)).map(tr =&gt; {
      const tds = tr.querySelectorAll(&#x27;td&#x27;);
      if (!tds || tds.length &lt; 10) return null;
      const year = (tds[0].textContent || &quot;&quot;).trim();
      const month = (tds[1].textContent || &quot;&quot;).trim();
      const diam = (tds[3].textContent || &quot;&quot;).trim();
      const qual = (tds[4].textContent || &quot;&quot;).trim();
      const kg = (tds[7].textContent || &quot;&quot;).trim();
      const any = Array.from(tds).some(td =&gt; ((td.textContent || &quot;&quot;).trim() !== &quot;&quot;));
      if (!any) return null;
      return {year, month, diam, qual, kg: parseKg(kg)};
    }).filter(Boolean);
  }

  function buildSummaryFilters(){
    const yearsSel = document.getElementById(&#x27;sumYear&#x27;);
    const monthSel = document.getElementById(&#x27;sumMonth&#x27;);
    if (!yearsSel || !monthSel) return;

    const rows = getAllDataRows();
    const years = Array.from(new Set(rows.map(r =&gt; r.year).filter(Boolean))).sort((a,b)=&gt;Number(a)-Number(b));

    yearsSel.innerHTML = &#x27;&lt;option value=&quot;&quot;&gt;(toți)&lt;/option&gt;&#x27; + years.map(y =&gt; `&lt;option value=&quot;${y}&quot;&gt;${y}&lt;/option&gt;`).join(&#x27;&#x27;);
    monthSel.innerHTML = &#x27;&lt;option value=&quot;&quot;&gt;(toate)&lt;/option&gt;&#x27; + MONTHS.map(m =&gt; `&lt;option value=&quot;${m}&quot;&gt;${capMonth(m)}&lt;/option&gt;`).join(&#x27;&#x27;);

    const now = new Date();
    const yNow = String(now.getFullYear());
    // alege anul: anul curent dacă există, altfel ultimul an disponibil
    if (years.includes(yNow)) yearsSel.value = yNow;
    else if (years.length) yearsSel.value = years[years.length - 1];

    // alege luna: luna curentă dacă există în datele anului selectat, altfel cea mai recentă; dacă nu există, (toate)
    const yearPicked = (yearsSel.value || &quot;&quot;).trim();
    const monthsForYear = Array.from(new Set(rows.filter(r =&gt; !yearPicked || r.year === yearPicked).map(r =&gt; r.month))).filter(Boolean);
    monthsForYear.sort((a,b)=&gt; MONTHS.indexOf(b) - MONTHS.indexOf(a));
    const mNow = MONTHS[now.getMonth()];
    if (monthsForYear.includes(mNow)) monthSel.value = mNow;
    else if (monthsForYear.length) monthSel.value = monthsForYear[0]; // nu sortăm aici; se vede imediat în tabel
    else monthSel.value = &quot;&quot;;

    yearsSel.onchange = refreshSummary;
    monthSel.onchange = refreshSummary;
  }

  function formatKg(v){
    const n = Number(v || 0);
    if (!isFinite(n)) return &quot;0&quot;;
    const hasDec = Math.abs(n - Math.round(n)) &gt; 1e-9;
    const s = hasDec ? n.toFixed(2) : String(Math.round(n));
    const parts = s.split(&#x27;.&#x27;);
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, &quot;.&quot;);
    return parts.join(hasDec ? &quot;,&quot; : &quot;&quot;);
  }

  function refreshSummary(){
    const yearsSel = document.getElementById(&#x27;sumYear&#x27;);
    const monthSel = document.getElementById(&#x27;sumMonth&#x27;);
    const tbody = document.getElementById(&#x27;sumTbody&#x27;);
    if (!yearsSel || !monthSel || !tbody) return;

    const y = (yearsSel.value || &quot;&quot;).trim();
    const m = (monthSel.value || &quot;&quot;).trim();

    const rows = getAllDataRows().filter(r =&gt; {
      if (y &amp;&amp; r.year !== y) return false;
      if (m &amp;&amp; r.month !== m) return false;
      return true;
    });

    const map = new Map();
    for (const r of rows){
      const diam = r.diam || &quot;(fără diametru)&quot;;
      const qual = r.qual || &quot;(fără calitate)&quot;;
      const key = diam + &quot;||&quot; + qual;
      map.set(key, (map.get(key) || 0) + (r.kg || 0));
    }

    const items = Array.from(map.entries()).map(([key, total]) =&gt; {
      const [diam, qual] = key.split(&quot;||&quot;);
      return {diam, qual, total};
    }).sort((a,b) =&gt; b.total - a.total);

    tbody.innerHTML = &quot;&quot;;
    if (!items.length){
      const tr = document.createElement(&#x27;tr&#x27;);
      const td = document.createElement(&#x27;td&#x27;);
      td.colSpan = 3;
      td.style.textAlign = &quot;center&quot;;
      td.style.color = &quot;#475569&quot;;
      td.textContent = &quot;Nu există date pentru filtrul selectat.&quot;;
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach(it =&gt; {
      const tr = document.createElement(&#x27;tr&#x27;);
      const td1 = document.createElement(&#x27;td&#x27;); td1.textContent = it.diam;
      const td2 = document.createElement(&#x27;td&#x27;); td2.textContent = it.qual;
      const td3 = document.createElement(&#x27;td&#x27;); td3.textContent = formatKg(it.total);
      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
      tbody.appendChild(tr);
    });
  }

  function notifyDataChanged(){
    buildSummaryFilters();
    refreshSummary();
  }

  // autosave on manual edit end
  document.addEventListener(&#x27;focusout&#x27;, (e) =&gt; {
    const el = e.target;
    if (el &amp;&amp; el.tagName === &#x27;TD&#x27; &amp;&amp; el.classList.contains(&#x27;editableCell&#x27;)){
      notifyDataChanged();
      scheduleAutosave();
    }
  }, true);

  // ----- ADAUGARE TOP-DOWN -----
  function findFirstEmptyRow(tbody){
    const rows = Array.from(tbody.querySelectorAll(&#x27;tr&#x27;));
    for (const tr of rows){
      const tds = Array.from(tr.querySelectorAll(&#x27;td&#x27;));
      if (!tds.length) continue;
      const allEmpty = tds.every(td =&gt; ((td.textContent || &quot;&quot;).trim() === &quot;&quot;));
      if (allEmpty) return tr;
    }
    return null;
  }

  function scrollToRow(tr){
    const wrap = document.getElementById(&#x27;tableWrap&#x27;);
    if (!wrap || !tr) return;
    // ensure it scrolls inside the wrapper
    const wrapRect = wrap.getBoundingClientRect();
    const trRect = tr.getBoundingClientRect();
    // if outside view, adjust
    if (trRect.top &lt; wrapRect.top || trRect.bottom &gt; wrapRect.bottom){
      tr.scrollIntoView({behavior:&#x27;smooth&#x27;, block:&#x27;nearest&#x27;});
    }
  }

  function saveRow(){
    const an = document.getElementById(&#x27;fAn&#x27;).value.trim();
    const luna = document.getElementById(&#x27;fLuna&#x27;).value.trim();
    const data = document.getElementById(&#x27;fData&#x27;).value;
    const dim = document.getElementById(&#x27;fDim&#x27;).value.trim();
    const cal = document.getElementById(&#x27;fCal&#x27;).value.trim();
    const prem = normalizeCodIntern(document.getElementById(&#x27;fPrem&#x27;).value);
    const cat = document.getElementById(&#x27;fCat&#x27;).value.trim();
    const kg = document.getElementById(&#x27;fKg&#x27;).value.trim();
    const pre = document.getElementById(&#x27;fPre&#x27;).value.trim();
    let furn = document.getElementById(&#x27;fFurn&#x27;).value.trim();
    const furnOther = (document.getElementById(&#x27;fFurnOther&#x27;)?.value || &#x27;&#x27;).trim();
    if (furn.toLowerCase() === &#x27;altul&#x27;) furn = furnOther;

    const codIntern = prem; // alias semantic
    const sarja = cat;

    if (!an || !luna || !data || !dim || !cal || !codIntern || !sarja || !kg || !pre || !furn){
      alert(&quot;Completează: Anul, Luna, Data, Diametru, Calitate, Cod intern (3 litere), Sarja material, Cantitate (kg), Pretest, Furnizor.&quot;);
      return;
    }

    if (!isValidCodIntern(codIntern)){
      alert(&quot;Cod intern invalid. Trebuie să fie exact 3 litere din setul: N U M E R A L K O D (ex: NNN, NNU, UNM).&quot;);
      return;
    }

    const parts = data.split(&#x27;-&#x27;);
    const dataDisp = parts.length === 3 ? (parts[2] + &quot;.&quot; + parts[1] + &quot;.&quot; + parts[0]) : data;
    const cells = [an, luna, dataDisp, dim, cal, prem, cat, kg, pre, furn];

    const tbody = document.getElementById(&#x27;tbody&#x27;);
    let tr = findFirstEmptyRow(tbody);

    if (!tr){
      tr = document.createElement(&#x27;tr&#x27;);
      for (let i=0;i&lt;10;i++) {
        const td = document.createElement(&#x27;td&#x27;);
        td.className = &#x27;editableCell&#x27;;
        td.contentEditable = &#x27;true&#x27;;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    const tds = tr.querySelectorAll(&#x27;td&#x27;);
    cells.forEach((v, i) =&gt; { if (tds[i]) tds[i].textContent = v || &quot;&quot;; });

    applyFilters();
    notifyDataChanged();
    scheduleAutosave();
    scrollToRow(tr);
  }

  // ----- INIT -----
  // auto-load first (if possible)
  refreshHelperDatalists();
  const loaded = autoLoad();
  applyFilters();
  notifyDataChanged();
  if (loaded) autoSaveNow(); // normalize stored format
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
"></iframe>
<iframe id="pageDebitate" sandbox="allow-scripts allow-same-origin allow-downloads allow-modals" srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;ro&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot; /&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
  &lt;title&gt;DEBITATE&lt;/title&gt;
  &lt;style&gt;
    .topnav{display:none!important;} .stage{padding-top:0!important;} iframe{height:100vh!important;}

    :root{
      --bg:#b7d7f0;
      --hdr:#cfe3f6;
      --grid:#000;
      --white:#fff;
      --btn:#2b6cb0;
      --btn2:#1e5a96;
      --focus:#2563eb;
      --shadow: rgba(0,0,0,.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color:#0b1220;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
    }
    .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .btn{
      border:1px solid rgba(0,0,0,.25);
      background:#fff;
      border-radius:8px;
      padding:8px 12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 2px 6px var(--shadow);
    }
    .btn.primary{
      background: var(--btn);
      color:#fff;
      border-color: rgba(0,0,0,.15);
    }
    .btn.primary:hover{ background: var(--btn2); }
    .status{
      font-size:12px;
      color:#0b1220;
      opacity:.75;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.2);
      background: rgba(255,255,255,.75);
      font-size:12px;
      font-weight:700;
    }
    .wrap{
      padding: 0 12px 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .tablewrap{
      background: rgba(255,255,255,.35);
      border-radius:10px;
      overflow:auto;
      height: calc(100vh - 150px);
      max-height: calc(100vh - 150px);
      border:1px solid rgba(0,0,0,.2);
      box-shadow: 0 2px 10px var(--shadow);

      /* Flex layout */
      flex: 1 1 auto;
      min-width: 0;
      width: 100%;
      display: block;
      max-width: none;
    }

    .sidePanel{
      flex: 0 0 420px;
      width: 420px;
      max-width: 420px;
      height: calc(100vh - 150px);
      max-height: calc(100vh - 150px);
      overflow:auto;
      padding-right:2px;
    }
    .card{
      background: rgba(255,255,255,.7);
      border:1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      box-shadow: 0 2px 10px var(--shadow);
      padding: 10px;
      margin-bottom: 12px;
    }
    .cardTitle{
      font-weight: 900;
      font-size: 13px;
      margin: 2px 0 10px;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .field label{ display:block; font-size:12px; font-weight:800; margin: 0 0 4px; }
    .field select, .field input{
      width:100%;
      border:1px solid rgba(0,0,0,.25);
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      font-weight:800;
      font-size:12px;
      outline:none;
    }
    .btnRow{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .btn.small{ padding:8px 10px; border-radius:10px; font-size:12px; }
    .btn.ghost{ background: rgba(255,255,255,.4); }
    .note{ margin-top:8px; font-size:12px; opacity:.82; }
    .sumWrap{ margin-top:10px; background: rgba(255,255,255,.55); border-radius:10px; border:1px solid rgba(0,0,0,.12); overflow-y:auto; overflow-x:hidden; max-height: 300px; }
    .sumTable{ border-collapse: collapse; width:100%; table-layout:fixed; background:#fff; }
    .sumTable th, .sumTable td{ border:1px solid rgba(0,0,0,.35); padding:4px 6px; font-size:12px; line-height:1.15; white-space:nowrap; overflow-wrap:normal; word-break:normal; vertical-align:middle; }
    .sumTable th{ background: var(--hdr); position: sticky; top:0; z-index: 1; }
    .sumTable th:nth-child(4), .sumTable th:nth-child(5),
    .sumTable td:nth-child(4), .sumTable td:nth-child(5){
      text-align:right;
      font-variant-numeric: tabular-nums;
    }
    .sumTable th:nth-child(2), .sumTable td:nth-child(2){ text-align:center; }
/* Fără scroll stânga-dreapta: coloane fixe + wrap controlat */
.sumTable th:nth-child(1), .sumTable td:nth-child(1){ width: 28%; }
.sumTable th:nth-child(2), .sumTable td:nth-child(2){ width: 14%; }
.sumTable th:nth-child(3), .sumTable td:nth-child(3){ width: 30%; }
.sumTable th:nth-child(4), .sumTable td:nth-child(4){ width: 14%; }
.sumTable th:nth-child(5), .sumTable td:nth-child(5){ width: 14%; }

.sumTable th:nth-child(1), .sumTable td:nth-child(1),
.sumTable th:nth-child(3), .sumTable td:nth-child(3){
  white-space: normal;
  overflow-wrap: break-word;
  word-break: break-word;
}


    table{
      border-collapse: collapse;
      table-layout: fixed;
      width: 100%;
      background: var(--white);
    }
    th, td{
      border: 1px solid var(--grid);
      padding: 1px 3px;
      font-size: 10px;
      line-height: 1.0;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      vertical-align: middle;
    }
    thead th{
      background: var(--hdr);
      position: sticky;
      top: 0;
      z-index: 2;
      white-space: pre-line; /* permite titluri pe 2 randuri */
      text-align:center;
    }
    th:last-child{ padding:0 !important; }
    td:last-child{ padding:0 !important; }
    
    thead tr.filters th{ display:none; /* removed */
      
      top: 26px; /* height of header row */
      z-index: 1;
      background: #e8f3ff;
      padding: 2px 4px;
    }
    .finput, .fselect{
      width: 100%;
      border: 1px solid rgba(0,0,0,.35);
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 10px;
      background:#fff;
      height: 22px;
    }
    .cellinput{
      width: 100%;
      border: 0;
      outline: none;
      background: transparent;
      font-size: 10px;
      padding: 0;
      height: 18px;
    }
    .cellinput:focus{
      outline: 2px solid rgba(37,99,235,.35);
      border-radius: 4px;
      background: rgba(37,99,235,.06);
    }
    .num{text-align:right; font-variant-numeric: tabular-nums;; white-space:nowrap; overflow-wrap:normal; word-break:normal }
    .center{text-align:center;; white-space:nowrap; overflow-wrap:normal; word-break:normal }
    .rowActions{
      display:flex;
      gap:0;
      justify-content:center;
    }
    .actCell{ padding:0 !important; }
    .actCell .rowActions{ padding:0; }
    .iconbtn{
      border:1px solid rgba(0,0,0,.25);
      background:#fff;
      border-radius:6px;
      width:18px;
      height:18px;
      padding:0;
      cursor:pointer;
      font-weight:900;
      font-size: 12px;
      line-height: 1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .iconbtn.danger{ background:#fff1f2; }
    .hint{
      font-size:12px;
      opacity:.8;
    }
    
    /* modal add/edit */
    .modalback{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width: min(1100px, 100%);
      background: #fff;
      border: 1px solid rgba(0,0,0,.25);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.28);
      overflow: hidden;
    }
    .modal header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      background: var(--hdr);
      border-bottom: 1px solid rgba(0,0,0,.2);
      font-weight: 900;
    }
    .modal .content{
      padding: 12px;
      background: #fff;
    }
    .modal .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    .modal label{
      display:grid;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
    }
    .modal input, .modal select{
      border:1px solid rgba(0,0,0,.35);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      background:#fff;
      width:100%;
    }
    .modal .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top: 12px;
    }
    .modal .err{
      color: #b00020;
      font-size: 12px;
      font-weight: 800;
      margin-top: 8px;
    }
    @media (max-width: 980px){
      .modal .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 560px){
      .modal .grid{ grid-template-columns: 1fr; }
    }

    .hidden{ display:none !important; }
  
    .chk{ grid-column: 1 / -1; display:flex; align-items:center; gap:10px; font-size:12px; padding:6px 8px; background: rgba(255,255,255,.55); border: 1px dashed rgba(0,0,0,.25); border-radius:10px;}
    .chk input{ width:16px; height:16px; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;topbar&quot;&gt;
    &lt;div class=&quot;left&quot;&gt;
      &lt;button class=&quot;btn&quot; onclick=&quot;goMenu()&quot;&gt;🏠 Meniu&lt;/button&gt;
      &lt;button class=&quot;btn primary&quot; onclick=&quot;openAddModal()&quot;&gt;➕ Adaugă&lt;/button&gt;
      &lt;div class=&quot;status&quot;&gt;
        &lt;span class=&quot;pill&quot; id=&quot;pillRows&quot;&gt;0 rânduri&lt;/span&gt;
        &lt;span class=&quot;pill&quot; id=&quot;pillTotalKg&quot;&gt;0 kg total&lt;/span&gt;
        &lt;span class=&quot;pill&quot; id=&quot;pillSave&quot;&gt;autosave: idle&lt;/span&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;right&quot;&gt;
      &lt;button class=&quot;btn&quot; onclick=&quot;exportXLSX()&quot;&gt;⤓ Export Excel&lt;/button&gt;
      &lt;button class=&quot;btn&quot; onclick=&quot;importXLSX()&quot;&gt;⤒ Import Excel&lt;/button&gt;
      &lt;button class=&quot;btn&quot; onclick=&quot;exportJSON()&quot;&gt;⤓ Export JSON&lt;/button&gt;
      &lt;button class=&quot;btn&quot; onclick=&quot;resetAll()&quot; title=&quot;Șterge toate datele salvate local&quot;&gt;Reset&lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div class=&quot;wrap&quot;&gt;
    &lt;div class=&quot;tablewrap&quot; id=&quot;tablewrap&quot;&gt;
      &lt;table id=&quot;tbl&quot;&gt;
        &lt;colgroup id=&quot;colgroup&quot;&gt;&lt;/colgroup&gt;
        &lt;thead&gt;
          &lt;tr id=&quot;hdr&quot;&gt;&lt;/tr&gt;
          
        &lt;/thead&gt;
        &lt;tbody id=&quot;body&quot;&gt;&lt;/tbody&gt;
      &lt;/table&gt;

    &lt;/div&gt;
    &lt;div class=&quot;sidePanel&quot; aria-label=&quot;Filtre și sumar&quot;&gt;
      &lt;div class=&quot;card&quot;&gt;
        &lt;div class=&quot;cardTitle&quot;&gt;Filtre (tabel)&lt;/div&gt;
        &lt;div class=&quot;grid2&quot;&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label for=&quot;fltYear&quot;&gt;An&lt;/label&gt;
            &lt;select id=&quot;fltYear&quot;&gt;&lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label for=&quot;fltMonth&quot;&gt;Lună&lt;/label&gt;
            &lt;select id=&quot;fltMonth&quot;&gt;&lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;btnRow&quot;&gt;
          &lt;button class=&quot;btn small&quot; onclick=&quot;applyUIFilters()&quot;&gt;Filtrează&lt;/button&gt;
          &lt;button class=&quot;btn small ghost&quot; onclick=&quot;resetUIFilters()&quot;&gt;Reset filtre&lt;/button&gt;
        &lt;/div&gt;
        &lt;div class=&quot;note&quot;&gt;Filtrează rândurile din tabel după An și Lună.&lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;card&quot;&gt;
        &lt;div class=&quot;cardTitle&quot;&gt;Sumă debitate pe Reper + Diametru + Calitate&lt;/div&gt;
        &lt;div class=&quot;grid2&quot;&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label for=&quot;sumYear&quot;&gt;An&lt;/label&gt;
            &lt;select id=&quot;sumYear&quot;&gt;&lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;field&quot;&gt;
            &lt;label for=&quot;sumMonth&quot;&gt;Lună&lt;/label&gt;
            &lt;select id=&quot;sumMonth&quot;&gt;&lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;note&quot;&gt;Sumarul folosește doar An/Lună de aici (independent de filtrele tabelului).&lt;/div&gt;
        &lt;div class=&quot;sumWrap&quot;&gt;
          &lt;table class=&quot;sumTable&quot;&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;Reper&lt;/th&gt;
                &lt;th&gt;Diametru&lt;/th&gt;
                &lt;th&gt;Calitate&lt;/th&gt;
                &lt;th class=&quot;num&quot;&gt;Total buc&lt;/th&gt;
                &lt;th class=&quot;num&quot;&gt;Total kg&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody id=&quot;sumBody&quot;&gt;
              &lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;center&quot;&gt;Selectează Anul aici pentru a calcula sumarul.&lt;/td&gt;&lt;/tr&gt;
            &lt;/tbody&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;!-- Modal Adaugă rând --&gt;

  &lt;div class=&quot;modalback hidden&quot; id=&quot;modalBack&quot; onclick=&quot;if(event.target.id===&#x27;modalBack&#x27;) closeAddModal()&quot;&gt;
    &lt;div class=&quot;modal&quot; role=&quot;dialog&quot; aria-modal=&quot;true&quot; aria-label=&quot;Adaugă debitare&quot;&gt;
      &lt;header&gt;
        &lt;div&gt;Adaugă debitare&lt;/div&gt;
        &lt;button class=&quot;btn&quot; type=&quot;button&quot; onclick=&quot;closeAddModal()&quot;&gt;✕&lt;/button&gt;
      &lt;/header&gt;
      &lt;div class=&quot;content&quot;&gt;
        &lt;div class=&quot;grid&quot;&gt;
          &lt;label&gt;Data
            &lt;input id=&quot;mData&quot; type=&quot;date&quot; onchange=&quot;syncAnLunaFromDate()&quot;&gt;
          &lt;/label&gt;
          &lt;label&gt;An (auto)
            &lt;input id=&quot;mAn&quot; type=&quot;text&quot; readonly&gt;
          &lt;/label&gt;
          &lt;label&gt;Lună (auto)
            &lt;input id=&quot;mLuna&quot; type=&quot;text&quot; readonly&gt;
          &lt;/label&gt;
          &lt;label&gt;Echipament
            &lt;input id=&quot;mEchip&quot; type=&quot;text&quot; list=&quot;dlUtilajeDebitare&quot; placeholder=&quot;ex: 1 SCPK 500 / EVERSING&quot;&gt;
          &lt;/label&gt;

          &lt;label&gt;Reper
            &lt;input id=&quot;mReper&quot; type=&quot;text&quot; list=&quot;dlRepereDebitare&quot; placeholder=&quot;ex: 248-2307/08&quot;&gt;
          &lt;/label&gt;

          &lt;label class=&quot;chk&quot;&gt;
            &lt;input id=&quot;mOverride&quot; type=&quot;checkbox&quot;&gt;
            Override manual (Diametru / Calitate / Kg/buc / Lungime)
          &lt;/label&gt;
          &lt;label&gt;Diametru oțel
            &lt;input id=&quot;mDiam&quot; type=&quot;text&quot; placeholder=&quot;ex: Ø71 / 71&quot; readonly&gt;
          &lt;/label&gt;
          &lt;label&gt;CALITATE
            &lt;input id=&quot;mCal&quot; type=&quot;text&quot; placeholder=&quot;ex: 1E-1287/15B34&quot; readonly&gt;
          &lt;/label&gt;
          &lt;label&gt;Kg/buc.
            &lt;input id=&quot;mKgBuc&quot; type=&quot;text&quot; placeholder=&quot;ex: 8,5&quot; readonly&gt;
          &lt;/label&gt;

          &lt;label&gt;Lungime debitat (mm)
            &lt;input id=&quot;mLungime&quot; type=&quot;text&quot; placeholder=&quot;ex: 264&quot; readonly&gt;
          &lt;/label&gt;
          &lt;label&gt;Sarja
            &lt;input id=&quot;mSarja&quot; type=&quot;text&quot; placeholder=&quot;ex: DAR / DRM&quot;&gt;
          &lt;/label&gt;
          &lt;label&gt;Planificat
            &lt;input id=&quot;mPlan&quot; type=&quot;text&quot; placeholder=&quot;ex: 1.056&quot;&gt;
          &lt;/label&gt;
          &lt;label&gt;Cantitate
            &lt;input id=&quot;mCant&quot; type=&quot;text&quot; placeholder=&quot;ex: 1.056&quot;&gt;
          &lt;/label&gt;

          &lt;label&gt;Schimbul
            &lt;input id=&quot;mSchimb&quot; type=&quot;text&quot; placeholder=&quot;1&quot;&gt;
          &lt;/label&gt;
          &lt;label&gt;Operator
            &lt;input id=&quot;mOper&quot; type=&quot;text&quot; placeholder=&quot;ex: Nagy Robert&quot;&gt;
          &lt;/label&gt;
          &lt;label&gt;Ore lucrate
            &lt;input id=&quot;mOre&quot; type=&quot;text&quot; placeholder=&quot;8,0&quot;&gt;
          &lt;/label&gt;
          &lt;div&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;err&quot; id=&quot;mErr&quot;&gt;&lt;/div&gt;

        &lt;div class=&quot;actions&quot;&gt;
          &lt;button class=&quot;btn&quot; type=&quot;button&quot; onclick=&quot;closeAddModal()&quot;&gt;Anulează&lt;/button&gt;
          &lt;button class=&quot;btn primary&quot; type=&quot;button&quot; onclick=&quot;saveAddModal()&quot;&gt;Salvează&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
  // ===== CONFIG =====
  const STORAGE_KEY = &quot;DEBITATE_autosave_v1&quot;;
  const LUNI = [&quot;ianuarie&quot;,&quot;februarie&quot;,&quot;martie&quot;,&quot;aprilie&quot;,&quot;mai&quot;,&quot;iunie&quot;,&quot;iulie&quot;,&quot;august&quot;,&quot;septembrie&quot;,&quot;octombrie&quot;,&quot;noiembrie&quot;,&quot;decembrie&quot;];

  function storageAvailable(){
    try{
      const x = &quot;__st__&quot; + Math.random();
      localStorage.setItem(x, x);
      localStorage.removeItem(x);
      return true;
    } catch(e){
      return false;
    }
  }
  const CAN_STORE = storageAvailable();


  const COLUMNS = [
    { key:&quot;an&quot;, label:&quot;Anul&quot;, type:&quot;year&quot;, align:&quot;center&quot; },
    { key:&quot;luna&quot;, label:&quot;Luna&quot;, type:&quot;text&quot; },
    { key:&quot;data&quot;, label:&quot;Data&quot;, type:&quot;date&quot; },
    { key:&quot;echipament&quot;, label:&quot;Echipament&quot;, type:&quot;text&quot; },
    { key:&quot;reper&quot;, label:&quot;Reper&quot;, type:&quot;text&quot; },
    { key:&quot;diametru&quot;, label:&quot;Diametru oțel&quot;, type:&quot;diam&quot; },
    { key:&quot;calitate&quot;, label:&quot;CALITATE&quot;, type:&quot;text&quot; },
    { key:&quot;kgBuc&quot;, label:&quot;Kg/buc.&quot;, type:&quot;dec2&quot;, align:&quot;num&quot; },
    { key:&quot;lungime&quot;, label:&quot;Lungime debitat mm&quot;, type:&quot;int&quot;, align:&quot;num&quot; },
    { key:&quot;sarja&quot;, label:&quot;Sarja&quot;, type:&quot;text&quot; },
    { key:&quot;planificat&quot;, label:&quot;Plani\nficat&quot;, type:&quot;int&quot;, align:&quot;num&quot; },
    { key:&quot;cantitate&quot;, label:&quot;Canti\ntate&quot;, type:&quot;int&quot;, align:&quot;num&quot; },
    { key:&quot;schimbul&quot;, label:&quot;Schim\nbul&quot;, type:&quot;int&quot;, align:&quot;center&quot; },
    { key:&quot;totalKg&quot;, label:&quot;total kg\ndebitat&quot;, type:&quot;int&quot;, align:&quot;num&quot;, readonly:true },
    { key:&quot;weekNr&quot;, label:&quot;week\nnr.&quot;, type:&quot;int&quot;, align:&quot;center&quot;, readonly:true },
    { key:&quot;operator&quot;, label:&quot;Operator&quot;, type:&quot;text&quot; },
    { key:&quot;procentNorma&quot;, label:&quot;Procent norma %&quot;, type:&quot;pct&quot;, align:&quot;center&quot;, readonly:true },
    { key:&quot;oreLucrate&quot;, label:&quot;Ore lucrate&quot;, type:&quot;dec1&quot;, align:&quot;center&quot; }
  ];

  const COL_WIDTHS = {
    an: 58,
    luna: 78,
    data: 88,
    echipament: 86,
    reper: 86,
    diametru: 78,
    calitate: 104,
    kgBuc: 62,
    lungime: 86,
    sarja: 72,
    planificat: 70,
    cantitate: 70,
    schimbul: 54,
    totalKg: 84,
    weekNr: 54,
    operator: 96,
    procentNorma: 98,
    oreLucrate: 78
  };
  const ACTION_COL_W = 28;


  // ===== STATE =====
  let rows = [];
  let filters = null; // filters removed (add via modal only)
  let saveTimer = null;

  const $ = (id) =&gt; document.getElementById(id);
  const pillRows = $(&quot;pillRows&quot;);
  const pillTotalKg = $(&quot;pillTotalKg&quot;);
  const pillSave = $(&quot;pillSave&quot;);


  // ===== HELPERE (din Excel) =====
  const HELPERS_KEY = &quot;RF_HELPERS_v1&quot;;
  let _helpers = null;
  let _mapRepDebitare = null;

  function loadHelpers(){
    if (_helpers) return _helpers;
    try {
      const raw = localStorage.getItem(HELPERS_KEY);
      if (!raw) return null;
      _helpers = JSON.parse(raw);
      return _helpers;
    } catch(e) {
      console.warn(&quot;Helpere corupte / lipsă:&quot;, e);
      return null;
    }
  }

  function buildHelperMaps(){
    const h = loadHelpers();
    _mapRepDebitare = new Map();
    const dlR = $(&quot;dlRepereDebitare&quot;);
    const dlU = $(&quot;dlUtilajeDebitare&quot;);
    if (dlR) dlR.innerHTML = &quot;&quot;;
    if (dlU) dlU.innerHTML = &quot;&quot;;

    if (!h) return;

    // Repere debitare → autofill
    (h.repere_debitare || []).forEach(row =&gt; {
      const k = (row.REPER_DEBITARE ?? &quot;&quot;).toString().trim();
      if (!k) return;
      _mapRepDebitare.set(k, {
        reper: k,
        diam: row.DIAMETRU_OTEL,
        cal: (row.CALITATE_OTEL ?? &quot;&quot;).toString().trim(),
        kgBuc: row.KG_BUC_DEBITAT,
        lung: row.LUNGIME_DEBITARE_MM
      });
    });

    if (dlR){
      Array.from(_mapRepDebitare.keys()).sort().forEach(k =&gt; {
        const o = document.createElement(&quot;option&quot;);
        o.value = k;
        dlR.appendChild(o);
      });
    }

    // Utilaje debitare (autocomplete)
    if (dlU){
      (h.utilaje_debitare || []).forEach(u =&gt; {
        const v = (u ?? &quot;&quot;).toString().trim();
        if (!v) return;
        const o = document.createElement(&quot;option&quot;);
        o.value = v;
        dlU.appendChild(o);
      });
    }
  }

  // Reîncarcă helperele când sunt modificate în pagina HELPER
  window.addEventListener(&#x27;message&#x27;, (ev) =&gt; {
    if (!ev || !ev.data) return;
    if (ev.data.type === &#x27;HELPERS_UPDATED&#x27;) {
      _helpers = null;
      _mapRepDebitare = null;
      try{ buildHelperMaps(); }catch(e){}
    }
  });

  function setAutofillReadonly(isReadonly){
    [&quot;mDiam&quot;,&quot;mCal&quot;,&quot;mKgBuc&quot;,&quot;mLungime&quot;].forEach(id =&gt; {
      const el = $(id);
      if (!el) return;
      if (isReadonly) el.setAttribute(&quot;readonly&quot;,&quot;readonly&quot;);
      else el.removeAttribute(&quot;readonly&quot;);
    });
  }

  function applyReperAutofill(){
    const override = $(&quot;mOverride&quot;)?.checked;
    if (override) return;
    if (!_mapRepDebitare) buildHelperMaps();
    const key = $(&quot;mReper&quot;)?.value?.trim();
    if (!key || !_mapRepDebitare || !_mapRepDebitare.has(key)) return;
    const info = _mapRepDebitare.get(key);

    if ($(&quot;mDiam&quot;)) $(&quot;mDiam&quot;).value = (info.diam ?? &quot;&quot;) === &quot;&quot; ? &quot;&quot; : String(info.diam);
    if ($(&quot;mCal&quot;)) $(&quot;mCal&quot;).value = info.cal || &quot;&quot;;

    // kg/buc: păstrează virgula ca zecimal în UI
    if ($(&quot;mKgBuc&quot;)) {
      const n = Number(info.kgBuc);
      $(&quot;mKgBuc&quot;).value = Number.isFinite(n) ? String(n).replace(&quot;.&quot;, &quot;,&quot;) : &quot;&quot;;
    }

    // lungime: întreg
    if ($(&quot;mLungime&quot;)) {
      const n = Number(info.lung);
      $(&quot;mLungime&quot;).value = Number.isFinite(n) ? String(Math.trunc(n)) : &quot;&quot;;
    }
  }


  // ===== HELPERS =====
  function goMenu(){ parent.showPage(&quot;dashboard&quot;); }

  function monthLower(s){
    return (s ?? &quot;&quot;).toString().trim().toLowerCase();
  }

  function stripDia(s){
    return (s ?? &quot;&quot;).toString().normalize(&quot;NFD&quot;).replace(/[\u0300-\u036f]/g, &quot;&quot;);
  }

  function normalizeDiam(v){
    if (v == null) return &quot;&quot;;
    let s = (&quot;&quot;+v).trim();
    s = s.replace(/Ø/gi,&quot;&quot;).replace(/\s+/g,&quot;&quot;).replace(/mm$/i,&quot;&quot;);
    return s;
  }

  // Parse number in RO-ish formats:
  // - &quot;2.090&quot; -&gt; 2090  (thousands dot)
  // - &quot;8,5&quot; -&gt; 8.5     (decimal comma)
  // - &quot;1.234,56&quot; -&gt; 1234.56
  function parseNumberRO(v){
    if (v == null) return NaN;
    if (typeof v === &quot;number&quot;) return v;
    let s = (&quot;&quot;+v).trim();
    if (!s) return NaN;

    // remove spaces
    s = s.replace(/\s+/g,&quot;&quot;);

    const hasComma = s.includes(&quot;,&quot;);
    if (hasComma){
      // treat commas as decimal; dots as thousands
      s = s.replace(/\./g,&quot;&quot;).replace(&quot;,&quot;,&quot;.&quot;);
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    // if pattern is thousands with dots: 1.234 or 12.345.678
    if (/^\d{1,3}(\.\d{3})+$/.test(s)){
      const n = Number(s.replace(/\./g,&quot;&quot;));
      return Number.isFinite(n) ? n : NaN;
    }

    // fallback normal
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmtIntDots(n){
    if (!Number.isFinite(n)) return &quot;&quot;;
    const sign = n &lt; 0 ? &quot;-&quot; : &quot;&quot;;
    n = Math.abs(Math.trunc(n));
    const s = String(n);
    return sign + s.replace(/\B(?=(\d{3})+(?!\d))/g, &quot;.&quot;);
  }

  function fmtDecComma(n, decimals){
    if (!Number.isFinite(n)) return &quot;&quot;;
    const fixed = n.toFixed(decimals);
    // replace dot with comma
    let s = fixed.replace(&quot;.&quot;, &quot;,&quot;);
    // trim trailing zeros if decimals&gt;1
    if (decimals &gt; 1){
      s = s.replace(/,0+$/,&quot;&quot;);
      s = s.replace(/,(\d*[1-9])0+$/,&quot; ,$1&quot;).replace(&quot; &quot;,&quot;&quot;);
    }
    return s;
  }

  function fmtPct(n){
    if (!Number.isFinite(n)) return &quot;&quot;;
    return String(Math.round(n)) + &quot;%&quot;;
  }

  function parseDateAny(v){
    // Accept: yyyy-mm-dd, dd.mm.yyyy, dd/mm/yyyy, Excel Date serial
    if (v == null || v === &quot;&quot;) return &quot;&quot;;
    if (typeof v === &quot;number&quot;){
      // Excel serial date to JS date (1900 system)
      const excelEpoch = new Date(Date.UTC(1899,11,30));
      const d = new Date(excelEpoch.getTime() + v * 86400000);
      return toISODate(d);
    }
    const s = (&quot;&quot;+v).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m1 = s.match(/^([0-3]?\d)\.([01]?\d)\.(\d{4})$/);
    if (m1){
      const dd = m1[1].padStart(2,&quot;0&quot;);
      const mm = m1[2].padStart(2,&quot;0&quot;);
      const yy = m1[3];
      return `${yy}-${mm}-${dd}`;
    }
    const m2 = s.match(/^([0-3]?\d)\/([01]?\d)\/(\d{4})$/);
    if (m2){
      const dd = m2[1].padStart(2,&quot;0&quot;);
      const mm = m2[2].padStart(2,&quot;0&quot;);
      const yy = m2[3];
      return `${yy}-${mm}-${dd}`;
    }
    // last resort: Date parse
    const d = new Date(s);
    if (!isNaN(d.getTime())) return toISODate(d);
    return &quot;&quot;;
  }

  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,&quot;0&quot;);
    const day = String(d.getDate()).padStart(2,&quot;0&quot;);
    return `${y}-${m}-${day}`;
  }

  function fmtDateRO(iso){
    if (!iso) return &quot;&quot;;
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return iso;
    return `${m[3]}.${m[2]}.${m[1]}`;
  }

  function isoWeekNumber(iso){
    if (!iso) return &quot;&quot;;
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return &quot;&quot;;
    const d = new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
    // ISO week date weeks start on Monday
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  function recalcRow(r){
    // normalize fields
    const y = parseNumberRO(r.an);
    if (Number.isFinite(y)) r.an = Math.trunc(y);
    if (r.luna != null) r.luna = monthLower(r.luna);
    if (r.data) r.data = parseDateAny(r.data);
    if (r.data){
      const yy2 = Number(r.data.slice(0,4));
      const mm2 = Number(r.data.slice(5,7));
      if (!r.an) r.an = yy2;
      if (!r.luna) r.luna = LUNI[mm2-1] || &quot;&quot;;
    }

    const kgBuc = Number(r.kgBuc);
    const cant = Number(r.cantitate);
    if (Number.isFinite(kgBuc) &amp;&amp; Number.isFinite(cant)){
      r.totalKg = Math.round(kgBuc * cant); // total kg as integer
    } else {
      r.totalKg = &quot;&quot;;
    }
    r.weekNr = r.data ? isoWeekNumber(r.data) : &quot;&quot;;
    const plan = Number(r.planificat);
    if (Number.isFinite(plan) &amp;&amp; plan &gt; 0 &amp;&amp; Number.isFinite(cant)){
      r.procentNorma = Math.round((cant / plan) * 100);
    } else {
      r.procentNorma = &quot;&quot;;
    }
    return r;
  }

  function scheduleSave(){
    if (!CAN_STORE){
      pillSave.textContent = &quot;autosave: OFF (storage blocat)&quot;;
      return;
    }
    pillSave.textContent = &quot;autosave: saving…&quot;;
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() =&gt; {
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ rows }));
        pillSave.textContent = &quot;autosave: saved&quot;;
      } catch(e){
        console.error(e);
        pillSave.textContent = &quot;autosave: failed&quot;;
      }
    }, 350);
  }

  function load(){
    if (!CAN_STORE){
      pillSave.textContent = &quot;autosave: OFF (storage blocat)&quot;;
      return;
    }
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try{
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed?.rows)) rows = parsed.rows;
      filters = null;
    } catch(e){}
  }

  function resetAll(){
    if (!confirm(&quot;Ștergi toate datele DEBITATE salvate local?&quot;)) return;
    localStorage.removeItem(STORAGE_KEY);
    rows = [];
    filters = null;
    render();
    pillSave.textContent = &quot;autosave: idle&quot;;
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify({ rows }, null, 2)], { type:&quot;application/json&quot; });
    const a = document.createElement(&quot;a&quot;);
    a.href = URL.createObjectURL(blob);
    a.download = `DEBITATE_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    setTimeout(()=&gt;URL.revokeObjectURL(a.href), 500);
  }

  // ===== RENDER =====
  function buildHeader(){
    const hdr = $(&quot;hdr&quot;);
    const cg = $(&quot;colgroup&quot;);
    hdr.innerHTML = &quot;&quot;;
    if (cg) cg.innerHTML = &quot;&quot;;

    for (const col of COLUMNS){
      if (cg){
        const c = document.createElement(&quot;col&quot;);
        c.style.width = (COL_WIDTHS[col.key] || 90) + &quot;px&quot;;
        cg.appendChild(c);
      }
      const th = document.createElement(&quot;th&quot;);
      th.textContent = col.label;
      hdr.appendChild(th);
    }

    // ACT (ștergere)
    if (cg){
      const cA = document.createElement(&quot;col&quot;);
      cA.style.width = ACTION_COL_W + &quot;px&quot;;
      cg.appendChild(cA);
    }
    const thA = document.createElement(&quot;th&quot;);
    thA.textContent = &quot;🗑&quot;;
    thA.title = &quot;Ștergere rând&quot;;
    hdr.appendChild(thA);
  }

  function matchFilter(r, col, value){
    if (!value) return true;
    const v = value.toString().trim().toLowerCase();
    if (!v) return true;

    let cell = r[col.key];
    if (col.type === &quot;date&quot;){
      cell = fmtDateRO(r.data);
    } else if (col.type === &quot;diam&quot;){
      cell = normalizeDiam(r.diametru);
    } else if (col.type === &quot;int&quot; || col.type === &quot;dec2&quot; || col.type === &quot;dec1&quot;){
      cell = String(r[col.key] ?? &quot;&quot;);
    } else {
      cell = (r[col.key] ?? &quot;&quot;).toString();
    }
    return cell.toLowerCase().includes(v);
  }

  function getFilteredRows(){
    const ySel = ($(&quot;fltYear&quot;)?.value || &quot;&quot;).trim();
    const mSel = monthLower(($(&quot;fltMonth&quot;)?.value || &quot;&quot;).trim());
    return rows.filter(r =&gt; {
      if (ySel &amp;&amp; String(r.an ?? &quot;&quot;).trim() !== ySel) return false;
      if (mSel &amp;&amp; monthLower(r.luna) !== mSel) return false;
      return true;
    });
  }


  // ===== UI FILTERS (tabel) =====
  const MONTHS_RO = [&quot;ianuarie&quot;,&quot;februarie&quot;,&quot;martie&quot;,&quot;aprilie&quot;,&quot;mai&quot;,&quot;iunie&quot;,&quot;iulie&quot;,&quot;august&quot;,&quot;septembrie&quot;,&quot;octombrie&quot;,&quot;noiembrie&quot;,&quot;decembrie&quot;];

  function uniqYears(){
    const ys = new Set();
    rows.forEach(r =&gt; {
      const y = (r.an ?? &quot;&quot;).toString().trim();
      if (y) ys.add(y);
    });
    return Array.from(ys).sort((a,b)=&gt; Number(a)-Number(b));
  }
  function uniqMonthsForYear(y){
    const ms = new Set();
    rows.forEach(r =&gt; {
      if (String(r.an ?? &quot;&quot;).trim() !== String(y)) return;
      const m = monthLower(r.luna);
      if (m) ms.add(m);
    });
    const arr = Array.from(ms);
    // keep natural RO order when possible
    arr.sort((a,b)=&gt; (MONTHS_RO.indexOf(a) - MONTHS_RO.indexOf(b)));
    return arr;
  }
  function uniqMonthsAll(){
    const ms = new Set();
    rows.forEach(r =&gt; {
      const m = monthLower(r.luna);
      if (m) ms.add(m);
    });
    const arr = Array.from(ms);
    arr.sort((a,b)=&gt; (MONTHS_RO.indexOf(a) - MONTHS_RO.indexOf(b)));
    return arr;
  }

  function setSelectOptions(sel, options, firstLabel){
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = &quot;&quot;;
    const opt0 = document.createElement(&quot;option&quot;);
    opt0.value = &quot;&quot;;
    opt0.textContent = firstLabel;
    sel.appendChild(opt0);
    options.forEach(v =&gt; {
      const o = document.createElement(&quot;option&quot;);
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });
    // restore if possible
    if (options.includes(current)) sel.value = current;
    else sel.value = &quot;&quot;;
  }

  function refreshFilterUI(preserve=true){
    const ySel = $(&quot;fltYear&quot;);
    const mSel = $(&quot;fltMonth&quot;);
    const years = uniqYears();
    if (!ySel || !mSel) return;

    const prevY = ySel.value;
    setSelectOptions(ySel, years, &quot;(toți anii)&quot;);

    // restore year selection if desired
    if (preserve &amp;&amp; years.includes(prevY)) ySel.value = prevY;
    else ySel.value = &quot;&quot;;

    // months depend on year
    const months = ySel.value ? uniqMonthsForYear(ySel.value) : uniqMonthsAll();
    const prevM = mSel.value;
    setSelectOptions(mSel, months, &quot;(toate lunile)&quot;);
    if (preserve &amp;&amp; months.includes(monthLower(prevM))) mSel.value = monthLower(prevM);
    else mSel.value = &quot;&quot;;
  }

  function applyUIFilters(){
    // filter affects only table view (and the pills)
    renderBody();
  }

  function resetUIFilters(){
    if ($(&quot;fltYear&quot;)) $(&quot;fltYear&quot;).value = &quot;&quot;;
    refreshFilterUI(true);
    applyUIFilters();
  }

  // ===== SUMMARY (independent) =====
  function refreshSummaryUI(preserve=true){
    const ySel = $(&quot;sumYear&quot;);
    const mSel = $(&quot;sumMonth&quot;);
    if (!ySel || !mSel) return;
    const years = uniqYears();
    const prevY = ySel.value;
    setSelectOptions(ySel, years, &quot;(alege anul)&quot;);
    if (preserve &amp;&amp; years.includes(prevY)) ySel.value = prevY;
    else {
      // default: last year if any
      ySel.value = years.length ? years[years.length-1] : &quot;&quot;;
    }
    const months = ySel.value ? uniqMonthsForYear(ySel.value) : [];
    const prevM = mSel.value;
    setSelectOptions(mSel, months, &quot;(toate lunile)&quot;);
    if (preserve &amp;&amp; months.includes(monthLower(prevM))) mSel.value = monthLower(prevM);
    else mSel.value = &quot;&quot;;
  }

  function refreshSummaryTable(){
    const body = $(&quot;sumBody&quot;);
    const y = ($(&quot;sumYear&quot;)?.value || &quot;&quot;).trim();
    const m = monthLower(($(&quot;sumMonth&quot;)?.value || &quot;&quot;).trim());
    if (!body) return;

    if (!y){
      body.innerHTML = &#x27;&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;center&quot;&gt;Selectează Anul aici pentru a calcula sumarul.&lt;/td&gt;&lt;/tr&gt;&#x27;;
      return;
    }

    const bucket = new Map();
    for (const r of rows){
      if (String(r.an ?? &quot;&quot;).trim() !== y) continue;
      if (m &amp;&amp; monthLower(r.luna) !== m) continue;

      const reper = (r.reper ?? &quot;&quot;).toString().trim();
      const diam = (r.diametru ?? &quot;&quot;).toString().trim();
      const cal  = (r.calitate ?? &quot;&quot;).toString().trim();

      const key = `${reper}|||${diam}|||${cal}`;
      const prev = bucket.get(key) || {reper, diam, cal, buc:0, kg:0};
      const buc = Number.isFinite(Number(r.cantitate)) ? Number(r.cantitate) : parseNumberRO(r.cantitate);
      const kg  = Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : parseNumberRO(r.totalKg);
      prev.buc += Number.isFinite(buc) ? buc : 0;
      prev.kg  += Number.isFinite(kg) ? kg : 0;
      bucket.set(key, prev);
    }

    const arr = Array.from(bucket.values());
    arr.sort((a,b)=&gt; (b.kg - a.kg));

    if (!arr.length){
      body.innerHTML = &#x27;&lt;tr&gt;&lt;td colspan=&quot;5&quot; class=&quot;center&quot;&gt;Nu există date pentru anul/luna selectată.&lt;/td&gt;&lt;/tr&gt;&#x27;;
      return;
    }

    body.innerHTML = &quot;&quot;;
    for (const it of arr){
      const tr = document.createElement(&quot;tr&quot;);
      const td1 = document.createElement(&quot;td&quot;); td1.textContent = it.reper || &quot;(gol)&quot;;
      const td2 = document.createElement(&quot;td&quot;); td2.textContent = it.diam || &quot;(gol)&quot;;
      const td3 = document.createElement(&quot;td&quot;); td3.textContent = it.cal || &quot;(gol)&quot;;
      const td4 = document.createElement(&quot;td&quot;); td4.className = &quot;num&quot;; td4.textContent = fmtIntDots(it.buc);
      const td5 = document.createElement(&quot;td&quot;); td5.className = &quot;num&quot;; td5.textContent = fmtIntDots(it.kg);
      tr.append(td1,td2,td3,td4,td5);
      body.appendChild(tr);
    }
  }


  function renderBody(){
    const body = $(&quot;body&quot;);
    body.innerHTML = &quot;&quot;;

    // normalize and recalc
    rows.forEach(r =&gt; recalcRow(r));

    const view = getFilteredRows();

    pillRows.textContent = `${view.length} rânduri`;
    const total = view.reduce((s, r) =&gt; s + (Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : 0), 0);
    pillTotalKg.textContent = `${fmtIntDots(total)} kg total`;

    for (let idx=0; idx&lt;view.length; idx++){
      const r = view[idx];
      const tr = document.createElement(&quot;tr&quot;);

      for (const col of COLUMNS){
        const td = document.createElement(&quot;td&quot;);
        if (col.align === &quot;num&quot;) td.classList.add(&quot;num&quot;);
        if (col.align === &quot;center&quot;) td.classList.add(&quot;center&quot;);

        if (col.readonly){
          td.textContent = displayValue(r, col);
        } else {
          const inp = document.createElement(&quot;input&quot;);
          inp.className = &quot;cellinput&quot;;
          if (col.type === &quot;date&quot;){
            inp.value = fmtDateRO(r.data);
          } else {
            inp.value = displayEditValue(r, col);
          }

          inp.addEventListener(&quot;blur&quot;, () =&gt; {
            const newVal = inp.value;
            applyCellEdit(r, col, newVal);
            recalcRow(r);
            scheduleSave();
        setTimeout(() =&gt; renderBody(), 0);
          });

          inp.addEventListener(&quot;keydown&quot;, (e) =&gt; {
            if (e.key === &quot;Enter&quot;){
              e.preventDefault();
              inp.blur();
            }
          });

          td.appendChild(inp);
        }
        tr.appendChild(td);
      }

      // actions
      const tdA = document.createElement(&quot;td&quot;);
      tdA.className = &quot;center actCell&quot;;
      const wrap = document.createElement(&quot;div&quot;);
      wrap.className = &quot;rowActions&quot;;

      const bDel = document.createElement(&quot;button&quot;);
      bDel.className = &quot;iconbtn danger&quot;;
      bDel.textContent = &quot;🗑&quot;;
      bDel.title = &quot;Șterge&quot;;
      bDel.addEventListener(&quot;click&quot;, () =&gt; {
        if (!confirm(&quot;Ștergi rândul selectat?&quot;)) return;
        const realIdx = rows.findIndex(x =&gt; x.id === r.id);
        if (realIdx &gt;= 0) rows.splice(realIdx, 1);
        scheduleSave();
        setTimeout(() =&gt; renderBody(), 0);
      });

      wrap.appendChild(bDel);
      tdA.appendChild(wrap);
      tr.appendChild(tdA);

      body.appendChild(tr);
    }

    // auto-scroll: la deschidere și după adăugare/import mergem jos
    if (autoScrollBottom){
      const tw = $(&quot;tablewrap&quot;);
      if (tw){ tw.scrollTop = tw.scrollHeight; tw.scrollLeft = tw.scrollWidth; }
      autoScrollBottom = false;
    }
  }

  function displayValue(r, col){
    const v = r[col.key];
    if (col.type === &quot;date&quot;) return fmtDateRO(r.data);
    if (col.type === &quot;diam&quot;){
      const d = normalizeDiam(v);
      return d ? &quot;Ø &quot; + d : &quot;&quot;;
    }
    if (col.type === &quot;year&quot;){
      const n = Number(v);
      return Number.isFinite(n) ? String(Math.trunc(n)) : (v ?? &quot;&quot;);
    }
    if (col.type === &quot;int&quot;){
      const n = Number(v);
      return Number.isFinite(n) ? fmtIntDots(n) : (v ?? &quot;&quot;);
    }
    if (col.type === &quot;dec2&quot;){
      const n = Number(v);
      return Number.isFinite(n) ? fmtDecComma(n, 2) : (v ?? &quot;&quot;);
    }
    if (col.type === &quot;dec1&quot;){
      const n = Number(v);
      return Number.isFinite(n) ? fmtDecComma(n, 1) : (v ?? &quot;&quot;);
    }
    if (col.type === &quot;pct&quot;){
      const n = Number(v);
      return Number.isFinite(n) ? (String(Math.round(n)) + &quot;%&quot;) : (v ?? &quot;&quot;);
    }
    return (v ?? &quot;&quot;).toString();
  }

  function displayEditValue(r, col){
    // Pentru coloane numerice editabile, afișăm formatat (mii cu .), dar salvăm numeric.
    if (col.type === &quot;year&quot;){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? String(Math.trunc(n)) : (r[col.key] ?? &quot;&quot;);
    }
    if (col.type === &quot;int&quot;){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtIntDots(n) : (r[col.key] ?? &quot;&quot;);
    }
    if (col.type === &quot;dec2&quot;){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtDecComma(n, 2) : (r[col.key] ?? &quot;&quot;);
    }
    if (col.type === &quot;dec1&quot;){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtDecComma(n, 1) : (r[col.key] ?? &quot;&quot;);
    }
    if (col.type === &quot;diam&quot;){
      const d = normalizeDiam(r[col.key]);
      return d ? &quot;Ø &quot; + d : &quot;&quot;;
    }
    return (r[col.key] ?? &quot;&quot;).toString();
  }

  function applyCellEdit(r, col, raw){
    if (col.type === &quot;date&quot;){
      r.data = parseDateAny(raw);
      // also update an/luna if missing
      if (r.data){
        const [y,m] = r.data.split(&quot;-&quot;);
        if (!r.an) r.an = Number(y);
        if (!r.luna) r.luna = LUNI[Number(m)-1] || &quot;&quot;;
      }
      return;
    }
    if (col.type === &quot;diam&quot;){
      r.diametru = normalizeDiam(raw);
      return;
    }
    if (col.type === &quot;year&quot;){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? Math.trunc(n) : &quot;&quot;;
      return;
    }
    if (col.type === &quot;int&quot;){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? Math.trunc(n) : &quot;&quot;;
      return;
    }
    if (col.type === &quot;dec2&quot;){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? n : &quot;&quot;;
      return;
    }
    if (col.type === &quot;dec1&quot;){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? n : &quot;&quot;;
      return;
    }
    // text
    r[col.key] = (raw ?? &quot;&quot;).toString().trim();
    if (col.key === &quot;luna&quot;) r.luna = monthLower(r.luna);
  }

  // ===== CRUD =====
  // ===== ADD (modal) =====
  let autoScrollBottom = true;

  function openAddModal(){
    // defaults
    const d = new Date();
    const iso = toISODate(d);
    $(&quot;mData&quot;).value = iso;
    $(&quot;mAn&quot;).value = String(d.getFullYear());
    $(&quot;mLuna&quot;).value = LUNI[d.getMonth()];
    $(&quot;mEchip&quot;).value = &quot;&quot;;
    $(&quot;mOverride&quot;).checked = false;
    setAutofillReadonly(true);
    buildHelperMaps();
    $(&quot;mReper&quot;).value = &quot;&quot;;
    $(&quot;mDiam&quot;).value = &quot;&quot;;
    $(&quot;mCal&quot;).value = &quot;&quot;;
    $(&quot;mKgBuc&quot;).value = &quot;&quot;;
    $(&quot;mLungime&quot;).value = &quot;&quot;;
    $(&quot;mSarja&quot;).value = &quot;&quot;;
    $(&quot;mPlan&quot;).value = &quot;&quot;;
    $(&quot;mCant&quot;).value = &quot;&quot;;
    $(&quot;mSchimb&quot;).value = &quot;1&quot;;
    $(&quot;mOper&quot;).value = &quot;&quot;;
    $(&quot;mOre&quot;).value = &quot;8,0&quot;;
    $(&quot;mErr&quot;).textContent = &quot;&quot;;
    $(&quot;modalBack&quot;).classList.remove(&quot;hidden&quot;);
    setTimeout(()=&gt;$(&quot;mEchip&quot;).focus(), 0);
  }

  function closeAddModal(){
    $(&quot;modalBack&quot;).classList.add(&quot;hidden&quot;);
  }

  function syncAnLunaFromDate(){
    const iso = parseDateAny($(&quot;mData&quot;).value);
    if (!iso) return;
    const y = iso.slice(0,4);
    const m = Number(iso.slice(5,7));
    $(&quot;mAn&quot;).value = y;
    $(&quot;mLuna&quot;).value = LUNI[m-1] || &quot;&quot;;
  }

  function saveAddModal(){
    const err = [];
    const dataIso = parseDateAny($(&quot;mData&quot;).value);
    if (!dataIso) err.push(&quot;Data este obligatorie.&quot;);
    const echip = $(&quot;mEchip&quot;).value.trim();
    // dacă e selectat reper din helper, completează automat înainte de validare
    applyReperAutofill();
    const reper = $(&quot;mReper&quot;).value.trim();
    const diam = normalizeDiam($(&quot;mDiam&quot;).value);
    const cal = $(&quot;mCal&quot;).value.trim();
    const kgBuc = parseNumberRO($(&quot;mKgBuc&quot;).value);
    const lung = parseNumberRO($(&quot;mLungime&quot;).value);
    const sarja = $(&quot;mSarja&quot;).value.trim();
    const plan = parseNumberRO($(&quot;mPlan&quot;).value);
    const cant = parseNumberRO($(&quot;mCant&quot;).value);
    const schimb = parseNumberRO($(&quot;mSchimb&quot;).value);
    const oper = $(&quot;mOper&quot;).value.trim();
    const ore = parseNumberRO($(&quot;mOre&quot;).value);

    if (!echip) err.push(&quot;Echipament este obligatoriu.&quot;);
    if (!reper) err.push(&quot;Reper este obligatoriu.&quot;);
    if (!diam) err.push(&quot;Diametru este obligatoriu.&quot;);
    if (!cal) err.push(&quot;Calitate este obligatorie.&quot;);
    if (!Number.isFinite(kgBuc)) err.push(&quot;Kg/buc este obligatoriu.&quot;);
    if (!Number.isFinite(lung)) err.push(&quot;Lungime debitat este obligatorie.&quot;);
    if (!sarja) err.push(&quot;Sarja este obligatorie.&quot;);
    if (!Number.isFinite(cant)) err.push(&quot;Cantitate este obligatorie.&quot;);
    if (!Number.isFinite(schimb)) err.push(&quot;Schimbul este obligatoriu.&quot;);
    if (!oper) err.push(&quot;Operator este obligatoriu.&quot;);

    if (err.length){
      $(&quot;mErr&quot;).textContent = err.join(&quot; &quot;);
      return;
    }

    const y = Number(dataIso.slice(0,4));
    const m = Number(dataIso.slice(5,7));

    const r = {
      id: crypto?.randomUUID ? crypto.randomUUID() : (&quot;id_&quot;+Math.random().toString(16).slice(2)),
      an: y,
      luna: LUNI[m-1] || &quot;&quot;,
      data: dataIso,
      echipament: echip,
      reper: reper,
      diametru: diam,
      calitate: cal,
      kgBuc: Number.isFinite(kgBuc) ? kgBuc : &quot;&quot;,
      lungime: Number.isFinite(lung) ? Math.trunc(lung) : &quot;&quot;,
      sarja: sarja,
      planificat: Number.isFinite(plan) ? Math.trunc(plan) : &quot;&quot;,
      cantitate: Math.trunc(cant),
      schimbul: Math.trunc(schimb),
      totalKg: &quot;&quot;,
      weekNr: isoWeekNumber(dataIso),
      operator: oper,
      procentNorma: &quot;&quot;,
      oreLucrate: Number.isFinite(ore) ? ore : 8.0
    };

    recalcRow(r);
    rows.push(r);

    // Keep insertion order; always append at the bottom
    autoScrollBottom = true;
    scheduleSave();
    setTimeout(() =&gt; renderBody(), 0);
    closeAddModal();
  }

  // ===== XLSX =====
  async function ensureXLSX(){
    if (window.XLSX) return true;

    // try load local first, relative to parent file
    const localUrl = new URL(&quot;xlsx.full.min.js&quot;, (parent.location.href.split(&quot;#&quot;)[0].split(&quot;?&quot;)[0])).href;

    try{
      await loadScript(localUrl);
      if (window.XLSX) return true;
    } catch(e){}

    // fallback CDN
    try{
      await loadScript(&quot;https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js&quot;);
      return !!window.XLSX;
    } catch(e){
      alert(&quot;Nu pot încărca librăria XLSX. Pune fișierul xlsx.full.min.js lângă HTML (offline) sau pornește internet.&quot;);
      return false;
    }
  }

  function loadScript(src){
    return new Promise((resolve,reject)=&gt;{
      const s = document.createElement(&quot;script&quot;);
      s.src = src;
      s.onload = () =&gt; resolve();
      s.onerror = () =&gt; reject(new Error(&quot;Failed &quot; + src));
      document.head.appendChild(s);
    });
  }

  function exportXLSX(){
    ensureXLSX().then(ok=&gt;{
      if (!ok) return;

      // export all rows (not filtered)
      const data = rows.map(r =&gt; ({
        &quot;Anul&quot;: r.an,
        &quot;Luna&quot;: r.luna,
        &quot;Data&quot;: fmtDateRO(r.data),
        &quot;Echipament&quot;: r.echipament,
        &quot;Reper&quot;: r.reper,
        &quot;Diametru oțel&quot;: normalizeDiam(r.diametru) ? (&quot;Ø &quot; + normalizeDiam(r.diametru)) : &quot;&quot;,
        &quot;CALITATE&quot;: r.calitate,
        &quot;Kg/buc.&quot;: Number.isFinite(Number(r.kgBuc)) ? Number(r.kgBuc) : &quot;&quot;,
        &quot;Lungime debitat mm&quot;: Number.isFinite(Number(r.lungime)) ? Number(r.lungime) : &quot;&quot;,
        &quot;Sarja&quot;: r.sarja,
        &quot;Planificat&quot;: Number.isFinite(Number(r.planificat)) ? Number(r.planificat) : &quot;&quot;,
        &quot;Cantitate&quot;: Number.isFinite(Number(r.cantitate)) ? Number(r.cantitate) : &quot;&quot;,
        &quot;Schimbul&quot;: Number.isFinite(Number(r.schimbul)) ? Number(r.schimbul) : &quot;&quot;,
        &quot;total kg debitat&quot;: Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : &quot;&quot;,
        &quot;week nr.&quot;: Number.isFinite(Number(r.weekNr)) ? Number(r.weekNr) : &quot;&quot;,
        &quot;Operator&quot;: r.operator,
        &quot;Procent norma %&quot;: Number.isFinite(Number(r.procentNorma)) ? Number(r.procentNorma) : &quot;&quot;,
        &quot;Ore lucrate&quot;: Number.isFinite(Number(r.oreLucrate)) ? Number(r.oreLucrate) : &quot;&quot;
      }));

      const ws = XLSX.utils.json_to_sheet(data, { skipHeader:false });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, &quot;DEBITATE&quot;);
      const name = `DEBITATE_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, name);
    });
  }

  function importXLSX(){
    ensureXLSX().then(ok=&gt;{
      if (!ok) return;

      const inp = document.createElement(&quot;input&quot;);
      inp.type = &quot;file&quot;;
      inp.accept = &quot;.xlsx,.xls&quot;;
      inp.addEventListener(&quot;change&quot;, async () =&gt; {
        const file = inp.files &amp;&amp; inp.files[0];
        if (!file) return;
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type:&quot;array&quot; });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(ws, { defval:&quot;&quot; });

        // map headers flexibly
        const mapped = raw.map(obj =&gt; mapRowFromExcel(obj)).filter(Boolean);
        if (!mapped.length){
          alert(&quot;Nu am găsit rânduri importabile.&quot;);
          return;
        }

        // merge: append
        rows = mapped.concat(rows);
        // recalc + sort by date desc
        rows.forEach(r =&gt; recalcRow(r));
        rows.sort((a,b)=&gt; (a.data||&quot;&quot;).localeCompare(b.data||&quot;&quot;));
        autoScrollBottom = true;
        scheduleSave();
        setTimeout(() =&gt; renderBody(), 0);
      });
      inp.click();
    });
  }

  function getAny(obj, keys){
    for (const k of keys){
      if (k in obj) return obj[k];
      // case-insensitive match
      const found = Object.keys(obj).find(h =&gt; stripDia(h).toLowerCase() === stripDia(k).toLowerCase());
      if (found) return obj[found];
    }
    return &quot;&quot;;
  }

  function mapRowFromExcel(obj){
    // headers variants
    const an = parseNumberRO(getAny(obj, [&quot;Anul&quot;,&quot;An&quot;,&quot;An intrare&quot;])) ;
    const luna = monthLower(getAny(obj, [&quot;Luna&quot;,&quot;LUNA&quot;,&quot;Luna intrare&quot;]));
    const dataIso = parseDateAny(getAny(obj, [&quot;Data&quot;,&quot;Data Intrare&quot;,&quot;Data intrare&quot;]));
    const ech = getAny(obj, [&quot;Echipament&quot;,&quot;Echipament (utilajul de debitare)&quot;,&quot;Utilaj&quot;]);
    const reper = getAny(obj, [&quot;Reper&quot;,&quot;Denumire reper debitare&quot;]);
    const diam = normalizeDiam(getAny(obj, [&quot;Diametru oțel&quot;,&quot;Diametru otel&quot;,&quot;Diametrul oțelului&quot;,&quot;Diametru oțelului&quot;]));
    const cal = getAny(obj, [&quot;CALITATE&quot;,&quot;Calitate&quot;,&quot;Calitatea oțelului&quot;]);
    const kgBuc = parseNumberRO(getAny(obj, [&quot;Kg/buc.&quot;,&quot;Kg/buc&quot;,&quot;Kg/buc.&quot;,&quot;Kg/bucă&quot;,&quot;Kg/buc (kg/buc)&quot;]));
    const lungime = parseNumberRO(getAny(obj, [&quot;Lungime debitat mm&quot;,&quot;Lungime debitat&quot;,&quot;Lungime debitat (mm)&quot;]));
    const sarja = getAny(obj, [&quot;Sarja&quot;,&quot;Sarjă&quot;,&quot;Sarja material&quot;,&quot;Sarja materialului&quot;]);
    const planificat = parseNumberRO(getAny(obj, [&quot;Planificat&quot;,&quot;Planificat (buc)&quot;]));
    const cant = parseNumberRO(getAny(obj, [&quot;Cantitate&quot;,&quot;Cantitate (buc)&quot;,&quot;Cantitate buc&quot;]));
    const schimb = parseNumberRO(getAny(obj, [&quot;Schimbul&quot;,&quot;Schimb&quot;]));
    const operator = getAny(obj, [&quot;Operator&quot;]);
    const ore = parseNumberRO(getAny(obj, [&quot;Ore lucrate&quot;,&quot;Ore&quot;]));
    // allow total kg / week / procent but we recalc anyway
    const r = {
      id: crypto?.randomUUID ? crypto.randomUUID() : (&quot;id_&quot;+Math.random().toString(16).slice(2)),
      an: Number.isFinite(an) ? Math.trunc(an) : (dataIso ? Number(dataIso.slice(0,4)) : &quot;&quot;),
      luna: luna || (dataIso ? LUNI[Number(dataIso.slice(5,7))-1] : &quot;&quot;),
      data: dataIso,
      echipament: (ech ?? &quot;&quot;).toString().trim(),
      reper: (reper ?? &quot;&quot;).toString().trim(),
      diametru: diam,
      calitate: (cal ?? &quot;&quot;).toString().trim(),
      kgBuc: Number.isFinite(kgBuc) ? kgBuc : &quot;&quot;,
      lungime: Number.isFinite(lungime) ? Math.trunc(lungime) : &quot;&quot;,
      sarja: (sarja ?? &quot;&quot;).toString().trim(),
      planificat: Number.isFinite(planificat) ? Math.trunc(planificat) : &quot;&quot;,
      cantitate: Number.isFinite(cant) ? Math.trunc(cant) : &quot;&quot;,
      schimbul: Number.isFinite(schimb) ? Math.trunc(schimb) : &quot;&quot;,
      totalKg: &quot;&quot;,
      weekNr: &quot;&quot;,
      operator: (operator ?? &quot;&quot;).toString().trim(),
      procentNorma: &quot;&quot;,
      oreLucrate: Number.isFinite(ore) ? ore : 8.0
    };
    recalcRow(r);
    // require minimal fields
    if (!r.data &amp;&amp; !r.an) return null;
    return r;
  }

  // ===== INIT =====
  function render(){
    buildHeader();
    refreshFilterUI(true);
    refreshSummaryUI(true);
    renderBody();
    refreshSummaryTable();
  }

  (function init(){
    load();
    // UI: filtre + sumar
    const _fy = $(&quot;fltYear&quot;);
    const _fm = $(&quot;fltMonth&quot;);
    if (_fy) _fy.addEventListener(&quot;change&quot;, () =&gt; { refreshFilterUI(true); applyUIFilters(); });
    if (_fm) _fm.addEventListener(&quot;change&quot;, () =&gt; { applyUIFilters(); });

    const _sy = $(&quot;sumYear&quot;);
    const _sm = $(&quot;sumMonth&quot;);
    if (_sy) _sy.addEventListener(&quot;change&quot;, () =&gt; { refreshSummaryUI(true); refreshSummaryTable(); });
    if (_sm) _sm.addEventListener(&quot;change&quot;, () =&gt; { refreshSummaryTable(); });

    // inițializează helperele (repere/utilaje) pentru autocomplete + autofill
    buildHelperMaps();
    const _mr = $(&quot;mReper&quot;); if (_mr) _mr.addEventListener(&quot;input&quot;, applyReperAutofill);
    const _ov = $(&quot;mOverride&quot;); if (_ov) _ov.addEventListener(&quot;change&quot;, () =&gt; { setAutofillReadonly(!_ov.checked); if(!_ov.checked) applyReperAutofill(); });

    // normalize months
    rows.forEach(r =&gt; {
      r.luna = monthLower(r.luna);
      r.diametru = normalizeDiam(r.diametru);
      r.data = parseDateAny(r.data);
      // fix year like &quot;2.026&quot; -&gt; 2026
      const _y = parseNumberRO(r.an);
      if (Number.isFinite(_y)) r.an = Math.trunc(_y);
      recalcRow(r);
    });
    rows.sort((a,b)=&gt; (a.data||&quot;&quot;).localeCompare(b.data||&quot;&quot;));
    autoScrollBottom = true;
    render();
    // resave normalized
    if (rows.length) scheduleSave();
  })();
&lt;/script&gt;

  &lt;datalist id=&quot;dlRepereDebitare&quot;&gt;&lt;/datalist&gt;
  &lt;datalist id=&quot;dlUtilajeDebitare&quot;&gt;&lt;/datalist&gt;

&lt;/body&gt;
&lt;/html&gt;
"></iframe>
</div>
<script>
    const APP_KEYS = {
      helpers: "RF_HELPERS_v1",
      numeralkod: "NUMERALKOD_autosave_v1",
      intrari: "INTRARI_OTEL_autosave_v3",
      debitate: "DEBITATE_autosave_v1"
    };

    function setActive(key){
      const map = {
        dashboard: ['pageDashboard','btnDashboard'],
        helper: ['pageHelper','btnHelper'],
        numeralkod: ['pageNumeralkod','btnNumeralkod'],
        intrari: ['pageIntrari','btnIntrari'],
        debitate: ['pageDebitate','btnDebitate']
      };
      Object.values(map).forEach(([pid,bid])=>{
        document.getElementById(pid).classList.remove('show');
        document.getElementById(bid).classList.remove('active');
      });
      const pair = map[key] || map.dashboard;
      document.getElementById(pair[0]).classList.add('show');
      document.getElementById(pair[1]).classList.add('active');
    }

    function showPage(key){
      location.hash = key;
      setActive(key);

      // notifică iframe-ul activ (pentru recalcul înălțimi / randări după ce devine vizibil)
      const frameId = (key === 'helper') ? 'pageHelper'
                    : (key === 'numeralkod') ? 'pageNumeralkod'
                    : (key === 'intrari') ? 'pageIntrari'
                    : (key === 'debitate') ? 'pageDebitate'
                    : 'pageDashboard';
      const f = document.getElementById(frameId);
      try{
        if (f && f.contentWindow) f.contentWindow.postMessage({type:'PAGE_SHOWN', key}, '*');
      }catch(e){}
    }

    // expose for iframes
    window.showPage = showPage;

    function reloadIframe(id){
      const f = document.getElementById(id);
      if (!f) return;
      try{
        // forțează reload la srcdoc în Chrome
        const s = f.getAttribute('srcdoc');
        if (s != null) f.setAttribute('srcdoc', s);
        else f.contentWindow.location.reload();
      } catch(e){
        // fallback
        try { f.srcdoc = f.srcdoc; } catch(_e){}
      }
    }

    function reloadAllPages(){
      const key = (location.hash || '#dashboard').replace('#','');
      ['pageDashboard','pageNumeralkod','pageIntrari','pageDebitate'].forEach(reloadIframe);
      // reselect după un tick (iframes se reîncarcă)
      setTimeout(()=>setActive(key), 120);
    }

    function getJsonFromLS(key){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch(e){
        return null;
      }
    }

    function downloadText(filename, mime, text){
      const blob = new Blob([text], { type: mime });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 250);
    }

    function exportAllData(){
      const payload = {
        app: "Raport Forja ALL_IN_ONE",
        exportedAt: new Date().toISOString(),
        keys: APP_KEYS,
        data: {
          helpers: getJsonFromLS(APP_KEYS.helpers),
          numeralkod: getJsonFromLS(APP_KEYS.numeralkod),
          intrari: getJsonFromLS(APP_KEYS.intrari),
          debitate: getJsonFromLS(APP_KEYS.debitate)
        }
      };
      const fname = "Raport_Forja_BACKUP_" + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + ".json";
      downloadText(fname, "application/json;charset=utf-8", JSON.stringify(payload, null, 2));
    }

    function triggerImportAll(){
      const inp = document.getElementById('importAllInput');
      if (!inp) return alert("Lipsește importAllInput.");
      inp.click();
    }

    async function importAllDataFile(file){
      if (!file) return;
      let payload;
      try{
        const txt = await file.text();
        payload = JSON.parse(txt);
      } catch(e){
        alert("Fișier invalid (nu e JSON).");
        return;
      }
      if (!payload || typeof payload !== "object" || !payload.data){
        alert("Fișier invalid (lipsește payload.data).");
        return;
      }

      const ok = confirm("Restore total: vei suprascrie datele salvate în acest browser. Continui?");
      if (!ok) return;

      const d = payload.data;
      try{
        if (d.helpers != null) localStorage.setItem(APP_KEYS.helpers, JSON.stringify(d.helpers)); else localStorage.removeItem(APP_KEYS.helpers);
        if (d.numeralkod != null) localStorage.setItem(APP_KEYS.numeralkod, JSON.stringify(d.numeralkod)); else localStorage.removeItem(APP_KEYS.numeralkod);
        if (d.intrari != null) localStorage.setItem(APP_KEYS.intrari, JSON.stringify(d.intrari)); else localStorage.removeItem(APP_KEYS.intrari);
        if (d.debitate != null) localStorage.setItem(APP_KEYS.debitate, JSON.stringify(d.debitate)); else localStorage.removeItem(APP_KEYS.debitate);
      } catch(e){
        console.error(e);
        alert("Nu pot scrie în localStorage (posibil blocat).");
        return;
      }

      reloadAllPages();
      alert("Restore complet. Dacă erai într-o pagină, se va reîncărca automat.");
    }

    function resetAllData(){
      const ok = confirm("Reset total: șterg toate datele locale (helpere + numeralkod + intrări + debitate). Continui?");
      if (!ok) return;
      try{
        Object.values(APP_KEYS).forEach(k => localStorage.removeItem(k));
      } catch(e){}
      reloadAllPages();
    }

    function wireImportOnce(){
      if (window.__importAllWired) return;
      const inp = document.getElementById('importAllInput');
      if (!inp) return;
      inp.addEventListener('change', async (ev)=>{
        const f = ev.target.files && ev.target.files[0];
        // reset input ca să poți re-importa același fișier
        ev.target.value = "";
        await importAllDataFile(f);
      });
      window.__importAllWired = true;
    }

    function init(){
      const key = (location.hash || '#dashboard').replace('#','');
      setActive(key);
      wireImportOnce();
    }

    window.addEventListener('hashchange', init);
    init();
  </script>

<div class="authGate" id="authGate">
  <div class="authCard">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div>
        <h2 class="authTitle">Autentificare</h2>
        <p class="authHint">Intră cu contul Supabase. <b>Editor</b> poate modifica; <b>Viewer</b> are doar vizualizare (export permis). (Login cerut de fiecare dată când deschizi site-ul.)</p>
      </div>
      <div id="roleBadge" style="display:none" class="rolePill"><span class="roleDot" id="roleDot"></span><span id="roleText"></span></div>
    </div>

    <div class="authRow">
      <div>
        <div class="authLabel">Email</div>
        <input class="authInput" id="authEmail" type="email" autocomplete="username" placeholder="ex: forja.editor@gmail.com" />
      </div>
      <div>
        <div class="authLabel">Parolă</div>
        <input class="authInput" id="authPass" type="password" autocomplete="current-password" placeholder="••••••••" />
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:4px;">
        <button class="authBtn" id="authLoginBtn">Intră</button>
        <button class="authBtn" id="authLogoutBtn" style="display:none;background:rgba(255,255,255,.06)">Logout</button>
      </div>
    </div>

    <div class="authErr" id="authErr"></div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
(function(){
  const SUPABASE_URL = 'https://rhjcnydkdhjzazygybcc.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_c9bVU5wkXwzzXTJVeWWygg_tOA9WnPK';

  const gate = document.getElementById('authGate');
  const emailEl = document.getElementById('authEmail');
  const passEl  = document.getElementById('authPass');
  const btnIn   = document.getElementById('authLoginBtn');
  const btnOut  = document.getElementById('authLogoutBtn');
  const errEl   = document.getElementById('authErr');

  const badge = document.getElementById('roleBadge');
  const roleText = document.getElementById('roleText');
  const roleDot  = document.getElementById('roleDot');

  function showErr(msg){ errEl.textContent = msg || ''; }
  function setBusy(b){ btnIn.disabled = b; if(b) showErr(''); }

  const supa = (window.supabase && window.supabase.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } })
    : null;

  if(!supa){
    showErr('Nu pot încărca supabase-js (CDN blocat). Încearcă refresh.');
    return;
  }

  async function loadRole(user){
    try {
      const { data, error } = await supa.from('profiles').select('role').eq('id', user.id).maybeSingle();
      if(error) throw error;
      return (data && data.role) ? data.role : 'viewer';
    } catch(e){
      console.warn('Role lookup failed:', e);
      return 'viewer';
    }
  }

  function applyRole(role){
    badge.style.display = 'inline-flex';
    roleText.textContent = role.toUpperCase() + (role==='viewer' ? ' (read-only)' : '');
    roleDot.classList.toggle('viewer', role==='viewer');
    window.__APP_ROLE__ = role;
  }

    async function applySession(session){
    if(session && session.user){
      const role = await loadRole(session.user);
      applyRole(role);
      gate.style.display = 'none';
      btnOut.style.display = 'inline-block';
      window.__AUTH_OK__ = true;
      return;
    }
    window.__AUTH_OK__ = false;
    gate.style.display = 'flex';
    badge.style.display = 'none';
    btnOut.style.display = 'none';
  }

  async function refreshSession(){
    try{
      const { data, error } = await supa.auth.getSession();
      if(error) throw error;
      await applySession(data ? data.session : null);
    }catch(e){
      console.warn('Session check failed:', e);
      await applySession(null);
    }
  }

gate.style.display='flex';
    badge.style.display='none';
    btnOut.style.display='none';
  }

  btnIn.addEventListener('click', async ()=>{
    setBusy(true);
    try {
      const email = (emailEl.value||'').trim();
      const password = passEl.value || '';
      if(!email || !password){ showErr('Completează email + parola.'); setBusy(false); return; }
      const { data, error } = await supa.auth.signInWithPassword({ email, password });
      if(error) throw error;
      const role = await loadRole(data.user);
      applyRole(role);
      gate.style.display = 'none';
      window.__AUTH_OK__ = true;
    } catch(e){
      console.error(e);
      showErr(e && e.message ? e.message : 'Login eșuat.');
    } finally {
      setBusy(false);
    }
  });

  btnOut.addEventListener('click', async ()=>{
    await supa.auth.signOut();
    location.reload();
  });

  refreshSession();
  supa.auth.onAuthStateChange(async (_event, session)=>{ await applySession(session); });
})();
</script>

</body>
</html>
